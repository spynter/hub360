{"ast":null,"code":"var _jsxFileName = \"D:\\\\respaldo jose\\\\PROJECTS_V0\\\\hub360\\\\frontend\\\\src\\\\components\\\\Editor\\\\TourEditor.js\",\n  _s = $RefreshSig$();\nimport React, { useRef, useEffect, useState, useCallback } from 'react';\nimport * as THREE from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';\nimport HotspotEditor from './HotspotEditor';\nimport api from '../../services/api';\nimport DragDrop from './DragDrop';\nimport { useNavigate } from 'react-router-dom';\nimport './TourEditor.css';\nimport ApiKeyManager from './ApiKeyManager';\nimport HotspotCreationModal from './HotspotCreationModal';\nimport RadialFadeMaterial from '../shaders/RadialFadeMaterial';\n\n// Utilidad para obtener la URL absoluta de la imagen\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nfunction getAbsoluteImageUrl(image) {\n  if (!image) return '';\n  if (image.startsWith('/uploads/')) {\n    var _process$env$REACT_AP;\n    return `${((_process$env$REACT_AP = process.env.REACT_APP_API_URL) === null || _process$env$REACT_AP === void 0 ? void 0 : _process$env$REACT_AP.replace('/api', '')) || 'http://localhost:5000'}${image}`;\n  }\n  return image;\n}\n\n// Hotspot mejorado con efectos visuales similares a Kuula\nfunction createHotspotSprite(hotspot, onClick) {\n  const size = 80;\n  const canvas = document.createElement('canvas');\n  canvas.width = size;\n  canvas.height = size;\n  const ctx = canvas.getContext('2d');\n\n  // Fondo con gradiente\n  const gradient = ctx.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);\n  gradient.addColorStop(0, 'rgba(56, 189, 248, 0.9)');\n  gradient.addColorStop(0.7, 'rgba(14, 165, 233, 0.7)');\n  gradient.addColorStop(1, 'rgba(14, 165, 233, 0.3)');\n  ctx.beginPath();\n  ctx.arc(size / 2, size / 2, size / 2 - 6, 0, 2 * Math.PI);\n  ctx.fillStyle = gradient;\n  ctx.shadowColor = '#0ea5e9';\n  ctx.shadowBlur = 12;\n  ctx.fill();\n\n  // Borde exterior\n  ctx.lineWidth = 3;\n  ctx.strokeStyle = '#ffffff';\n  ctx.stroke();\n\n  // Borde interior\n  ctx.beginPath();\n  ctx.arc(size / 2, size / 2, size / 2 - 12, 0, 2 * Math.PI);\n  ctx.lineWidth = 2;\n  ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';\n  ctx.stroke();\n\n  // Icono según el tipo\n  if (hotspot.type === 'access') {\n    // Flecha de navegación\n    ctx.beginPath();\n    ctx.moveTo(size / 2, size / 2 - 15);\n    ctx.lineTo(size / 2 + 12, size / 2 + 5);\n    ctx.lineTo(size / 2 - 12, size / 2 + 5);\n    ctx.closePath();\n    ctx.fillStyle = '#ffffff';\n    ctx.fill();\n\n    // Punto central\n    ctx.beginPath();\n    ctx.arc(size / 2, size / 2 + 8, 3, 0, 2 * Math.PI);\n    ctx.fillStyle = '#ffffff';\n    ctx.fill();\n  }\n  const texture = new THREE.CanvasTexture(canvas);\n  const material = new THREE.SpriteMaterial({\n    map: texture,\n    depthTest: false,\n    transparent: true,\n    opacity: 0.9\n  });\n  const sprite = new THREE.Sprite(material);\n  sprite.scale.set(25, 25, 1);\n  sprite.userData.hotspot = hotspot;\n  if (onClick) sprite.userData.onClick = onClick;\n  return sprite;\n}\nfunction isMobileDevice() {\n  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);\n}\nfunction TourEditor({\n  tourId\n}) {\n  _s();\n  var _tour$scenes$currentS, _tour$scenes$currentS2;\n  const containerRef = useRef();\n  const [tour, setTour] = useState(null);\n  const [currentSceneIndex, setCurrentSceneIndex] = useState(0);\n  const [selectedHotspot, setSelectedHotspot] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [panelOpen, setPanelOpen] = useState(true);\n  const [pendingHotspot, setPendingHotspot] = useState(null);\n  const [placementMode, setPlacementMode] = useState(false);\n  const [newHotspotPosition, setNewHotspotPosition] = useState(null);\n  const [showHotspotModal, setShowHotspotModal] = useState(false);\n  const navigate = useNavigate();\n  const [fade, setFade] = useState(false);\n  const [pendingSceneIndex, setPendingSceneIndex] = useState(null);\n  const [transitioning, setTransitioning] = useState(false);\n  const [transitionProgress, setTransitionProgress] = useState(0);\n  const [prevTexture, setPrevTexture] = useState(null);\n  const [isMobile, setIsMobile] = useState(false);\n  const [autoRotate, setAutoRotate] = useState(false);\n  const [fullscreen, setFullscreen] = useState(false);\n  const [showSceneSelector, setShowSceneSelector] = useState(false);\n\n  // Referencias de Three.js\n  const sceneRef = useRef();\n  const cameraRef = useRef();\n  const rendererRef = useRef();\n  const controlsRef = useRef();\n  const hotspotSpritesRef = useRef([]);\n  const accessSpheresRef = useRef([]);\n  const animationRef = useRef();\n  useEffect(() => {\n    setIsMobile(isMobileDevice());\n  }, []);\n\n  // Navegación con teclado\n  const handleKeyDown = useCallback(event => {\n    if (!tour || !tour.scenes) return;\n    switch (event.key) {\n      case 'ArrowLeft':\n        event.preventDefault();\n        navigateToScene(currentSceneIndex - 1);\n        break;\n      case 'ArrowRight':\n        event.preventDefault();\n        navigateToScene(currentSceneIndex + 1);\n        break;\n      case ' ':\n        event.preventDefault();\n        setAutoRotate(!autoRotate);\n        break;\n      case 'f':\n        event.preventDefault();\n        toggleFullscreen();\n        break;\n      case 'Escape':\n        if (fullscreen) {\n          toggleFullscreen();\n        }\n        break;\n    }\n  }, [tour, currentSceneIndex, autoRotate, fullscreen]);\n  useEffect(() => {\n    document.addEventListener('keydown', handleKeyDown);\n    return () => document.removeEventListener('keydown', handleKeyDown);\n  }, [handleKeyDown]);\n\n  // Navegación entre escenas\n  const navigateToScene = useCallback(index => {\n    if (!tour || !tour.scenes || index < 0 || index >= tour.scenes.length) return;\n    if (transitioning) return;\n    startTransition(index);\n  }, [tour, transitioning]);\n\n  // Toggle fullscreen\n  const toggleFullscreen = () => {\n    if (!document.fullscreenElement) {\n      var _containerRef$current;\n      (_containerRef$current = containerRef.current) === null || _containerRef$current === void 0 ? void 0 : _containerRef$current.requestFullscreen();\n      setFullscreen(true);\n    } else {\n      document.exitFullscreen();\n      setFullscreen(false);\n    }\n  };\n\n  // Transición mejorada\n  const startTransition = useCallback(targetIdx => {\n    if (transitioning) return;\n    const scene = sceneRef.current;\n    const renderer = rendererRef.current;\n    const camera = cameraRef.current;\n    if (!scene || !renderer || !camera) return;\n\n    // Capturar textura de la escena actual\n    const renderTarget = new THREE.WebGLRenderTarget(renderer.domElement.width, renderer.domElement.height);\n    renderer.setRenderTarget(renderTarget);\n    renderer.render(scene, camera);\n    renderer.setRenderTarget(null);\n    setPrevTexture(renderTarget.texture);\n    setTransitioning(true);\n    setTransitionProgress(0);\n    setPendingSceneIndex(targetIdx);\n\n    // Animación de transición\n    const startTime = Date.now();\n    const duration = 800;\n    const animateTransition = () => {\n      const elapsed = Date.now() - startTime;\n      const progress = Math.min(elapsed / duration, 1);\n\n      // Easing suave\n      const easedProgress = 1 - Math.pow(1 - progress, 3);\n      setTransitionProgress(easedProgress);\n      if (progress < 1) {\n        animationRef.current = requestAnimationFrame(animateTransition);\n      } else {\n        // Finalizar transición\n        setCurrentSceneIndex(targetIdx);\n        setTransitioning(false);\n        setPendingSceneIndex(null);\n        setPrevTexture(null);\n        if (renderTarget) {\n          renderTarget.dispose();\n        }\n      }\n    };\n    animationRef.current = requestAnimationFrame(animateTransition);\n  }, [transitioning]);\n\n  // Efecto de vibración en móviles para feedback táctil\n  const triggerHapticFeedback = () => {\n    if (navigator.vibrate && isMobile) {\n      navigator.vibrate(50);\n    }\n  };\n\n  // Navegación con feedback háptico\n  const navigateToSceneWithFeedback = useCallback(index => {\n    triggerHapticFeedback();\n    navigateToScene(index);\n  }, [navigateToScene]);\n\n  // Cargar tour desde la API\n  useEffect(() => {\n    const fetchTour = async () => {\n      try {\n        var _tourData$scenes, _tourData$scenes2;\n        const response = await api.getTour(tourId);\n        const tourData = response.data;\n\n        // Validar y limpiar datos del tour\n        if (tourData && tourData.scenes) {\n          tourData.scenes = tourData.scenes.map((scene, sceneIndex) => {\n            if (scene.hotspots && Array.isArray(scene.hotspots)) {\n              // Limpiar hotspots inválidos\n              scene.hotspots = scene.hotspots.filter(hotspot => {\n                if (!hotspot || typeof hotspot.pitch !== 'number' || typeof hotspot.yaw !== 'number') {\n                  console.warn(`Eliminando hotspot inválido en escena ${sceneIndex}:`, hotspot);\n                  return false;\n                }\n                return true;\n              });\n            }\n            return scene;\n          });\n        }\n        setTour(tourData);\n        setLoading(false);\n        console.log('Tour cargado:', {\n          id: tourData._id,\n          name: tourData.name,\n          scenes: ((_tourData$scenes = tourData.scenes) === null || _tourData$scenes === void 0 ? void 0 : _tourData$scenes.length) || 0,\n          totalHotspots: ((_tourData$scenes2 = tourData.scenes) === null || _tourData$scenes2 === void 0 ? void 0 : _tourData$scenes2.reduce((total, scene) => {\n            var _scene$hotspots;\n            return total + (((_scene$hotspots = scene.hotspots) === null || _scene$hotspots === void 0 ? void 0 : _scene$hotspots.length) || 0);\n          }, 0)) || 0\n        });\n      } catch (err) {\n        setError('Error al cargar el tour');\n        setLoading(false);\n        console.error('Error cargando tour:', err);\n      }\n    };\n    fetchTour();\n  }, [tourId]);\n\n  // Inicializar Three.js\n  useEffect(() => {\n    if (!tour || loading) return;\n\n    // Limpiar canvas anterior si existe\n    if (rendererRef.current && rendererRef.current.domElement && containerRef.current) {\n      if (containerRef.current.contains(rendererRef.current.domElement)) {\n        containerRef.current.removeChild(rendererRef.current.domElement);\n      }\n      rendererRef.current.dispose();\n    }\n\n    // Eliminar cualquier canvas sobrante (por si acaso)\n    if (containerRef.current) {\n      while (containerRef.current.firstChild) {\n        containerRef.current.removeChild(containerRef.current.firstChild);\n      }\n    }\n\n    // Usar el tamaño del contenedor para el renderer\n    const width = containerRef.current.clientWidth || window.innerWidth;\n    const height = containerRef.current.clientHeight || window.innerHeight;\n    const scene = new THREE.Scene();\n    const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);\n    camera.position.set(0, 0, 0.1);\n    const renderer = new THREE.WebGLRenderer({\n      antialias: true,\n      alpha: true,\n      powerPreference: \"high-performance\",\n      preserveDrawingBuffer: true\n    });\n    renderer.setSize(width, height);\n    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\n    renderer.toneMapping = THREE.ACESFilmicToneMapping;\n    renderer.toneMappingExposure = 1.0;\n    renderer.shadowMap.enabled = true;\n    renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n    renderer.setClearColor(0x181c23, 1); // Fondo oscuro mejorado\n    containerRef.current.appendChild(renderer.domElement);\n    const controls = new OrbitControls(camera, renderer.domElement);\n    controls.enableDamping = true;\n    controls.dampingFactor = 0.05;\n    controls.rotateSpeed = -0.5; // INVERTIR dirección de rotación\n    // Soporte de zoom con scroll del mouse\n    controls.enableZoom = true;\n    controls.minDistance = 0.05;\n    controls.maxDistance = 2.5;\n    // Limitar fov para evitar zoom extremo\n    renderer.domElement.addEventListener('wheel', e => {\n      e.preventDefault();\n      camera.fov = Math.max(30, Math.min(100, camera.fov + (e.deltaY > 0 ? 2 : -2)));\n      camera.updateProjectionMatrix();\n    }, {\n      passive: false\n    });\n    sceneRef.current = scene;\n    cameraRef.current = camera;\n    rendererRef.current = renderer;\n    controlsRef.current = controls;\n    let animationId;\n    const animate = () => {\n      animationId = requestAnimationFrame(animate);\n      // Animación de expansión/contracción para esferas access\n      if (accessSpheresRef.current && accessSpheresRef.current.length > 0) {\n        const t = Date.now() * 0.003;\n        accessSpheresRef.current.forEach(sphere => {\n          const scale = 1.1 + 0.15 * Math.sin(t + sphere.position.x);\n          sphere.scale.set(scale, scale, scale);\n        });\n      }\n      controls.update();\n      renderer.render(scene, camera);\n    };\n    animate();\n\n    // Responsivo al tamaño del contenedor\n    const handleResize = () => {\n      if (!containerRef.current) return;\n      const w = containerRef.current.clientWidth || window.innerWidth;\n      const h = containerRef.current.clientHeight || window.innerHeight;\n      camera.aspect = w / h;\n      camera.updateProjectionMatrix();\n      renderer.setSize(w, h);\n    };\n    window.addEventListener('resize', handleResize);\n\n    // Limpieza\n    return () => {\n      window.removeEventListener('resize', handleResize);\n      if (animationId) cancelAnimationFrame(animationId);\n      if (rendererRef.current && rendererRef.current.domElement && containerRef.current && containerRef.current.contains(rendererRef.current.domElement)) {\n        rendererRef.current.dispose();\n        containerRef.current.removeChild(rendererRef.current.domElement);\n      }\n    };\n  }, [tour, loading]);\n\n  // Cargar la escena current con manejo optimizado de hotspots\n  useEffect(() => {\n    if (!tour || !sceneRef.current || !tour.scenes || !Array.isArray(tour.scenes) || tour.scenes.length === 0 || currentSceneIndex === -1 || !tour.scenes[currentSceneIndex]) return;\n    const scene = sceneRef.current;\n    const currentScene = tour.scenes[currentSceneIndex];\n\n    // Limpiar escena anterior completamente\n    while (scene.children.length > 0) {\n      const child = scene.children[0];\n      // Limpiar recursos de Three.js\n      if (child.geometry) child.geometry.dispose();\n      if (child.material) {\n        if (Array.isArray(child.material)) {\n          child.material.forEach(mat => mat.dispose());\n        } else {\n          child.material.dispose();\n        }\n      }\n      scene.remove(child);\n    }\n\n    // Limpiar referencias\n    hotspotSpritesRef.current = [];\n    accessSpheresRef.current = [];\n\n    // Crear esfera para la imagen 360 con mayor calidad visual\n    const geometry = new THREE.SphereGeometry(500, 128, 96);\n    geometry.scale(-1, 1, 1);\n    const textureLoader = new THREE.TextureLoader();\n    let imageUrl = getAbsoluteImageUrl(currentScene.image);\n    textureLoader.load(imageUrl, texture => {\n      var _rendererRef$current;\n      texture.minFilter = THREE.LinearFilter;\n      texture.magFilter = THREE.LinearFilter;\n      texture.generateMipmaps = false;\n      texture.anisotropy = ((_rendererRef$current = rendererRef.current) === null || _rendererRef$current === void 0 ? void 0 : _rendererRef$current.capabilities.getMaxAnisotropy()) || 1;\n      if (texture.colorSpace !== undefined && THREE.LinearSRGBColorSpace) {\n        texture.colorSpace = THREE.LinearSRGBColorSpace;\n      }\n      const material = new THREE.MeshBasicMaterial({\n        map: texture,\n        side: THREE.DoubleSide\n      });\n      const sphere = new THREE.Mesh(geometry, material);\n      scene.add(sphere);\n\n      // --- Renderizar Hotspots con estado optimizado ---\n      renderHotspotsForScene(currentScene, scene);\n    }, undefined, err => {\n      console.error('Error al cargar la textura:', err, imageUrl);\n      const material = new THREE.MeshBasicMaterial({\n        color: 0x444444,\n        side: THREE.DoubleSide\n      });\n      const sphere = new THREE.Mesh(geometry, material);\n      scene.add(sphere);\n    });\n  }, [tour, currentSceneIndex]);\n\n  // Función de utilidad para depurar hotspots\n  const debugHotspots = (sceneData, sceneIndex) => {\n    if (!sceneData.hotspots || !Array.isArray(sceneData.hotspots)) {\n      console.log(`Escena ${sceneIndex}: No hay hotspots`);\n      return;\n    }\n    console.log(`Escena ${sceneIndex} (${sceneData.name}):`, {\n      totalHotspots: sceneData.hotspots.length,\n      accessHotspots: sceneData.hotspots.filter(h => h.type === 'access').length,\n      commerceHotspots: sceneData.hotspots.filter(h => h.type === 'commerce').length,\n      locationHotspots: sceneData.hotspots.filter(h => h.type === 'location').length,\n      hotspots: sceneData.hotspots.map((h, i) => ({\n        index: i,\n        type: h.type,\n        pitch: h.pitch,\n        yaw: h.yaw,\n        targetSceneId: h.targetSceneId,\n        title: h.title\n      }))\n    });\n  };\n\n  // Función optimizada para renderizar hotspots\n  const renderHotspotsForScene = (sceneData, threeScene) => {\n    if (!Array.isArray(sceneData.hotspots) || sceneData.hotspots.length === 0) {\n      return;\n    }\n\n    // Validar y limpiar hotspots antes de renderizar\n    const validHotspots = sceneData.hotspots.filter((hotspot, index) => {\n      // Validar que el hotspot tenga las propiedades requeridas\n      if (!hotspot || typeof hotspot.pitch !== 'number' || typeof hotspot.yaw !== 'number') {\n        console.warn(`Hotspot inválido en índice ${index}:`, hotspot);\n        return false;\n      }\n\n      // Validar que el hotspot de acceso tenga targetSceneId\n      if (hotspot.type === 'access' && !hotspot.targetSceneId) {\n        console.warn(`Hotspot de acceso sin targetSceneId en índice ${index}:`, hotspot);\n        return false;\n      }\n      return true;\n    });\n    console.log(`Renderizando ${validHotspots.length} hotspots válidos para la escena ${currentSceneIndex}`);\n\n    // Depurar hotspots para esta escena\n    debugHotspots(sceneData, currentSceneIndex);\n    validHotspots.forEach((hotspot, index) => {\n      try {\n        // Convertir pitch/yaw a coordenadas cartesianas\n        const radius = 500;\n        const phi = THREE.MathUtils.degToRad(90 - hotspot.pitch);\n        const theta = THREE.MathUtils.degToRad(hotspot.yaw);\n        const x = radius * Math.sin(phi) * Math.sin(theta);\n        const y = radius * Math.cos(phi);\n        const z = radius * Math.sin(phi) * Math.cos(theta);\n        let obj3d;\n        if (hotspot.type === 'access') {\n          // Esfera 3D para access con mejor visualización\n          const geometry = new THREE.SphereGeometry(12, 32, 32);\n          const material = new THREE.MeshStandardMaterial({\n            color: 0x38bdf8,\n            emissive: 0x0ea5e9,\n            metalness: 0.3,\n            roughness: 0.5\n          });\n          obj3d = new THREE.Mesh(geometry, material);\n\n          // Agregar información adicional al hotspot para mejor navegación\n          obj3d.userData.hotspot = {\n            ...hotspot,\n            sceneIndex: currentSceneIndex,\n            sceneName: sceneData.name\n          };\n          obj3d.userData.isAccessHotspot = true;\n          obj3d.userData.hotspotIndex = index;\n          accessSpheresRef.current.push(obj3d);\n        } else {\n          // Sprite para otros tipos con mejor diseño\n          const size = 64;\n          const canvas = document.createElement('canvas');\n          canvas.width = size;\n          canvas.height = size;\n          const ctx = canvas.getContext('2d');\n\n          // Fondo con gradiente\n          const gradient = ctx.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, size / 2);\n          gradient.addColorStop(0, '#38bdf8');\n          gradient.addColorStop(1, '#0ea5e9');\n          ctx.fillStyle = gradient;\n          ctx.beginPath();\n          ctx.arc(size / 2, size / 2, size / 2 - 4, 0, 2 * Math.PI);\n          ctx.fill();\n\n          // Borde blanco\n          ctx.lineWidth = 4;\n          ctx.strokeStyle = '#fff';\n          ctx.stroke();\n\n          // Sombra\n          ctx.shadowColor = '#0ea5e9';\n          ctx.shadowBlur = 8;\n          const texture = new THREE.CanvasTexture(canvas);\n          const material = new THREE.SpriteMaterial({\n            map: texture,\n            depthTest: false,\n            transparent: true\n          });\n          obj3d = new THREE.Sprite(material);\n          obj3d.scale.set(20, 20, 1);\n          obj3d.userData.hotspot = {\n            ...hotspot,\n            sceneIndex: currentSceneIndex,\n            sceneName: sceneData.name\n          };\n          obj3d.userData.hotspotIndex = index;\n        }\n        obj3d.position.set(x, y, z);\n        threeScene.add(obj3d);\n        hotspotSpritesRef.current.push(obj3d);\n      } catch (error) {\n        console.error('Error renderizando hotspot:', error, hotspot);\n      }\n    });\n  };\n\n  // --- Detección de clics en hotspots optimizada ---\n  useEffect(() => {\n    if (!rendererRef.current || !cameraRef.current || !sceneRef.current || !tour) return;\n    const dom = rendererRef.current.domElement;\n    let lastClickTime = 0;\n\n    // Función optimizada para navegar a hotspots de acceso\n    const doubleClickNavigateToAccessHotspot = hotspot => {\n      if (!hotspot || hotspot.type !== 'access' || !hotspot.targetSceneId) {\n        console.log('Hotspot inválido para navegación:', hotspot);\n        return;\n      }\n\n      // Buscar la escena destino usando diferentes métodos de comparación\n      let targetIdx = -1;\n\n      // Método 1: Comparación directa de IDs\n      targetIdx = tour.scenes.findIndex(s => String(s._id) === String(hotspot.targetSceneId));\n\n      // Método 2: Si no se encuentra, buscar por índice (fallback)\n      if (targetIdx === -1 && typeof hotspot.targetSceneId === 'number') {\n        targetIdx = hotspot.targetSceneId;\n      }\n\n      // Método 3: Buscar por nombre de escena (fallback adicional)\n      if (targetIdx === -1 && hotspot.targetSceneName) {\n        targetIdx = tour.scenes.findIndex(s => s.name === hotspot.targetSceneName);\n      }\n      if (targetIdx !== -1 && targetIdx < tour.scenes.length) {\n        console.log(`Navegando de escena ${currentSceneIndex} a escena ${targetIdx}`);\n        startTransition(targetIdx);\n      } else {\n        console.error('Escena destino no encontrada:', {\n          targetSceneId: hotspot.targetSceneId,\n          availableScenes: tour.scenes.map((s, i) => ({\n            index: i,\n            id: s._id,\n            name: s.name\n          }))\n        });\n      }\n    };\n\n    // Función optimizada para manejar clics en hotspots\n    function onPointerDown(event) {\n      // Solo click izquierdo\n      if (event.button !== 0) return;\n      const rect = dom.getBoundingClientRect();\n      const mouse = new THREE.Vector2((event.clientX - rect.left) / rect.width * 2 - 1, -((event.clientY - rect.top) / rect.height) * 2 + 1);\n      const raycaster = new THREE.Raycaster();\n      raycaster.setFromCamera(mouse, cameraRef.current);\n\n      // Usar todos los objetos de la escena actual para detectar hotspots\n      const intersects = raycaster.intersectObjects(sceneRef.current.children, true);\n      if (intersects.length > 0) {\n        const obj = intersects[0].object;\n        const now = Date.now();\n\n        // Verificar si es un hotspot\n        if (obj.userData && obj.userData.hotspot) {\n          const hotspot = obj.userData.hotspot;\n          if (obj.userData.isAccessHotspot) {\n            if (now - lastClickTime < 400) {\n              // doble click\n              console.log('Doble clic en hotspot de acceso:', hotspot);\n              doubleClickNavigateToAccessHotspot(hotspot);\n            }\n            lastClickTime = now;\n          } else {\n            console.log('Clic en hotspot informativo:', hotspot);\n            setSelectedHotspot(hotspot);\n          }\n        }\n      }\n    }\n    dom.addEventListener('pointerdown', onPointerDown);\n    return () => {\n      dom.removeEventListener('pointerdown', onPointerDown);\n    };\n  }, [tour, currentSceneIndex, hotspotSpritesRef.current]);\n\n  // Animación de transición optimizada\n  useEffect(() => {\n    if (!transitioning) return;\n    let frame;\n    function animate() {\n      setTransitionProgress(prev => {\n        const next = Math.min(prev + 0.04, 1);\n        if (next < 1) {\n          frame = requestAnimationFrame(animate);\n        } else {\n          setTransitioning(false);\n          setPrevTexture(null);\n          setCurrentSceneIndex(pendingSceneIndex);\n        }\n        return next;\n      });\n    }\n    animate();\n    return () => cancelAnimationFrame(frame);\n  }, [transitioning]);\n\n  // Modificar render de la escena para usar el shader durante la transición\n  useEffect(() => {\n    if (!sceneRef.current || !rendererRef.current || !cameraRef.current) return;\n    if (!transitioning || !prevTexture) return;\n    // Crear geometría y materiales\n    const geometry = new THREE.SphereGeometry(500, 128, 96);\n    geometry.scale(-1, 1, 1);\n    const currentScene = tour.scenes[pendingSceneIndex];\n    const loader = new THREE.TextureLoader();\n    loader.load(getAbsoluteImageUrl(currentScene.image), nextTexture => {\n      // Material de transición\n      const material = RadialFadeMaterial(prevTexture, nextTexture, transitionProgress);\n      const sphere = new THREE.Mesh(geometry, material);\n      sceneRef.current.add(sphere);\n      // Render loop\n      function renderTransition() {\n        material.uniforms.uProgress.value = transitionProgress;\n        rendererRef.current.render(sceneRef.current, cameraRef.current);\n        if (transitioning) requestAnimationFrame(renderTransition);else sceneRef.current.remove(sphere);\n      }\n      renderTransition();\n    });\n  }, [transitioning, transitionProgress]);\n\n  // Cuando cambia la escena, hacer fade out y zoom out\n  useEffect(() => {\n    if (pendingSceneIndex === null) return;\n    // Animar FOV (zoom out) y quitar fade\n    const camera = cameraRef.current;\n    if (!camera) return;\n    let startFov = camera.fov;\n    let endFov = 75;\n    let duration = 400;\n    let start = null;\n    function animateZoomOut(ts) {\n      if (!start) start = ts;\n      let progress = Math.min((ts - start) / duration, 1);\n      camera.fov = startFov + (endFov - startFov) * progress;\n      camera.updateProjectionMatrix();\n      if (progress < 1) {\n        requestAnimationFrame(animateZoomOut);\n      } else {\n        setFade(false);\n        setPendingSceneIndex(null);\n      }\n    }\n    setTimeout(() => {\n      requestAnimationFrame(animateZoomOut);\n    }, 250);\n  }, [currentSceneIndex]);\n\n  // Manejar subida de imágenes\n  const handleImageUpload = async e => {\n    let files = [];\n    if (e.target && e.target.files && e.target.files.length > 0) {\n      files = Array.from(e.target.files);\n    } else if (e instanceof File) {\n      files = [e];\n    } else if (Array.isArray(e)) {\n      files = e;\n    }\n    if (!files.length) return;\n    for (const file of files) {\n      try {\n        var _uploadRes$data;\n        let uploadRes = await api.uploadImage(file);\n        let imageUrl = ((_uploadRes$data = uploadRes.data) === null || _uploadRes$data === void 0 ? void 0 : _uploadRes$data.imageUrl) || uploadRes.imageUrl;\n        if (!imageUrl) {\n          throw new Error('No se recibió la URL de la imagen');\n        }\n        const newScene = {\n          name: `Escena ${tour.scenes.length + 1}`,\n          image: imageUrl,\n          hotspots: []\n        };\n        const updatedTour = {\n          ...tour,\n          scenes: [...tour.scenes, newScene]\n        };\n        const savedTour = await api.updateTour(tourId, updatedTour);\n        setTour(savedTour.data ? savedTour.data : savedTour);\n        setCurrentSceneIndex(updatedTour.scenes.length - 1);\n      } catch (err) {\n        console.error('Error subiendo imagen:', err);\n        alert(`Error al subir imagen: ${err.error || err.message || 'Intente nuevamente'}`);\n      }\n    }\n  };\n\n  // Manejar subida de imágenes (DragDrop)\n  const handleDragDropImage = async files => {\n    if (Array.isArray(files)) {\n      for (const file of files) {\n        await handleImageUpload(file);\n      }\n    } else {\n      await handleImageUpload(files);\n    }\n  };\n\n  // Guardar hotspot optimizado\n  const handleSaveHotspot = async hotspotData => {\n    try {\n      console.log('Guardando hotspot:', hotspotData);\n      const updatedScenes = [...tour.scenes];\n      const currentScene = updatedScenes[currentSceneIndex];\n      if (hotspotData._id) {\n        // Actualizar hotspot existente\n        const index = currentScene.hotspots.findIndex(h => h._id === hotspotData._id);\n        if (index !== -1) {\n          currentScene.hotspots[index] = {\n            ...currentScene.hotspots[index],\n            ...hotspotData\n          };\n        }\n      } else {\n        // Crear nuevo hotspot\n        const newHotspot = {\n          ...hotspotData,\n          _id: Date.now().toString()\n        };\n        currentScene.hotspots.push(newHotspot);\n      }\n      const updatedTour = {\n        ...tour,\n        scenes: updatedScenes\n      };\n      setTour(updatedTour);\n\n      // Guardar en el backend\n      await api.updateTour(tourId, updatedTour);\n\n      // Recargar el tour desde la API para asegurar sincronización\n      const response = await api.getTour(tourId);\n      const refreshedTour = response.data ? response.data : response;\n      setTour(refreshedTour);\n\n      // Limpiar estados\n      setSelectedHotspot(null);\n      setPlacementMode(false);\n      console.log('Hotspot guardado exitosamente');\n    } catch (err) {\n      console.error('Error guardando hotspot:', err);\n      alert(`Error al guardar: ${err.error || 'Intente nuevamente'}`);\n    }\n  };\n\n  // Nuevo: Guardar hotspot con pitch/yaw del click\n  const handleSaveHotspotWithCoords = hotspotData => {\n    var _pendingHotspot$pitch, _pendingHotspot$yaw;\n    handleSaveHotspot({\n      ...hotspotData,\n      pitch: (_pendingHotspot$pitch = pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.pitch) !== null && _pendingHotspot$pitch !== void 0 ? _pendingHotspot$pitch : hotspotData.pitch,\n      yaw: (_pendingHotspot$yaw = pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.yaw) !== null && _pendingHotspot$yaw !== void 0 ? _pendingHotspot$yaw : hotspotData.yaw\n    });\n    setPendingHotspot(null);\n  };\n\n  // Efecto unificado para manejar el modo de colocación de hotspots\n  useEffect(() => {\n    if (!rendererRef.current || !sceneRef.current || !cameraRef.current) return;\n    const dom = rendererRef.current.domElement;\n    if (placementMode) {\n      dom.style.cursor = 'crosshair';\n      // Elimina overlay visual, solo usa cursor\n      // El handler de click está en el canvas principal (ver más abajo)\n    } else {\n      dom.style.cursor = '';\n    }\n  }, [placementMode, rendererRef, sceneRef, cameraRef]);\n\n  // Nuevo: Manejar click en la escena para colocar hotspot\n  const handleSceneClick = event => {\n    if (!placementMode) return;\n    // Obtener coordenadas del ratón normalizadas\n    const mouse = new THREE.Vector2();\n    const rect = containerRef.current.getBoundingClientRect();\n    mouse.x = (event.clientX - rect.left) / rect.width * 2 - 1;\n    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n    const raycaster = new THREE.Raycaster();\n    raycaster.setFromCamera(mouse, cameraRef.current);\n\n    // Intersectar con la esfera (único mesh en la escena)\n    const intersects = raycaster.intersectObjects(sceneRef.current.children);\n    if (intersects.length > 0) {\n      const point = intersects[0].point;\n      const radius = 500;\n      const phi = Math.acos(point.y / radius);\n      const theta = Math.atan2(point.x, point.z); // x primero, z segundo\n      const pitch = 90 - THREE.MathUtils.radToDeg(phi);\n      const yaw = THREE.MathUtils.radToDeg(theta);\n      setNewHotspotPosition({\n        pitch,\n        yaw\n      });\n      setShowHotspotModal(true);\n      setPlacementMode(false);\n    }\n  };\n\n  // Guardar el nuevo hotspot usando el endpoint REST optimizado\n  const saveNewHotspot = async hotspotData => {\n    try {\n      console.log('Guardando nuevo hotspot:', hotspotData);\n      if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) {\n        throw new Error('Tour o escena no disponible');\n      }\n      const sceneId = tour.scenes[currentSceneIndex]._id;\n      const response = await api.addHotspot(tour._id, sceneId, hotspotData);\n\n      // Obtener el hotspot creado\n      const newHotspot = response.data ? response.data : response;\n      console.log('Hotspot creado en backend:', newHotspot);\n\n      // Actualizar el estado local\n      const updatedTour = {\n        ...tour\n      };\n      updatedTour.scenes = [...updatedTour.scenes];\n      const scene = updatedTour.scenes[currentSceneIndex];\n      scene.hotspots = [...scene.hotspots, newHotspot];\n      setTour(updatedTour);\n\n      // Limpiar estados\n      setShowHotspotModal(false);\n      setNewHotspotPosition(null);\n      setPlacementMode(false);\n\n      // Recargar el tour desde la API para asegurar sincronización completa\n      const refreshed = await api.getTour(tourId);\n      const refreshedTour = refreshed.data ? refreshed.data : refreshed;\n      setTour(refreshedTour);\n      console.log('Nuevo hotspot guardado exitosamente');\n    } catch (error) {\n      console.error('Error al guardar el hotspot:', error);\n      alert(`Error al guardar el hotspot: ${error.message || 'Intente nuevamente'}`);\n      setShowHotspotModal(false);\n      setNewHotspotPosition(null);\n      setPlacementMode(false);\n    }\n  };\n\n  // Reemplaza la función handleDeleteScene global para aceptar el índice de la escena a eliminar\n  useEffect(() => {\n    window.handleDeleteScene = async deleteIdx => {\n      if (!tour || !tour.scenes || tour.scenes.length <= 1) return;\n      const updatedScenes = tour.scenes.filter((_, idx) => idx !== deleteIdx);\n      let newIndex = currentSceneIndex;\n      if (deleteIdx === currentSceneIndex) {\n        newIndex = deleteIdx === 0 ? 0 : deleteIdx - 1;\n      } else if (deleteIdx < currentSceneIndex) {\n        newIndex = currentSceneIndex - 1;\n      }\n      const updatedTour = {\n        ...tour,\n        scenes: updatedScenes\n      };\n      setTour(updatedTour);\n      setCurrentSceneIndex(newIndex);\n      await api.updateTour(tour._id, updatedTour);\n    };\n    return () => {\n      window.handleDeleteScene = undefined;\n    };\n  }, [tour, currentSceneIndex]);\n\n  // 1. Función para eliminar hotspot de la escena actual\n  const handleDeleteHotspot = async hotspotIdx => {\n    if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) return;\n    const updatedScenes = [...tour.scenes];\n    const scene = {\n      ...updatedScenes[currentSceneIndex]\n    };\n    scene.hotspots = scene.hotspots.filter((_, idx) => idx !== hotspotIdx);\n    updatedScenes[currentSceneIndex] = scene;\n    const updatedTour = {\n      ...tour,\n      scenes: updatedScenes\n    };\n    setTour(updatedTour);\n    await api.updateTour(tour._id, updatedTour);\n  };\n\n  // --- GIROSCOPIO: Lógica de activación y manejo estilo YouTube 360 ---\n  useEffect(() => {\n    if (!isMobileDevice() || !cameraRef.current || !controlsRef.current) return;\n\n    // Habilitar/deshabilitar OrbitControls según el estado del giroscopio\n    controlsRef.current.enabled = true;\n    let lastAlpha = 0,\n      lastBeta = 0,\n      lastGamma = 0;\n    let smoothAlpha = 0,\n      smoothBeta = 0,\n      smoothGamma = 0;\n    const smoothFactor = 0.15;\n    function getScreenOrientation() {\n      if (window.screen.orientation && window.screen.orientation.angle !== undefined) {\n        return window.screen.orientation.angle;\n      }\n      return window.orientation || 0;\n    }\n    function handleOrientation(event) {\n      let alpha = event.alpha || 0;\n      let beta = event.beta || 0;\n      let gamma = event.gamma || 0;\n\n      // INVERTIR alpha para invertir la rotación horizontal\n      alpha = -alpha;\n      smoothAlpha = smoothAlpha * (1 - smoothFactor) + alpha * smoothFactor;\n      smoothBeta = smoothBeta * (1 - smoothFactor) + beta * smoothFactor;\n      smoothGamma = smoothGamma * (1 - smoothFactor) + gamma * smoothFactor;\n      const _alpha = THREE.MathUtils.degToRad(smoothAlpha);\n      const _beta = THREE.MathUtils.degToRad(smoothBeta);\n      const _gamma = THREE.MathUtils.degToRad(smoothGamma);\n      const orient = getScreenOrientation();\n      const orientRad = THREE.MathUtils.degToRad(orient);\n      const zee = new THREE.Vector3(0, 0, 1);\n      const euler = new THREE.Euler();\n      const q0 = new THREE.Quaternion();\n      const q1 = new THREE.Quaternion(-Math.sqrt(0.5), 0, 0, Math.sqrt(0.5));\n      euler.set(_beta, _alpha, -_gamma, 'YXZ');\n      let quaternion = new THREE.Quaternion().setFromEuler(euler);\n      quaternion.multiply(q1);\n      quaternion.multiply(q0.setFromAxisAngle(zee, -orientRad));\n      cameraRef.current.quaternion.copy(quaternion);\n    }\n    window.addEventListener('deviceorientation', handleOrientation, true);\n    const handleScreenOrientation = () => {\n      smoothAlpha = lastAlpha;\n      smoothBeta = lastBeta;\n      smoothGamma = lastGamma;\n    };\n    window.addEventListener('orientationchange', handleScreenOrientation);\n    return () => {\n      window.removeEventListener('deviceorientation', handleOrientation, true);\n      window.removeEventListener('orientationchange', handleScreenOrientation);\n      // Rehabilitar OrbitControls al salir del modo giroscopio\n      if (controlsRef.current) controlsRef.current.enabled = true;\n    };\n  }, []);\n  if (loading) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"loading\",\n      children: \"Cargando tour...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1056,\n      columnNumber: 12\n    }, this);\n  }\n  if (error) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"error\",\n      children: error\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1060,\n      columnNumber: 12\n    }, this);\n  }\n\n  // Si no hay escenas, muestra mensaje amigable y área de drag & drop\n  if (!tour.scenes || tour.scenes.length === 0) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"tour-editor\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        ref: containerRef,\n        className: \"three-container\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1067,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(ControlPanel, {\n        open: panelOpen,\n        setOpen: setPanelOpen,\n        tour: tour,\n        handleDragDropImage: handleDragDropImage,\n        handleImageUpload: handleImageUpload,\n        scenes: [],\n        placementMode: placementMode,\n        setPlacementMode: setPlacementMode,\n        onReturn: () => navigate('/hub'),\n        handleDeleteHotspot: handleDeleteHotspot\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1068,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1066,\n      columnNumber: 7\n    }, this);\n  }\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"tour-editor\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      ref: containerRef,\n      className: \"three-container\",\n      onClick: handleSceneClick\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1086,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `fade-overlay${fade ? ' visible' : ''}`\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1091,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"viewer-controls\",\n      children: [/*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"btn-return\",\n        onClick: () => navigate('/hub'),\n        children: \"\\u2190 Volver al Hub\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1095,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"control-buttons\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          className: `control-btn ${autoRotate ? 'active' : ''}`,\n          onClick: () => setAutoRotate(!autoRotate),\n          title: \"Rotaci\\xF3n autom\\xE1tica (Espacio)\",\n          children: \"\\uD83D\\uDD04\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1100,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"control-btn\",\n          onClick: toggleFullscreen,\n          title: \"Pantalla completa (F)\",\n          children: fullscreen ? '⛶' : '⛶'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1108,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: `control-btn ${showSceneSelector ? 'active' : ''}`,\n          onClick: () => setShowSceneSelector(!showSceneSelector),\n          title: \"Selector de escenas\",\n          children: \"\\uD83D\\uDCCB\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1116,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1099,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1094,\n      columnNumber: 7\n    }, this), showSceneSelector && /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"scene-selector\",\n      children: tour.scenes.map((scene, index) => /*#__PURE__*/_jsxDEV(\"button\", {\n        className: `scene-btn ${index === currentSceneIndex ? 'active' : ''}`,\n        onClick: () => navigateToSceneWithFeedback(index),\n        disabled: transitioning,\n        children: index + 1\n      }, scene._id, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1130,\n        columnNumber: 13\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1128,\n      columnNumber: 9\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"navigation-arrows\",\n      children: [/*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"nav-arrow left\",\n        onClick: () => navigateToSceneWithFeedback(currentSceneIndex - 1),\n        disabled: currentSceneIndex === 0 || transitioning,\n        children: \"\\u2039\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1144,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"nav-arrow right\",\n        onClick: () => navigateToSceneWithFeedback(currentSceneIndex + 1),\n        disabled: currentSceneIndex === tour.scenes.length - 1 || transitioning,\n        children: \"\\u203A\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1151,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1143,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"scene-info\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"scene-title\",\n        children: ((_tour$scenes$currentS = tour.scenes[currentSceneIndex]) === null || _tour$scenes$currentS === void 0 ? void 0 : _tour$scenes$currentS.title) || `Escena ${currentSceneIndex + 1}`\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1162,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"scene-description\",\n        children: ((_tour$scenes$currentS2 = tour.scenes[currentSceneIndex]) === null || _tour$scenes$currentS2 === void 0 ? void 0 : _tour$scenes$currentS2.description) || 'Editor de tour 360°'\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1165,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1161,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"progress-indicator\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"progress-bar\",\n        children: /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"progress-fill\",\n          style: {\n            width: `${(currentSceneIndex + 1) / tour.scenes.length * 100}%`\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1173,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1172,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n        className: \"progress-text\",\n        children: [currentSceneIndex + 1, \" / \", tour.scenes.length]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1178,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1171,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"instructions\",\n      children: /*#__PURE__*/_jsxDEV(\"p\", {\n        children: \"Usa las flechas del teclado para navegar \\u2022 Espacio para rotaci\\xF3n autom\\xE1tica \\u2022 F para pantalla completa\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 1185,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1184,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(ControlPanel, {\n      open: panelOpen,\n      setOpen: setPanelOpen,\n      tour: tour,\n      handleDragDropImage: handleDragDropImage,\n      handleImageUpload: handleImageUpload,\n      scenes: tour.scenes,\n      currentSceneIndex: currentSceneIndex,\n      setCurrentSceneIndex: setCurrentSceneIndex,\n      placementMode: placementMode,\n      setPlacementMode: setPlacementMode,\n      onReturn: () => navigate('/hub'),\n      handleDeleteHotspot: handleDeleteHotspot\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1187,\n      columnNumber: 7\n    }, this), (selectedHotspot || pendingHotspot) && /*#__PURE__*/_jsxDEV(HotspotEditor, {\n      hotspot: selectedHotspot || {\n        pitch: pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.pitch,\n        yaw: pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.yaw\n      },\n      scenes: tour.scenes,\n      onSave: pendingHotspot ? handleSaveHotspotWithCoords : handleSaveHotspot,\n      onCancel: () => {\n        setSelectedHotspot(null);\n        setPlacementMode(false);\n        setPendingHotspot(null);\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1202,\n      columnNumber: 9\n    }, this), showHotspotModal && newHotspotPosition && /*#__PURE__*/_jsxDEV(HotspotCreationModal, {\n      position: newHotspotPosition,\n      tour: tour,\n      currentSceneIndex: currentSceneIndex,\n      onSave: saveNewHotspot,\n      onCancel: () => {\n        setShowHotspotModal(false);\n        setNewHotspotPosition(null);\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1214,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 1085,\n    columnNumber: 5\n  }, this);\n}\n\n// Panel lateral plegable\n_s(TourEditor, \"yyZ6RuW2GiBGL6q20O5dio5By14=\", false, function () {\n  return [useNavigate];\n});\n_c = TourEditor;\nfunction ControlPanel({\n  open,\n  setOpen,\n  tour,\n  handleDragDropImage,\n  handleImageUpload,\n  scenes,\n  currentSceneIndex,\n  setCurrentSceneIndex,\n  placementMode,\n  setPlacementMode,\n  onReturn,\n  handleDeleteHotspot\n}) {\n  var _scenes$currentSceneI, _scenes$currentSceneI2, _scenes$currentSceneI3, _scenes$currentSceneI4;\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(\"aside\", {\n      className: `editor-panel${open ? ' open' : ''}`,\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"panel-header\",\n        children: [/*#__PURE__*/_jsxDEV(\"span\", {\n          className: \"panel-title\",\n          children: \"Tour Virtual 360\\xB0\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1248,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"panel-toggle\",\n          onClick: () => setOpen(!open),\n          children: open ? /*#__PURE__*/_jsxDEV(_Fragment, {\n            children: \"\\u276E\"\n          }, void 0, false) : /*#__PURE__*/_jsxDEV(_Fragment, {\n            children: \"\\u276F\"\n          }, void 0, false)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1249,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1247,\n        columnNumber: 9\n      }, this), open && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"panel-content\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"btn-return-hub\",\n          onClick: onReturn,\n          style: {\n            background: '#23272f',\n            color: '#38bdf8',\n            border: 'none',\n            borderRadius: 8,\n            padding: '10px 0',\n            fontSize: '1rem',\n            fontWeight: 500,\n            marginBottom: 18,\n            cursor: 'pointer',\n            width: '100%',\n            transition: 'background 0.2s, color 0.2s'\n          },\n          children: \"\\u2190 Volver al Hub\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1255,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(ApiKeyManager, {\n          tourId: tour._id,\n          initialApiKey: tour.apiKey\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 1274,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section\",\n          children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n            children: \"Im\\xE1genes 360\\xB0\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1276,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(DragDrop, {\n            onFileUpload: handleDragDropImage\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1277,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"panel-dragdrop-hint\",\n            children: \"o haz clic para seleccionar\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1278,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n            type: \"file\",\n            id: \"image-upload\",\n            accept: \"image/*\",\n            onChange: handleImageUpload,\n            style: {\n              display: 'none'\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1279,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1275,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section\",\n          children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n            children: [\"Im\\xE1genes Cargadas (\", scenes.length, \")\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1288,\n            columnNumber: 15\n          }, this), scenes.length === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"panel-empty\",\n            children: \"No hay im\\xE1genes cargadas\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1290,\n            columnNumber: 17\n          }, this) : /*#__PURE__*/_jsxDEV(\"ul\", {\n            className: \"panel-image-list\",\n            children: scenes.map((scene, idx) => /*#__PURE__*/_jsxDEV(\"li\", {\n              className: `panel-image-item${currentSceneIndex === idx ? ' active' : ''}`,\n              style: {\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'space-between'\n              },\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  display: 'flex',\n                  alignItems: 'center',\n                  flex: 1,\n                  cursor: 'pointer'\n                },\n                onClick: () => setCurrentSceneIndex && setCurrentSceneIndex(idx),\n                children: [/*#__PURE__*/_jsxDEV(\"img\", {\n                  src: scene.image ? getAbsoluteImageUrl(scene.image) : '',\n                  alt: scene.name\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1300,\n                  columnNumber: 25\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  children: scene.name\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1301,\n                  columnNumber: 25\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1299,\n                columnNumber: 23\n              }, this), scenes.length > 1 && /*#__PURE__*/_jsxDEV(\"button\", {\n                className: \"btn-delete-scene\",\n                style: {\n                  background: 'transparent',\n                  color: '#ef4444',\n                  border: 'none',\n                  marginLeft: 8,\n                  fontSize: 20,\n                  cursor: 'pointer'\n                },\n                title: \"Eliminar escena\",\n                onClick: e => {\n                  e.stopPropagation();\n                  if (window.confirm('¿Seguro que deseas eliminar esta escena?')) {\n                    if (typeof window.handleDeleteScene === 'function') window.handleDeleteScene(idx);\n                  }\n                },\n                children: \"\\uD83D\\uDDD1\\uFE0F\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1304,\n                columnNumber: 25\n              }, this)]\n            }, scene._id || idx, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1294,\n              columnNumber: 21\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1292,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1287,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section\",\n          children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n            children: [\"Hotspots de la Escena (\", ((_scenes$currentSceneI = scenes[currentSceneIndex]) === null || _scenes$currentSceneI === void 0 ? void 0 : (_scenes$currentSceneI2 = _scenes$currentSceneI.hotspots) === null || _scenes$currentSceneI2 === void 0 ? void 0 : _scenes$currentSceneI2.length) || 0, \")\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1324,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"hotspot-controls\",\n            style: {\n              marginBottom: 15\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"btn-add-hotspot\",\n              onClick: () => setPlacementMode(true),\n              title: \"Haz clic para activar el modo de colocaci\\xF3n de hotspots. Luego haz clic en la imagen 360\\xB0 donde quieras colocar el hotspot.\",\n              style: {\n                background: '#38bdf8',\n                color: '#fff',\n                border: 'none',\n                borderRadius: 8,\n                padding: '10px 16px',\n                fontSize: '14px',\n                fontWeight: 500,\n                cursor: 'pointer',\n                width: '100%',\n                transition: 'background 0.2s',\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'center',\n                gap: 8,\n                position: 'relative'\n              },\n              onMouseEnter: e => e.target.style.background = '#0ea5e9',\n              onMouseLeave: e => e.target.style.background = '#38bdf8',\n              children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                style: {\n                  fontSize: '16px'\n                },\n                children: \"\\uD83D\\uDCCD\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1350,\n                columnNumber: 19\n              }, this), \"Agregar Hotspot\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1326,\n              columnNumber: 17\n            }, this), placementMode && /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"placement-mode-indicator\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  display: 'flex',\n                  justifyContent: 'space-between',\n                  alignItems: 'center',\n                  marginBottom: 8\n                },\n                children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                  children: \"Modo de colocaci\\xF3n activado\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1356,\n                  columnNumber: 23\n                }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n                  onClick: () => setPlacementMode(false),\n                  style: {\n                    background: 'transparent',\n                    border: '1px solid #ef4444',\n                    color: '#ef4444',\n                    borderRadius: 4,\n                    padding: '4px 8px',\n                    fontSize: '11px',\n                    cursor: 'pointer',\n                    transition: 'all 0.2s'\n                  },\n                  onMouseEnter: e => {\n                    e.target.style.background = '#ef4444';\n                    e.target.style.color = '#fff';\n                  },\n                  onMouseLeave: e => {\n                    e.target.style.background = 'transparent';\n                    e.target.style.color = '#ef4444';\n                  },\n                  children: \"Cancelar\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1357,\n                  columnNumber: 23\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 1355,\n                columnNumber: 21\n              }, this), \"Haz clic en la imagen 360\\xB0 para colocar el hotspot\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1354,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1325,\n            columnNumber: 15\n          }, this), ((_scenes$currentSceneI3 = scenes[currentSceneIndex]) === null || _scenes$currentSceneI3 === void 0 ? void 0 : (_scenes$currentSceneI4 = _scenes$currentSceneI3.hotspots) === null || _scenes$currentSceneI4 === void 0 ? void 0 : _scenes$currentSceneI4.length) === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              background: '#1e293b',\n              border: '1px dashed #334155',\n              borderRadius: 6,\n              padding: '20px',\n              textAlign: 'center',\n              color: '#64748b',\n              fontSize: '14px'\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                fontSize: '24px',\n                marginBottom: '8px'\n              },\n              children: \"\\uD83D\\uDCCD\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1395,\n              columnNumber: 19\n            }, this), \"No hay hotspots en esta escena\", /*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                fontSize: '12px',\n                marginTop: '4px'\n              },\n              children: \"Haz clic en \\\"Agregar Hotspot\\\" para comenzar\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1397,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1386,\n            columnNumber: 17\n          }, this) : /*#__PURE__*/_jsxDEV(_Fragment, {\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                background: '#1e293b',\n                border: '1px solid #334155',\n                borderRadius: 6,\n                padding: '8px 12px',\n                marginBottom: '12px',\n                fontSize: '12px',\n                color: '#94a3b8'\n              },\n              children: (() => {\n                const hotspots = scenes[currentSceneIndex].hotspots;\n                const types = {\n                  access: hotspots.filter(h => h.type === 'access').length,\n                  commerce: hotspots.filter(h => h.type === 'commerce').length,\n                  location: hotspots.filter(h => h.type === 'location').length\n                };\n                return /*#__PURE__*/_jsxDEV(\"div\", {\n                  style: {\n                    display: 'flex',\n                    justifyContent: 'space-between'\n                  },\n                  children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [\"\\uD83D\\uDCCD Acceso: \", types.access]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1422,\n                    columnNumber: 27\n                  }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [\"\\uD83C\\uDFEA Comercio: \", types.commerce]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1423,\n                    columnNumber: 27\n                  }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [\"\\uD83D\\uDCCD Locaci\\xF3n: \", types.location]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1424,\n                    columnNumber: 27\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1421,\n                  columnNumber: 25\n                }, this);\n              })()\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1404,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n              className: \"panel-hotspot-list\",\n              children: scenes[currentSceneIndex].hotspots.map((hotspot, idx) => {\n                let accessInfo = null;\n                if (hotspot.type === 'access' && hotspot.targetSceneId) {\n                  const target = scenes.find(s => String(s._id) === String(hotspot.targetSceneId));\n                  accessInfo = target ? `→ ${target.name}` : '→ [Escena no encontrada]';\n                }\n                return /*#__PURE__*/_jsxDEV(\"li\", {\n                  style: {\n                    display: 'flex',\n                    alignItems: 'center',\n                    justifyContent: 'space-between',\n                    gap: 8\n                  },\n                  children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [hotspot.type === 'access' ? 'Punto de Acceso' : hotspot.title || 'Hotspot', accessInfo && /*#__PURE__*/_jsxDEV(\"span\", {\n                      style: {\n                        color: '#38bdf8',\n                        marginLeft: 8,\n                        fontSize: 13\n                      },\n                      children: accessInfo\n                    }, void 0, false, {\n                      fileName: _jsxFileName,\n                      lineNumber: 1440,\n                      columnNumber: 44\n                    }, this)]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1438,\n                    columnNumber: 27\n                  }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n                    style: {\n                      background: 'transparent',\n                      color: '#ef4444',\n                      border: 'none',\n                      fontSize: 18,\n                      cursor: 'pointer'\n                    },\n                    title: \"Eliminar hotspot\",\n                    onClick: () => {\n                      if (window.confirm('¿Eliminar este hotspot?')) handleDeleteHotspot(idx);\n                    },\n                    children: \"\\uD83D\\uDDD1\\uFE0F\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1442,\n                    columnNumber: 27\n                  }, this)]\n                }, hotspot._id || idx, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1437,\n                  columnNumber: 25\n                }, this);\n              })\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1429,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1323,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section panel-hint\",\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            children: /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Tipos de Hotspots:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1451,\n              columnNumber: 18\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1451,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n            style: {\n              margin: '8px 0',\n              paddingLeft: '20px',\n              fontSize: '13px'\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"li\", {\n              children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                children: \"\\uD83D\\uDCCD Acceso:\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1453,\n                columnNumber: 21\n              }, this), \" Navega a otra escena del tour\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1453,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n              children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                children: \"\\uD83C\\uDFEA Comercio:\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1454,\n                columnNumber: 21\n              }, this), \" Muestra informaci\\xF3n de un negocio\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1454,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n              children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                children: \"\\uD83D\\uDCCD Locaci\\xF3n:\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1455,\n                columnNumber: 21\n              }, this), \" Muestra informaci\\xF3n de un lugar\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1455,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1452,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n            style: {\n              marginTop: '12px',\n              fontSize: '13px'\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Controles:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1458,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1458,\n              columnNumber: 44\n            }, this), \"\\u2022 Haz doble clic en hotspots de acceso para navegar\", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1459,\n              columnNumber: 68\n            }, this), \"\\u2022 Haz clic en hotspots para ver/editar informaci\\xF3n\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1457,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1450,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 1254,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 1246,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `editor-backdrop${open ? ' open' : ''}`,\n      onClick: () => setOpen(false)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1466,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true);\n}\n_c2 = ControlPanel;\nexport default TourEditor;\nvar _c, _c2;\n$RefreshReg$(_c, \"TourEditor\");\n$RefreshReg$(_c2, \"ControlPanel\");","map":{"version":3,"names":["React","useRef","useEffect","useState","useCallback","THREE","OrbitControls","HotspotEditor","api","DragDrop","useNavigate","ApiKeyManager","HotspotCreationModal","RadialFadeMaterial","jsxDEV","_jsxDEV","Fragment","_Fragment","getAbsoluteImageUrl","image","startsWith","_process$env$REACT_AP","process","env","REACT_APP_API_URL","replace","createHotspotSprite","hotspot","onClick","size","canvas","document","createElement","width","height","ctx","getContext","gradient","createRadialGradient","addColorStop","beginPath","arc","Math","PI","fillStyle","shadowColor","shadowBlur","fill","lineWidth","strokeStyle","stroke","type","moveTo","lineTo","closePath","texture","CanvasTexture","material","SpriteMaterial","map","depthTest","transparent","opacity","sprite","Sprite","scale","set","userData","isMobileDevice","test","navigator","userAgent","TourEditor","tourId","_s","_tour$scenes$currentS","_tour$scenes$currentS2","containerRef","tour","setTour","currentSceneIndex","setCurrentSceneIndex","selectedHotspot","setSelectedHotspot","loading","setLoading","error","setError","panelOpen","setPanelOpen","pendingHotspot","setPendingHotspot","placementMode","setPlacementMode","newHotspotPosition","setNewHotspotPosition","showHotspotModal","setShowHotspotModal","navigate","fade","setFade","pendingSceneIndex","setPendingSceneIndex","transitioning","setTransitioning","transitionProgress","setTransitionProgress","prevTexture","setPrevTexture","isMobile","setIsMobile","autoRotate","setAutoRotate","fullscreen","setFullscreen","showSceneSelector","setShowSceneSelector","sceneRef","cameraRef","rendererRef","controlsRef","hotspotSpritesRef","accessSpheresRef","animationRef","handleKeyDown","event","scenes","key","preventDefault","navigateToScene","toggleFullscreen","addEventListener","removeEventListener","index","length","startTransition","fullscreenElement","_containerRef$current","current","requestFullscreen","exitFullscreen","targetIdx","scene","renderer","camera","renderTarget","WebGLRenderTarget","domElement","setRenderTarget","render","startTime","Date","now","duration","animateTransition","elapsed","progress","min","easedProgress","pow","requestAnimationFrame","dispose","triggerHapticFeedback","vibrate","navigateToSceneWithFeedback","fetchTour","_tourData$scenes","_tourData$scenes2","response","getTour","tourData","data","sceneIndex","hotspots","Array","isArray","filter","pitch","yaw","console","warn","log","id","_id","name","totalHotspots","reduce","total","_scene$hotspots","err","contains","removeChild","firstChild","clientWidth","window","innerWidth","clientHeight","innerHeight","Scene","PerspectiveCamera","position","WebGLRenderer","antialias","alpha","powerPreference","preserveDrawingBuffer","setSize","setPixelRatio","devicePixelRatio","toneMapping","ACESFilmicToneMapping","toneMappingExposure","shadowMap","enabled","PCFSoftShadowMap","setClearColor","appendChild","controls","enableDamping","dampingFactor","rotateSpeed","enableZoom","minDistance","maxDistance","e","fov","max","deltaY","updateProjectionMatrix","passive","animationId","animate","t","forEach","sphere","sin","x","update","handleResize","w","h","aspect","cancelAnimationFrame","currentScene","children","child","geometry","mat","remove","SphereGeometry","textureLoader","TextureLoader","imageUrl","load","_rendererRef$current","minFilter","LinearFilter","magFilter","generateMipmaps","anisotropy","capabilities","getMaxAnisotropy","colorSpace","undefined","LinearSRGBColorSpace","MeshBasicMaterial","side","DoubleSide","Mesh","add","renderHotspotsForScene","color","debugHotspots","sceneData","accessHotspots","commerceHotspots","locationHotspots","i","targetSceneId","title","threeScene","validHotspots","radius","phi","MathUtils","degToRad","theta","y","cos","z","obj3d","MeshStandardMaterial","emissive","metalness","roughness","sceneName","isAccessHotspot","hotspotIndex","push","dom","lastClickTime","doubleClickNavigateToAccessHotspot","findIndex","s","String","targetSceneName","availableScenes","onPointerDown","button","rect","getBoundingClientRect","mouse","Vector2","clientX","left","clientY","top","raycaster","Raycaster","setFromCamera","intersects","intersectObjects","obj","object","frame","prev","next","loader","nextTexture","renderTransition","uniforms","uProgress","value","startFov","endFov","start","animateZoomOut","ts","setTimeout","handleImageUpload","files","target","from","File","file","_uploadRes$data","uploadRes","uploadImage","Error","newScene","updatedTour","savedTour","updateTour","alert","message","handleDragDropImage","handleSaveHotspot","hotspotData","updatedScenes","newHotspot","toString","refreshedTour","handleSaveHotspotWithCoords","_pendingHotspot$pitch","_pendingHotspot$yaw","style","cursor","handleSceneClick","point","acos","atan2","radToDeg","saveNewHotspot","sceneId","addHotspot","refreshed","handleDeleteScene","deleteIdx","_","idx","newIndex","handleDeleteHotspot","hotspotIdx","lastAlpha","lastBeta","lastGamma","smoothAlpha","smoothBeta","smoothGamma","smoothFactor","getScreenOrientation","screen","orientation","angle","handleOrientation","beta","gamma","_alpha","_beta","_gamma","orient","orientRad","zee","Vector3","euler","Euler","q0","Quaternion","q1","sqrt","quaternion","setFromEuler","multiply","setFromAxisAngle","copy","handleScreenOrientation","className","fileName","_jsxFileName","lineNumber","columnNumber","ref","ControlPanel","open","setOpen","onReturn","disabled","description","onSave","onCancel","_c","_scenes$currentSceneI","_scenes$currentSceneI2","_scenes$currentSceneI3","_scenes$currentSceneI4","background","border","borderRadius","padding","fontSize","fontWeight","marginBottom","transition","initialApiKey","apiKey","onFileUpload","accept","onChange","display","alignItems","justifyContent","flex","src","alt","marginLeft","stopPropagation","confirm","gap","onMouseEnter","onMouseLeave","textAlign","marginTop","types","access","commerce","location","accessInfo","find","margin","paddingLeft","_c2","$RefreshReg$"],"sources":["D:/respaldo jose/PROJECTS_V0/hub360/frontend/src/components/Editor/TourEditor.js"],"sourcesContent":["import React, { useRef, useEffect, useState, useCallback } from 'react';\nimport * as THREE from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';\nimport HotspotEditor from './HotspotEditor';\nimport api from '../../services/api';\nimport DragDrop from './DragDrop';\nimport { useNavigate } from 'react-router-dom';\nimport './TourEditor.css';\nimport ApiKeyManager from './ApiKeyManager';\nimport HotspotCreationModal from './HotspotCreationModal';\nimport RadialFadeMaterial from '../shaders/RadialFadeMaterial';\n\n// Utilidad para obtener la URL absoluta de la imagen\nfunction getAbsoluteImageUrl(image) {\n  if (!image) return '';\n  if (image.startsWith('/uploads/')) {\n    return `${process.env.REACT_APP_API_URL?.replace('/api', '') || 'http://localhost:5000'}${image}`;\n  }\n  return image;\n}\n\n// Hotspot mejorado con efectos visuales similares a Kuula\nfunction createHotspotSprite(hotspot, onClick) {\n  const size = 80;\n  const canvas = document.createElement('canvas');\n  canvas.width = size;\n  canvas.height = size;\n  const ctx = canvas.getContext('2d');\n  \n  // Fondo con gradiente\n  const gradient = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);\n  gradient.addColorStop(0, 'rgba(56, 189, 248, 0.9)');\n  gradient.addColorStop(0.7, 'rgba(14, 165, 233, 0.7)');\n  gradient.addColorStop(1, 'rgba(14, 165, 233, 0.3)');\n  \n  ctx.beginPath();\n  ctx.arc(size/2, size/2, size/2-6, 0, 2*Math.PI);\n  ctx.fillStyle = gradient;\n  ctx.shadowColor = '#0ea5e9';\n  ctx.shadowBlur = 12;\n  ctx.fill();\n  \n  // Borde exterior\n  ctx.lineWidth = 3;\n  ctx.strokeStyle = '#ffffff';\n  ctx.stroke();\n  \n  // Borde interior\n  ctx.beginPath();\n  ctx.arc(size/2, size/2, size/2-12, 0, 2*Math.PI);\n  ctx.lineWidth = 2;\n  ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';\n  ctx.stroke();\n  \n  // Icono según el tipo\n  if (hotspot.type === 'access') {\n    // Flecha de navegación\n    ctx.beginPath();\n    ctx.moveTo(size/2, size/2-15);\n    ctx.lineTo(size/2+12, size/2+5);\n    ctx.lineTo(size/2-12, size/2+5);\n    ctx.closePath();\n    ctx.fillStyle = '#ffffff';\n    ctx.fill();\n    \n    // Punto central\n    ctx.beginPath();\n    ctx.arc(size/2, size/2+8, 3, 0, 2*Math.PI);\n    ctx.fillStyle = '#ffffff';\n    ctx.fill();\n  }\n  \n  const texture = new THREE.CanvasTexture(canvas);\n  const material = new THREE.SpriteMaterial({ \n    map: texture, \n    depthTest: false,\n    transparent: true,\n    opacity: 0.9\n  });\n  const sprite = new THREE.Sprite(material);\n  sprite.scale.set(25, 25, 1);\n  sprite.userData.hotspot = hotspot;\n  if (onClick) sprite.userData.onClick = onClick;\n  return sprite;\n}\n\nfunction isMobileDevice() {\n  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);\n}\n\nfunction TourEditor({ tourId }) {\n  const containerRef = useRef();\n  const [tour, setTour] = useState(null);\n  const [currentSceneIndex, setCurrentSceneIndex] = useState(0);\n  const [selectedHotspot, setSelectedHotspot] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [panelOpen, setPanelOpen] = useState(true);\n  const [pendingHotspot, setPendingHotspot] = useState(null);\n  const [placementMode, setPlacementMode] = useState(false);\n  const [newHotspotPosition, setNewHotspotPosition] = useState(null);\n  const [showHotspotModal, setShowHotspotModal] = useState(false);\n  const navigate = useNavigate();\n  const [fade, setFade] = useState(false);\n  const [pendingSceneIndex, setPendingSceneIndex] = useState(null);\n  const [transitioning, setTransitioning] = useState(false);\n  const [transitionProgress, setTransitionProgress] = useState(0);\n  const [prevTexture, setPrevTexture] = useState(null);\n  const [isMobile, setIsMobile] = useState(false);\n  const [autoRotate, setAutoRotate] = useState(false);\n  const [fullscreen, setFullscreen] = useState(false);\n  const [showSceneSelector, setShowSceneSelector] = useState(false);\n\n  // Referencias de Three.js\n  const sceneRef = useRef();\n  const cameraRef = useRef();\n  const rendererRef = useRef();\n  const controlsRef = useRef();\n  const hotspotSpritesRef = useRef([]);\n  const accessSpheresRef = useRef([]);\n  const animationRef = useRef();\n\n  useEffect(() => {\n    setIsMobile(isMobileDevice());\n  }, []);\n\n  // Navegación con teclado\n  const handleKeyDown = useCallback((event) => {\n    if (!tour || !tour.scenes) return;\n    \n    switch(event.key) {\n      case 'ArrowLeft':\n        event.preventDefault();\n        navigateToScene(currentSceneIndex - 1);\n        break;\n      case 'ArrowRight':\n        event.preventDefault();\n        navigateToScene(currentSceneIndex + 1);\n        break;\n      case ' ':\n        event.preventDefault();\n        setAutoRotate(!autoRotate);\n        break;\n      case 'f':\n        event.preventDefault();\n        toggleFullscreen();\n        break;\n      case 'Escape':\n        if (fullscreen) {\n          toggleFullscreen();\n        }\n        break;\n    }\n  }, [tour, currentSceneIndex, autoRotate, fullscreen]);\n\n  useEffect(() => {\n    document.addEventListener('keydown', handleKeyDown);\n    return () => document.removeEventListener('keydown', handleKeyDown);\n  }, [handleKeyDown]);\n\n  // Navegación entre escenas\n  const navigateToScene = useCallback((index) => {\n    if (!tour || !tour.scenes || index < 0 || index >= tour.scenes.length) return;\n    if (transitioning) return;\n    \n    startTransition(index);\n  }, [tour, transitioning]);\n\n  // Toggle fullscreen\n  const toggleFullscreen = () => {\n    if (!document.fullscreenElement) {\n      containerRef.current?.requestFullscreen();\n      setFullscreen(true);\n    } else {\n      document.exitFullscreen();\n      setFullscreen(false);\n    }\n  };\n\n  // Transición mejorada\n  const startTransition = useCallback((targetIdx) => {\n    if (transitioning) return;\n    \n    const scene = sceneRef.current;\n    const renderer = rendererRef.current;\n    const camera = cameraRef.current;\n    \n    if (!scene || !renderer || !camera) return;\n    \n    // Capturar textura de la escena actual\n    const renderTarget = new THREE.WebGLRenderTarget(\n      renderer.domElement.width,\n      renderer.domElement.height\n    );\n    renderer.setRenderTarget(renderTarget);\n    renderer.render(scene, camera);\n    renderer.setRenderTarget(null);\n    \n    setPrevTexture(renderTarget.texture);\n    setTransitioning(true);\n    setTransitionProgress(0);\n    setPendingSceneIndex(targetIdx);\n    \n    // Animación de transición\n    const startTime = Date.now();\n    const duration = 800;\n    \n    const animateTransition = () => {\n      const elapsed = Date.now() - startTime;\n      const progress = Math.min(elapsed / duration, 1);\n      \n      // Easing suave\n      const easedProgress = 1 - Math.pow(1 - progress, 3);\n      setTransitionProgress(easedProgress);\n      \n      if (progress < 1) {\n        animationRef.current = requestAnimationFrame(animateTransition);\n      } else {\n        // Finalizar transición\n        setCurrentSceneIndex(targetIdx);\n        setTransitioning(false);\n        setPendingSceneIndex(null);\n        setPrevTexture(null);\n        if (renderTarget) {\n          renderTarget.dispose();\n        }\n      }\n    };\n    \n    animationRef.current = requestAnimationFrame(animateTransition);\n  }, [transitioning]);\n\n  // Efecto de vibración en móviles para feedback táctil\n  const triggerHapticFeedback = () => {\n    if (navigator.vibrate && isMobile) {\n      navigator.vibrate(50);\n    }\n  };\n\n  // Navegación con feedback háptico\n  const navigateToSceneWithFeedback = useCallback((index) => {\n    triggerHapticFeedback();\n    navigateToScene(index);\n  }, [navigateToScene]);\n\n  // Cargar tour desde la API\n  useEffect(() => {\n    const fetchTour = async () => {\n      try {\n        const response = await api.getTour(tourId);\n        const tourData = response.data;\n        \n        // Validar y limpiar datos del tour\n        if (tourData && tourData.scenes) {\n          tourData.scenes = tourData.scenes.map((scene, sceneIndex) => {\n            if (scene.hotspots && Array.isArray(scene.hotspots)) {\n              // Limpiar hotspots inválidos\n              scene.hotspots = scene.hotspots.filter(hotspot => {\n                if (!hotspot || typeof hotspot.pitch !== 'number' || typeof hotspot.yaw !== 'number') {\n                  console.warn(`Eliminando hotspot inválido en escena ${sceneIndex}:`, hotspot);\n                  return false;\n                }\n                return true;\n              });\n            }\n            return scene;\n          });\n        }\n        \n        setTour(tourData);\n        setLoading(false);\n        \n        console.log('Tour cargado:', {\n          id: tourData._id,\n          name: tourData.name,\n          scenes: tourData.scenes?.length || 0,\n          totalHotspots: tourData.scenes?.reduce((total, scene) => total + (scene.hotspots?.length || 0), 0) || 0\n        });\n      } catch (err) {\n        setError('Error al cargar el tour');\n        setLoading(false);\n        console.error('Error cargando tour:', err);\n      }\n    };\n    fetchTour();\n  }, [tourId]);\n\n  // Inicializar Three.js\n  useEffect(() => {\n    if (!tour || loading) return;\n\n    // Limpiar canvas anterior si existe\n    if (rendererRef.current && rendererRef.current.domElement && containerRef.current) {\n      if (containerRef.current.contains(rendererRef.current.domElement)) {\n        containerRef.current.removeChild(rendererRef.current.domElement);\n      }\n      rendererRef.current.dispose();\n    }\n\n    // Eliminar cualquier canvas sobrante (por si acaso)\n    if (containerRef.current) {\n      while (containerRef.current.firstChild) {\n        containerRef.current.removeChild(containerRef.current.firstChild);\n      }\n    }\n\n    // Usar el tamaño del contenedor para el renderer\n    const width = containerRef.current.clientWidth || window.innerWidth;\n    const height = containerRef.current.clientHeight || window.innerHeight;\n\n    const scene = new THREE.Scene();\n    const camera = new THREE.PerspectiveCamera(\n      75,\n      width / height,\n      0.1,\n      1000\n    );\n    camera.position.set(0, 0, 0.1);\n\n    const renderer = new THREE.WebGLRenderer({ \n      antialias: true,\n      alpha: true,\n      powerPreference: \"high-performance\",\n      preserveDrawingBuffer: true\n    });\n    renderer.setSize(width, height);\n    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\n    renderer.toneMapping = THREE.ACESFilmicToneMapping;\n    renderer.toneMappingExposure = 1.0;\n    renderer.shadowMap.enabled = true;\n    renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n    renderer.setClearColor(0x181c23, 1); // Fondo oscuro mejorado\n    containerRef.current.appendChild(renderer.domElement);\n\n    const controls = new OrbitControls(camera, renderer.domElement);\n    controls.enableDamping = true;\n    controls.dampingFactor = 0.05;\n    controls.rotateSpeed = -0.5; // INVERTIR dirección de rotación\n    // Soporte de zoom con scroll del mouse\n    controls.enableZoom = true;\n    controls.minDistance = 0.05;\n    controls.maxDistance = 2.5;\n    // Limitar fov para evitar zoom extremo\n    renderer.domElement.addEventListener('wheel', (e) => {\n      e.preventDefault();\n      camera.fov = Math.max(30, Math.min(100, camera.fov + (e.deltaY > 0 ? 2 : -2)));\n      camera.updateProjectionMatrix();\n    }, { passive: false });\n\n    sceneRef.current = scene;\n    cameraRef.current = camera;\n    rendererRef.current = renderer;\n    controlsRef.current = controls;\n\n    let animationId;\n    const animate = () => {\n      animationId = requestAnimationFrame(animate);\n      // Animación de expansión/contracción para esferas access\n      if (accessSpheresRef.current && accessSpheresRef.current.length > 0) {\n        const t = Date.now() * 0.003;\n        accessSpheresRef.current.forEach(sphere => {\n          const scale = 1.1 + 0.15 * Math.sin(t + sphere.position.x);\n          sphere.scale.set(scale, scale, scale);\n        });\n      }\n      controls.update();\n      renderer.render(scene, camera);\n    };\n    animate();\n\n    // Responsivo al tamaño del contenedor\n    const handleResize = () => {\n      if (!containerRef.current) return;\n      const w = containerRef.current.clientWidth || window.innerWidth;\n      const h = containerRef.current.clientHeight || window.innerHeight;\n      camera.aspect = w / h;\n      camera.updateProjectionMatrix();\n      renderer.setSize(w, h);\n    };\n    window.addEventListener('resize', handleResize);\n\n    // Limpieza\n    return () => {\n      window.removeEventListener('resize', handleResize);\n      if (animationId) cancelAnimationFrame(animationId);\n      if (\n        rendererRef.current &&\n        rendererRef.current.domElement &&\n        containerRef.current &&\n        containerRef.current.contains(rendererRef.current.domElement)\n      ) {\n        rendererRef.current.dispose();\n        containerRef.current.removeChild(rendererRef.current.domElement);\n      }\n    };\n  }, [tour, loading]);\n\n  // Cargar la escena current con manejo optimizado de hotspots\n  useEffect(() => {\n    if (\n      !tour ||\n      !sceneRef.current ||\n      !tour.scenes ||\n      !Array.isArray(tour.scenes) ||\n      tour.scenes.length === 0 ||\n      currentSceneIndex === -1 ||\n      !tour.scenes[currentSceneIndex]\n    ) return;\n\n    const scene = sceneRef.current;\n    const currentScene = tour.scenes[currentSceneIndex];\n\n    // Limpiar escena anterior completamente\n    while (scene.children.length > 0) {\n      const child = scene.children[0];\n      // Limpiar recursos de Three.js\n      if (child.geometry) child.geometry.dispose();\n      if (child.material) {\n        if (Array.isArray(child.material)) {\n          child.material.forEach(mat => mat.dispose());\n        } else {\n          child.material.dispose();\n        }\n      }\n      scene.remove(child);\n    }\n    \n    // Limpiar referencias\n    hotspotSpritesRef.current = [];\n    accessSpheresRef.current = [];\n\n    // Crear esfera para la imagen 360 con mayor calidad visual\n    const geometry = new THREE.SphereGeometry(500, 128, 96);\n    geometry.scale(-1, 1, 1);\n\n    const textureLoader = new THREE.TextureLoader();\n    let imageUrl = getAbsoluteImageUrl(currentScene.image);\n\n    textureLoader.load(\n      imageUrl,\n      texture => {\n        texture.minFilter = THREE.LinearFilter;\n        texture.magFilter = THREE.LinearFilter;\n        texture.generateMipmaps = false;\n        texture.anisotropy = rendererRef.current?.capabilities.getMaxAnisotropy() || 1;\n        \n        if (texture.colorSpace !== undefined && THREE.LinearSRGBColorSpace) {\n          texture.colorSpace = THREE.LinearSRGBColorSpace;\n        }\n        \n        const material = new THREE.MeshBasicMaterial({\n          map: texture,\n          side: THREE.DoubleSide\n        });\n        const sphere = new THREE.Mesh(geometry, material);\n        scene.add(sphere);\n\n        // --- Renderizar Hotspots con estado optimizado ---\n        renderHotspotsForScene(currentScene, scene);\n      },\n      undefined,\n      err => {\n        console.error('Error al cargar la textura:', err, imageUrl);\n        const material = new THREE.MeshBasicMaterial({ color: 0x444444, side: THREE.DoubleSide });\n        const sphere = new THREE.Mesh(geometry, material);\n        scene.add(sphere);\n      }\n    );\n  }, [tour, currentSceneIndex]);\n\n  // Función de utilidad para depurar hotspots\n  const debugHotspots = (sceneData, sceneIndex) => {\n    if (!sceneData.hotspots || !Array.isArray(sceneData.hotspots)) {\n      console.log(`Escena ${sceneIndex}: No hay hotspots`);\n      return;\n    }\n    \n    console.log(`Escena ${sceneIndex} (${sceneData.name}):`, {\n      totalHotspots: sceneData.hotspots.length,\n      accessHotspots: sceneData.hotspots.filter(h => h.type === 'access').length,\n      commerceHotspots: sceneData.hotspots.filter(h => h.type === 'commerce').length,\n      locationHotspots: sceneData.hotspots.filter(h => h.type === 'location').length,\n      hotspots: sceneData.hotspots.map((h, i) => ({\n        index: i,\n        type: h.type,\n        pitch: h.pitch,\n        yaw: h.yaw,\n        targetSceneId: h.targetSceneId,\n        title: h.title\n      }))\n    });\n  };\n\n  // Función optimizada para renderizar hotspots\n  const renderHotspotsForScene = (sceneData, threeScene) => {\n    if (!Array.isArray(sceneData.hotspots) || sceneData.hotspots.length === 0) {\n      return;\n    }\n\n    // Validar y limpiar hotspots antes de renderizar\n    const validHotspots = sceneData.hotspots.filter((hotspot, index) => {\n      // Validar que el hotspot tenga las propiedades requeridas\n      if (!hotspot || typeof hotspot.pitch !== 'number' || typeof hotspot.yaw !== 'number') {\n        console.warn(`Hotspot inválido en índice ${index}:`, hotspot);\n        return false;\n      }\n      \n      // Validar que el hotspot de acceso tenga targetSceneId\n      if (hotspot.type === 'access' && !hotspot.targetSceneId) {\n        console.warn(`Hotspot de acceso sin targetSceneId en índice ${index}:`, hotspot);\n        return false;\n      }\n      \n      return true;\n    });\n\n    console.log(`Renderizando ${validHotspots.length} hotspots válidos para la escena ${currentSceneIndex}`);\n    \n    // Depurar hotspots para esta escena\n    debugHotspots(sceneData, currentSceneIndex);\n\n    validHotspots.forEach((hotspot, index) => {\n      try {\n        // Convertir pitch/yaw a coordenadas cartesianas\n        const radius = 500;\n        const phi = THREE.MathUtils.degToRad(90 - hotspot.pitch);\n        const theta = THREE.MathUtils.degToRad(hotspot.yaw);\n        const x = radius * Math.sin(phi) * Math.sin(theta);\n        const y = radius * Math.cos(phi);\n        const z = radius * Math.sin(phi) * Math.cos(theta);\n\n        let obj3d;\n        \n        if (hotspot.type === 'access') {\n          // Esfera 3D para access con mejor visualización\n          const geometry = new THREE.SphereGeometry(12, 32, 32);\n          const material = new THREE.MeshStandardMaterial({ \n            color: 0x38bdf8, \n            emissive: 0x0ea5e9, \n            metalness: 0.3, \n            roughness: 0.5 \n          });\n          obj3d = new THREE.Mesh(geometry, material);\n          \n          // Agregar información adicional al hotspot para mejor navegación\n          obj3d.userData.hotspot = { \n            ...hotspot, \n            sceneIndex: currentSceneIndex,\n            sceneName: sceneData.name\n          };\n          obj3d.userData.isAccessHotspot = true;\n          obj3d.userData.hotspotIndex = index;\n          accessSpheresRef.current.push(obj3d);\n        } else {\n          // Sprite para otros tipos con mejor diseño\n          const size = 64;\n          const canvas = document.createElement('canvas');\n          canvas.width = size;\n          canvas.height = size;\n          const ctx = canvas.getContext('2d');\n          \n          // Fondo con gradiente\n          const gradient = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);\n          gradient.addColorStop(0, '#38bdf8');\n          gradient.addColorStop(1, '#0ea5e9');\n          ctx.fillStyle = gradient;\n          ctx.beginPath();\n          ctx.arc(size/2, size/2, size/2-4, 0, 2*Math.PI);\n          ctx.fill();\n          \n          // Borde blanco\n          ctx.lineWidth = 4;\n          ctx.strokeStyle = '#fff';\n          ctx.stroke();\n          \n          // Sombra\n          ctx.shadowColor = '#0ea5e9';\n          ctx.shadowBlur = 8;\n          \n          const texture = new THREE.CanvasTexture(canvas);\n          const material = new THREE.SpriteMaterial({ \n            map: texture, \n            depthTest: false,\n            transparent: true\n          });\n          obj3d = new THREE.Sprite(material);\n          obj3d.scale.set(20, 20, 1);\n          obj3d.userData.hotspot = { \n            ...hotspot, \n            sceneIndex: currentSceneIndex,\n            sceneName: sceneData.name\n          };\n          obj3d.userData.hotspotIndex = index;\n        }\n        \n        obj3d.position.set(x, y, z);\n        threeScene.add(obj3d);\n        hotspotSpritesRef.current.push(obj3d);\n        \n      } catch (error) {\n        console.error('Error renderizando hotspot:', error, hotspot);\n      }\n    });\n  };\n\n  // --- Detección de clics en hotspots optimizada ---\n  useEffect(() => {\n    if (!rendererRef.current || !cameraRef.current || !sceneRef.current || !tour) return;\n    \n    const dom = rendererRef.current.domElement;\n    let lastClickTime = 0;\n    \n    // Función optimizada para navegar a hotspots de acceso\n    const doubleClickNavigateToAccessHotspot = (hotspot) => {\n      if (!hotspot || hotspot.type !== 'access' || !hotspot.targetSceneId) {\n        console.log('Hotspot inválido para navegación:', hotspot);\n        return;\n      }\n      \n      // Buscar la escena destino usando diferentes métodos de comparación\n      let targetIdx = -1;\n      \n      // Método 1: Comparación directa de IDs\n      targetIdx = tour.scenes.findIndex(s => String(s._id) === String(hotspot.targetSceneId));\n      \n      // Método 2: Si no se encuentra, buscar por índice (fallback)\n      if (targetIdx === -1 && typeof hotspot.targetSceneId === 'number') {\n        targetIdx = hotspot.targetSceneId;\n      }\n      \n      // Método 3: Buscar por nombre de escena (fallback adicional)\n      if (targetIdx === -1 && hotspot.targetSceneName) {\n        targetIdx = tour.scenes.findIndex(s => s.name === hotspot.targetSceneName);\n      }\n      \n      if (targetIdx !== -1 && targetIdx < tour.scenes.length) {\n        console.log(`Navegando de escena ${currentSceneIndex} a escena ${targetIdx}`);\n        startTransition(targetIdx);\n      } else {\n        console.error('Escena destino no encontrada:', {\n          targetSceneId: hotspot.targetSceneId,\n          availableScenes: tour.scenes.map((s, i) => ({ index: i, id: s._id, name: s.name }))\n        });\n      }\n    };\n    \n    // Función optimizada para manejar clics en hotspots\n    function onPointerDown(event) {\n      // Solo click izquierdo\n      if (event.button !== 0) return;\n      \n      const rect = dom.getBoundingClientRect();\n      const mouse = new THREE.Vector2(\n        ((event.clientX - rect.left) / rect.width) * 2 - 1,\n        -((event.clientY - rect.top) / rect.height) * 2 + 1\n      );\n      \n      const raycaster = new THREE.Raycaster();\n      raycaster.setFromCamera(mouse, cameraRef.current);\n      \n      // Usar todos los objetos de la escena actual para detectar hotspots\n      const intersects = raycaster.intersectObjects(sceneRef.current.children, true);\n      \n      if (intersects.length > 0) {\n        const obj = intersects[0].object;\n        const now = Date.now();\n        \n        // Verificar si es un hotspot\n        if (obj.userData && obj.userData.hotspot) {\n          const hotspot = obj.userData.hotspot;\n          \n          if (obj.userData.isAccessHotspot) {\n            if (now - lastClickTime < 400) { // doble click\n              console.log('Doble clic en hotspot de acceso:', hotspot);\n              doubleClickNavigateToAccessHotspot(hotspot);\n            }\n            lastClickTime = now;\n          } else {\n            console.log('Clic en hotspot informativo:', hotspot);\n            setSelectedHotspot(hotspot);\n          }\n        }\n      }\n    }\n    \n    dom.addEventListener('pointerdown', onPointerDown);\n    \n    return () => {\n      dom.removeEventListener('pointerdown', onPointerDown);\n    };\n  }, [tour, currentSceneIndex, hotspotSpritesRef.current]);\n\n  // Animación de transición optimizada\n  useEffect(() => {\n    if (!transitioning) return;\n    let frame;\n    function animate() {\n      setTransitionProgress(prev => {\n        const next = Math.min(prev + 0.04, 1);\n        if (next < 1) {\n          frame = requestAnimationFrame(animate);\n        } else {\n          setTransitioning(false);\n          setPrevTexture(null);\n          setCurrentSceneIndex(pendingSceneIndex);\n        }\n        return next;\n      });\n    }\n    animate();\n    return () => cancelAnimationFrame(frame);\n  }, [transitioning]);\n\n  // Modificar render de la escena para usar el shader durante la transición\n  useEffect(() => {\n    if (!sceneRef.current || !rendererRef.current || !cameraRef.current) return;\n    if (!transitioning || !prevTexture) return;\n    // Crear geometría y materiales\n    const geometry = new THREE.SphereGeometry(500, 128, 96);\n    geometry.scale(-1, 1, 1);\n    const currentScene = tour.scenes[pendingSceneIndex];\n    const loader = new THREE.TextureLoader();\n    loader.load(getAbsoluteImageUrl(currentScene.image), nextTexture => {\n      // Material de transición\n      const material = RadialFadeMaterial(prevTexture, nextTexture, transitionProgress);\n      const sphere = new THREE.Mesh(geometry, material);\n      sceneRef.current.add(sphere);\n      // Render loop\n      function renderTransition() {\n        material.uniforms.uProgress.value = transitionProgress;\n        rendererRef.current.render(sceneRef.current, cameraRef.current);\n        if (transitioning) requestAnimationFrame(renderTransition);\n        else sceneRef.current.remove(sphere);\n      }\n      renderTransition();\n    });\n  }, [transitioning, transitionProgress]);\n\n  // Cuando cambia la escena, hacer fade out y zoom out\n  useEffect(() => {\n    if (pendingSceneIndex === null) return;\n    // Animar FOV (zoom out) y quitar fade\n    const camera = cameraRef.current;\n    if (!camera) return;\n    let startFov = camera.fov;\n    let endFov = 75;\n    let duration = 400;\n    let start = null;\n    function animateZoomOut(ts) {\n      if (!start) start = ts;\n      let progress = Math.min((ts - start) / duration, 1);\n      camera.fov = startFov + (endFov - startFov) * progress;\n      camera.updateProjectionMatrix();\n      if (progress < 1) {\n        requestAnimationFrame(animateZoomOut);\n      } else {\n        setFade(false);\n        setPendingSceneIndex(null);\n      }\n    }\n    setTimeout(() => {\n      requestAnimationFrame(animateZoomOut);\n    }, 250);\n  }, [currentSceneIndex]);\n\n  // Manejar subida de imágenes\n  const handleImageUpload = async (e) => {\n    let files = [];\n    if (e.target && e.target.files && e.target.files.length > 0) {\n      files = Array.from(e.target.files);\n    } else if (e instanceof File) {\n      files = [e];\n    } else if (Array.isArray(e)) {\n      files = e;\n    }\n    if (!files.length) return;\n    for (const file of files) {\n      try {\n        let uploadRes = await api.uploadImage(file);\n        let imageUrl = uploadRes.data?.imageUrl || uploadRes.imageUrl;\n        if (!imageUrl) {\n          throw new Error('No se recibió la URL de la imagen');\n        }\n        const newScene = {\n          name: `Escena ${tour.scenes.length + 1}`,\n          image: imageUrl,\n          hotspots: []\n        };\n        const updatedTour = {\n          ...tour,\n          scenes: [...tour.scenes, newScene]\n        };\n        const savedTour = await api.updateTour(tourId, updatedTour);\n        setTour(savedTour.data ? savedTour.data : savedTour);\n        setCurrentSceneIndex(updatedTour.scenes.length - 1);\n      } catch (err) {\n        console.error('Error subiendo imagen:', err);\n        alert(`Error al subir imagen: ${err.error || err.message || 'Intente nuevamente'}`);\n      }\n    }\n  };\n\n  // Manejar subida de imágenes (DragDrop)\n  const handleDragDropImage = async (files) => {\n    if (Array.isArray(files)) {\n      for (const file of files) {\n        await handleImageUpload(file);\n      }\n    } else {\n      await handleImageUpload(files);\n    }\n  };\n\n  // Guardar hotspot optimizado\n  const handleSaveHotspot = async (hotspotData) => {\n    try {\n      console.log('Guardando hotspot:', hotspotData);\n      \n      const updatedScenes = [...tour.scenes];\n      const currentScene = updatedScenes[currentSceneIndex];\n\n      if (hotspotData._id) {\n        // Actualizar hotspot existente\n        const index = currentScene.hotspots.findIndex(h => h._id === hotspotData._id);\n        if (index !== -1) {\n          currentScene.hotspots[index] = {\n            ...currentScene.hotspots[index],\n            ...hotspotData\n          };\n        }\n      } else {\n        // Crear nuevo hotspot\n        const newHotspot = {\n          ...hotspotData,\n          _id: Date.now().toString()\n        };\n        currentScene.hotspots.push(newHotspot);\n      }\n\n      const updatedTour = { ...tour, scenes: updatedScenes };\n      setTour(updatedTour);\n      \n      // Guardar en el backend\n      await api.updateTour(tourId, updatedTour);\n      \n      // Recargar el tour desde la API para asegurar sincronización\n      const response = await api.getTour(tourId);\n      const refreshedTour = response.data ? response.data : response;\n      setTour(refreshedTour);\n      \n      // Limpiar estados\n      setSelectedHotspot(null);\n      setPlacementMode(false);\n      \n      console.log('Hotspot guardado exitosamente');\n    } catch (err) {\n      console.error('Error guardando hotspot:', err);\n      alert(`Error al guardar: ${err.error || 'Intente nuevamente'}`);\n    }\n  };\n\n  // Nuevo: Guardar hotspot con pitch/yaw del click\n  const handleSaveHotspotWithCoords = (hotspotData) => {\n    handleSaveHotspot({\n      ...hotspotData,\n      pitch: pendingHotspot?.pitch ?? hotspotData.pitch,\n      yaw: pendingHotspot?.yaw ?? hotspotData.yaw\n    });\n    setPendingHotspot(null);\n  };\n\n  // Efecto unificado para manejar el modo de colocación de hotspots\n  useEffect(() => {\n    if (!rendererRef.current || !sceneRef.current || !cameraRef.current) return;\n\n    const dom = rendererRef.current.domElement;\n\n    if (placementMode) {\n      dom.style.cursor = 'crosshair';\n      // Elimina overlay visual, solo usa cursor\n      // El handler de click está en el canvas principal (ver más abajo)\n    } else {\n      dom.style.cursor = '';\n    }\n  }, [placementMode, rendererRef, sceneRef, cameraRef]);\n\n  // Nuevo: Manejar click en la escena para colocar hotspot\n  const handleSceneClick = (event) => {\n    if (!placementMode) return;\n    // Obtener coordenadas del ratón normalizadas\n    const mouse = new THREE.Vector2();\n    const rect = containerRef.current.getBoundingClientRect();\n    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;\n    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n\n    const raycaster = new THREE.Raycaster();\n    raycaster.setFromCamera(mouse, cameraRef.current);\n\n    // Intersectar con la esfera (único mesh en la escena)\n    const intersects = raycaster.intersectObjects(sceneRef.current.children);\n    if (intersects.length > 0) {\n      const point = intersects[0].point;\n      const radius = 500;\n      const phi = Math.acos(point.y / radius);\n      const theta = Math.atan2(point.x, point.z); // x primero, z segundo\n      const pitch = 90 - THREE.MathUtils.radToDeg(phi);\n      const yaw = THREE.MathUtils.radToDeg(theta);\n      setNewHotspotPosition({ pitch, yaw });\n      setShowHotspotModal(true);\n      setPlacementMode(false);\n    }\n  };\n\n  // Guardar el nuevo hotspot usando el endpoint REST optimizado\n  const saveNewHotspot = async (hotspotData) => {\n    try {\n      console.log('Guardando nuevo hotspot:', hotspotData);\n      \n      if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) {\n        throw new Error('Tour o escena no disponible');\n      }\n      \n      const sceneId = tour.scenes[currentSceneIndex]._id;\n      const response = await api.addHotspot(tour._id, sceneId, hotspotData);\n      \n      // Obtener el hotspot creado\n      const newHotspot = response.data ? response.data : response;\n      console.log('Hotspot creado en backend:', newHotspot);\n      \n      // Actualizar el estado local\n      const updatedTour = { ...tour };\n      updatedTour.scenes = [...updatedTour.scenes];\n      const scene = updatedTour.scenes[currentSceneIndex];\n      scene.hotspots = [...scene.hotspots, newHotspot];\n      setTour(updatedTour);\n      \n      // Limpiar estados\n      setShowHotspotModal(false);\n      setNewHotspotPosition(null);\n      setPlacementMode(false);\n      \n      // Recargar el tour desde la API para asegurar sincronización completa\n      const refreshed = await api.getTour(tourId);\n      const refreshedTour = refreshed.data ? refreshed.data : refreshed;\n      setTour(refreshedTour);\n      \n      console.log('Nuevo hotspot guardado exitosamente');\n    } catch (error) {\n      console.error('Error al guardar el hotspot:', error);\n      alert(`Error al guardar el hotspot: ${error.message || 'Intente nuevamente'}`);\n      setShowHotspotModal(false);\n      setNewHotspotPosition(null);\n      setPlacementMode(false);\n    }\n  };\n\n  // Reemplaza la función handleDeleteScene global para aceptar el índice de la escena a eliminar\n  useEffect(() => {\n    window.handleDeleteScene = async (deleteIdx) => {\n      if (!tour || !tour.scenes || tour.scenes.length <= 1) return;\n      const updatedScenes = tour.scenes.filter((_, idx) => idx !== deleteIdx);\n      let newIndex = currentSceneIndex;\n      if (deleteIdx === currentSceneIndex) {\n        newIndex = deleteIdx === 0 ? 0 : deleteIdx - 1;\n      } else if (deleteIdx < currentSceneIndex) {\n        newIndex = currentSceneIndex - 1;\n      }\n      const updatedTour = { ...tour, scenes: updatedScenes };\n      setTour(updatedTour);\n      setCurrentSceneIndex(newIndex);\n      await api.updateTour(tour._id, updatedTour);\n    };\n    return () => { window.handleDeleteScene = undefined; };\n  }, [tour, currentSceneIndex]);\n\n  // 1. Función para eliminar hotspot de la escena actual\n  const handleDeleteHotspot = async (hotspotIdx) => {\n    if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) return;\n    const updatedScenes = [...tour.scenes];\n    const scene = { ...updatedScenes[currentSceneIndex] };\n    scene.hotspots = scene.hotspots.filter((_, idx) => idx !== hotspotIdx);\n    updatedScenes[currentSceneIndex] = scene;\n    const updatedTour = { ...tour, scenes: updatedScenes };\n    setTour(updatedTour);\n    await api.updateTour(tour._id, updatedTour);\n  };\n\n  // --- GIROSCOPIO: Lógica de activación y manejo estilo YouTube 360 ---\n  useEffect(() => {\n    if (!isMobileDevice() || !cameraRef.current || !controlsRef.current) return;\n\n    // Habilitar/deshabilitar OrbitControls según el estado del giroscopio\n    controlsRef.current.enabled = true;\n\n    let lastAlpha = 0, lastBeta = 0, lastGamma = 0;\n    let smoothAlpha = 0, smoothBeta = 0, smoothGamma = 0;\n    const smoothFactor = 0.15;\n\n    function getScreenOrientation() {\n      if (window.screen.orientation && window.screen.orientation.angle !== undefined) {\n        return window.screen.orientation.angle;\n      }\n      return window.orientation || 0;\n    }\n\n    function handleOrientation(event) {\n      let alpha = event.alpha || 0;\n      let beta = event.beta || 0;\n      let gamma = event.gamma || 0;\n\n      // INVERTIR alpha para invertir la rotación horizontal\n      alpha = -alpha;\n\n      smoothAlpha = smoothAlpha * (1 - smoothFactor) + alpha * smoothFactor;\n      smoothBeta = smoothBeta * (1 - smoothFactor) + beta * smoothFactor;\n      smoothGamma = smoothGamma * (1 - smoothFactor) + gamma * smoothFactor;\n\n      const _alpha = THREE.MathUtils.degToRad(smoothAlpha);\n      const _beta = THREE.MathUtils.degToRad(smoothBeta);\n      const _gamma = THREE.MathUtils.degToRad(smoothGamma);\n\n      const orient = getScreenOrientation();\n      const orientRad = THREE.MathUtils.degToRad(orient);\n\n      const zee = new THREE.Vector3(0, 0, 1);\n      const euler = new THREE.Euler();\n      const q0 = new THREE.Quaternion();\n      const q1 = new THREE.Quaternion(-Math.sqrt(0.5), 0, 0, Math.sqrt(0.5));\n\n      euler.set(_beta, _alpha, -_gamma, 'YXZ');\n      let quaternion = new THREE.Quaternion().setFromEuler(euler);\n      quaternion.multiply(q1);\n      quaternion.multiply(q0.setFromAxisAngle(zee, -orientRad));\n\n      cameraRef.current.quaternion.copy(quaternion);\n    }\n\n    window.addEventListener('deviceorientation', handleOrientation, true);\n\n    const handleScreenOrientation = () => {\n      smoothAlpha = lastAlpha;\n      smoothBeta = lastBeta;\n      smoothGamma = lastGamma;\n    };\n    window.addEventListener('orientationchange', handleScreenOrientation);\n\n    return () => {\n      window.removeEventListener('deviceorientation', handleOrientation, true);\n      window.removeEventListener('orientationchange', handleScreenOrientation);\n      // Rehabilitar OrbitControls al salir del modo giroscopio\n      if (controlsRef.current) controlsRef.current.enabled = true;\n    };\n  }, []);\n\n  if (loading) {\n    return <div className=\"loading\">Cargando tour...</div>;\n  }\n\n  if (error) {\n    return <div className=\"error\">{error}</div>;\n  }\n\n  // Si no hay escenas, muestra mensaje amigable y área de drag & drop\n  if (!tour.scenes || tour.scenes.length === 0) {\n    return (\n      <div className=\"tour-editor\">\n        <div ref={containerRef} className=\"three-container\" />\n        <ControlPanel\n          open={panelOpen}\n          setOpen={setPanelOpen}\n          tour={tour}\n          handleDragDropImage={handleDragDropImage}\n          handleImageUpload={handleImageUpload}\n          scenes={[]}\n          placementMode={placementMode}\n          setPlacementMode={setPlacementMode}\n          onReturn={() => navigate('/hub')}\n          handleDeleteHotspot={handleDeleteHotspot}\n        />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"tour-editor\">\n      <div\n        ref={containerRef}\n        className=\"three-container\"\n        onClick={handleSceneClick}\n      />\n      <div className={`fade-overlay${fade ? ' visible' : ''}`}></div>\n      \n      {/* Controles principales */}\n      <div className=\"viewer-controls\">\n        <button className=\"btn-return\" onClick={() => navigate('/hub')}>\n          ← Volver al Hub\n        </button>\n        \n        <div className=\"control-buttons\">\n          <button \n            className={`control-btn ${autoRotate ? 'active' : ''}`}\n            onClick={() => setAutoRotate(!autoRotate)}\n            title=\"Rotación automática (Espacio)\"\n          >\n            🔄\n          </button>\n          \n          <button \n            className=\"control-btn\"\n            onClick={toggleFullscreen}\n            title=\"Pantalla completa (F)\"\n          >\n            {fullscreen ? '⛶' : '⛶'}\n          </button>\n          \n          <button \n            className={`control-btn ${showSceneSelector ? 'active' : ''}`}\n            onClick={() => setShowSceneSelector(!showSceneSelector)}\n            title=\"Selector de escenas\"\n          >\n            📋\n          </button>\n        </div>\n      </div>\n      \n      {/* Selector de escenas */}\n      {showSceneSelector && (\n        <div className=\"scene-selector\">\n          {tour.scenes.map((scene, index) => (\n            <button\n              key={scene._id}\n              className={`scene-btn ${index === currentSceneIndex ? 'active' : ''}`}\n              onClick={() => navigateToSceneWithFeedback(index)}\n              disabled={transitioning}\n            >\n              {index + 1}\n            </button>\n          ))}\n        </div>\n      )}\n      \n      {/* Navegación con flechas */}\n      <div className=\"navigation-arrows\">\n        <button \n          className=\"nav-arrow left\"\n          onClick={() => navigateToSceneWithFeedback(currentSceneIndex - 1)}\n          disabled={currentSceneIndex === 0 || transitioning}\n        >\n          ‹\n        </button>\n        <button \n          className=\"nav-arrow right\"\n          onClick={() => navigateToSceneWithFeedback(currentSceneIndex + 1)}\n          disabled={currentSceneIndex === tour.scenes.length - 1 || transitioning}\n        >\n          ›\n        </button>\n      </div>\n      \n      {/* Información de la escena actual */}\n      <div className=\"scene-info\">\n        <div className=\"scene-title\">\n          {tour.scenes[currentSceneIndex]?.title || `Escena ${currentSceneIndex + 1}`}\n        </div>\n        <div className=\"scene-description\">\n          {tour.scenes[currentSceneIndex]?.description || 'Editor de tour 360°'}\n        </div>\n      </div>\n      \n      {/* Indicador de progreso */}\n      <div className=\"progress-indicator\">\n        <div className=\"progress-bar\">\n          <div \n            className=\"progress-fill\"\n            style={{ width: `${((currentSceneIndex + 1) / tour.scenes.length) * 100}%` }}\n          ></div>\n        </div>\n        <span className=\"progress-text\">\n          {currentSceneIndex + 1} / {tour.scenes.length}\n        </span>\n      </div>\n      \n      {/* Instrucciones */}\n      <div className=\"instructions\">\n        <p>Usa las flechas del teclado para navegar • Espacio para rotación automática • F para pantalla completa</p>\n      </div>\n      <ControlPanel\n        open={panelOpen}\n        setOpen={setPanelOpen}\n        tour={tour}\n        handleDragDropImage={handleDragDropImage}\n        handleImageUpload={handleImageUpload}\n        scenes={tour.scenes}\n        currentSceneIndex={currentSceneIndex}\n        setCurrentSceneIndex={setCurrentSceneIndex}\n        placementMode={placementMode}\n        setPlacementMode={setPlacementMode}\n        onReturn={() => navigate('/hub')}\n        handleDeleteHotspot={handleDeleteHotspot}\n      />\n      {(selectedHotspot || pendingHotspot) && (\n        <HotspotEditor\n          hotspot={selectedHotspot || { pitch: pendingHotspot?.pitch, yaw: pendingHotspot?.yaw }}\n          scenes={tour.scenes}\n          onSave={pendingHotspot ? handleSaveHotspotWithCoords : handleSaveHotspot}\n          onCancel={() => {\n            setSelectedHotspot(null);\n            setPlacementMode(false);\n            setPendingHotspot(null);\n          }}\n        />\n      )}\n      {showHotspotModal && newHotspotPosition && (\n        <HotspotCreationModal\n          position={newHotspotPosition}\n          tour={tour}\n          currentSceneIndex={currentSceneIndex}\n          onSave={saveNewHotspot}\n          onCancel={() => {\n            setShowHotspotModal(false);\n            setNewHotspotPosition(null);\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\n// Panel lateral plegable\nfunction ControlPanel({\n  open,\n  setOpen,\n  tour,\n  handleDragDropImage,\n  handleImageUpload,\n  scenes,\n  currentSceneIndex,\n  setCurrentSceneIndex,\n  placementMode,\n  setPlacementMode,\n  onReturn,\n  handleDeleteHotspot\n}) {\n  return (\n    <>\n      <aside className={`editor-panel${open ? ' open' : ''}`}>\n        <div className=\"panel-header\">\n          <span className=\"panel-title\">Tour Virtual 360°</span>\n          <button className=\"panel-toggle\" onClick={() => setOpen(!open)}>\n            {open ? <>&#10094;</> : <>&#10095;</>}\n          </button>\n        </div>\n        {open && (\n          <div className=\"panel-content\">\n            <button\n              className=\"btn-return-hub\"\n              onClick={onReturn}\n              style={{\n                background: '#23272f',\n                color: '#38bdf8',\n                border: 'none',\n                borderRadius: 8,\n                padding: '10px 0',\n                fontSize: '1rem',\n                fontWeight: 500,\n                marginBottom: 18,\n                cursor: 'pointer',\n                width: '100%',\n                transition: 'background 0.2s, color 0.2s'\n              }}\n            >\n              ← Volver al Hub\n            </button>\n            <ApiKeyManager tourId={tour._id} initialApiKey={tour.apiKey} />\n            <div className=\"panel-section\">\n              <h3>Imágenes 360°</h3>\n              <DragDrop onFileUpload={handleDragDropImage} />\n              <div className=\"panel-dragdrop-hint\">o haz clic para seleccionar</div>\n              <input\n                type=\"file\"\n                id=\"image-upload\"\n                accept=\"image/*\"\n                onChange={handleImageUpload}\n                style={{ display: 'none' }}\n              />\n            </div>\n            <div className=\"panel-section\">\n              <h3>Imágenes Cargadas ({scenes.length})</h3>\n              {scenes.length === 0 ? (\n                <div className=\"panel-empty\">No hay imágenes cargadas</div>\n              ) : (\n                <ul className=\"panel-image-list\">\n                  {scenes.map((scene, idx) => (\n                    <li\n                      key={scene._id || idx}\n                      className={`panel-image-item${currentSceneIndex === idx ? ' active' : ''}`}\n                      style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}\n                    >\n                      <div style={{ display: 'flex', alignItems: 'center', flex: 1, cursor: 'pointer' }} onClick={() => setCurrentSceneIndex && setCurrentSceneIndex(idx)}>\n                        <img src={scene.image ? getAbsoluteImageUrl(scene.image) : ''} alt={scene.name} />\n                        <span>{scene.name}</span>\n                      </div>\n                      {scenes.length > 1 && (\n                        <button\n                          className=\"btn-delete-scene\"\n                          style={{ background: 'transparent', color: '#ef4444', border: 'none', marginLeft: 8, fontSize: 20, cursor: 'pointer' }}\n                          title=\"Eliminar escena\"\n                          onClick={e => {\n                            e.stopPropagation();\n                            if (window.confirm('¿Seguro que deseas eliminar esta escena?')) {\n                              if (typeof window.handleDeleteScene === 'function') window.handleDeleteScene(idx);\n                            }\n                          }}\n                        >\n                          🗑️\n                        </button>\n                      )}\n                    </li>\n                  ))}\n                </ul>\n              )}\n            </div>\n            <div className=\"panel-section\">\n              <h3>Hotspots de la Escena ({scenes[currentSceneIndex]?.hotspots?.length || 0})</h3>\n              <div className=\"hotspot-controls\" style={{marginBottom: 15}}>\n                <button\n                  className=\"btn-add-hotspot\"\n                  onClick={() => setPlacementMode(true)}\n                  title=\"Haz clic para activar el modo de colocación de hotspots. Luego haz clic en la imagen 360° donde quieras colocar el hotspot.\"\n                  style={{\n                    background: '#38bdf8',\n                    color: '#fff',\n                    border: 'none',\n                    borderRadius: 8,\n                    padding: '10px 16px',\n                    fontSize: '14px',\n                    fontWeight: 500,\n                    cursor: 'pointer',\n                    width: '100%',\n                    transition: 'background 0.2s',\n                    display: 'flex',\n                    alignItems: 'center',\n                    justifyContent: 'center',\n                    gap: 8,\n                    position: 'relative'\n                  }}\n                  onMouseEnter={(e) => e.target.style.background = '#0ea5e9'}\n                  onMouseLeave={(e) => e.target.style.background = '#38bdf8'}\n                >\n                  <span style={{fontSize: '16px'}}>📍</span>\n                  Agregar Hotspot\n                </button>\n                {placementMode && (\n                  <div className=\"placement-mode-indicator\">\n                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>\n                      <strong>Modo de colocación activado</strong>\n                      <button\n                        onClick={() => setPlacementMode(false)}\n                        style={{\n                          background: 'transparent',\n                          border: '1px solid #ef4444',\n                          color: '#ef4444',\n                          borderRadius: 4,\n                          padding: '4px 8px',\n                          fontSize: '11px',\n                          cursor: 'pointer',\n                          transition: 'all 0.2s'\n                        }}\n                        onMouseEnter={(e) => {\n                          e.target.style.background = '#ef4444';\n                          e.target.style.color = '#fff';\n                        }}\n                        onMouseLeave={(e) => {\n                          e.target.style.background = 'transparent';\n                          e.target.style.color = '#ef4444';\n                        }}\n                      >\n                        Cancelar\n                      </button>\n                    </div>\n                    Haz clic en la imagen 360° para colocar el hotspot\n                  </div>\n                )}\n              </div>\n              {scenes[currentSceneIndex]?.hotspots?.length === 0 ? (\n                <div style={{\n                  background: '#1e293b',\n                  border: '1px dashed #334155',\n                  borderRadius: 6,\n                  padding: '20px',\n                  textAlign: 'center',\n                  color: '#64748b',\n                  fontSize: '14px'\n                }}>\n                  <div style={{fontSize: '24px', marginBottom: '8px'}}>📍</div>\n                  No hay hotspots en esta escena\n                  <div style={{fontSize: '12px', marginTop: '4px'}}>\n                    Haz clic en \"Agregar Hotspot\" para comenzar\n                  </div>\n                </div>\n              ) : (\n                <>\n                  {/* Resumen de tipos de hotspots */}\n                  <div style={{\n                    background: '#1e293b',\n                    border: '1px solid #334155',\n                    borderRadius: 6,\n                    padding: '8px 12px',\n                    marginBottom: '12px',\n                    fontSize: '12px',\n                    color: '#94a3b8'\n                  }}>\n                    {(() => {\n                      const hotspots = scenes[currentSceneIndex].hotspots;\n                      const types = {\n                        access: hotspots.filter(h => h.type === 'access').length,\n                        commerce: hotspots.filter(h => h.type === 'commerce').length,\n                        location: hotspots.filter(h => h.type === 'location').length\n                      };\n                      return (\n                        <div style={{display: 'flex', justifyContent: 'space-between'}}>\n                          <span>📍 Acceso: {types.access}</span>\n                          <span>🏪 Comercio: {types.commerce}</span>\n                          <span>📍 Locación: {types.location}</span>\n                        </div>\n                      );\n                    })()}\n                  </div>\n                  <ul className=\"panel-hotspot-list\">\n                    {scenes[currentSceneIndex].hotspots.map((hotspot, idx) => {\n                      let accessInfo = null;\n                      if (hotspot.type === 'access' && hotspot.targetSceneId) {\n                        const target = scenes.find(s => String(s._id) === String(hotspot.targetSceneId));\n                        accessInfo = target ? `→ ${target.name}` : '→ [Escena no encontrada]';\n                      }\n                      return (\n                        <li key={hotspot._id || idx} style={{display:'flex',alignItems:'center',justifyContent:'space-between',gap:8}}>\n                          <span>\n                            {hotspot.type === 'access' ? 'Punto de Acceso' : (hotspot.title || 'Hotspot')}\n                            {accessInfo && <span style={{color:'#38bdf8',marginLeft:8,fontSize:13}}>{accessInfo}</span>}\n                          </span>\n                          <button style={{background:'transparent',color:'#ef4444',border:'none',fontSize:18,cursor:'pointer'}} title=\"Eliminar hotspot\" onClick={()=>{if(window.confirm('¿Eliminar este hotspot?'))handleDeleteHotspot(idx)}}>🗑️</button>\n                        </li>\n                      );\n                    })}\n                  </ul>\n                </>\n              )}\n            </div>\n            <div className=\"panel-section panel-hint\">\n              <p><strong>Tipos de Hotspots:</strong></p>\n              <ul style={{margin: '8px 0', paddingLeft: '20px', fontSize: '13px'}}>\n                <li><strong>📍 Acceso:</strong> Navega a otra escena del tour</li>\n                <li><strong>🏪 Comercio:</strong> Muestra información de un negocio</li>\n                <li><strong>📍 Locación:</strong> Muestra información de un lugar</li>\n              </ul>\n              <p style={{marginTop: '12px', fontSize: '13px'}}>\n                <strong>Controles:</strong><br/>\n                • Haz doble clic en hotspots de acceso para navegar<br/>\n                • Haz clic en hotspots para ver/editar información\n              </p>\n            </div>\n          </div>\n        )}\n      </aside>\n      <div className={`editor-backdrop${open ? ' open' : ''}`} onClick={() => setOpen(false)} />\n    </>\n  );\n}\n\nexport default TourEditor;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}