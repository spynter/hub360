{"ast":null,"code":"var _jsxFileName = \"D:\\\\respaldo jose\\\\PROJECTS_V0\\\\hub360\\\\frontend\\\\src\\\\components\\\\Editor\\\\TourEditor.js\",\n  _s = $RefreshSig$();\nimport React, { useRef, useEffect, useState } from 'react';\nimport * as THREE from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';\nimport HotspotEditor from './HotspotEditor';\nimport api from '../../services/api';\nimport DragDrop from './DragDrop';\nimport { useNavigate } from 'react-router-dom';\nimport './TourEditor.css';\nimport ApiKeyManager from './ApiKeyManager';\nimport HotspotCreationModal from './HotspotCreationModal';\nimport RadialFadeMaterial from '../shaders/RadialFadeMaterial';\n\n// Utilidad para obtener la URL absoluta de la imagen\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nfunction getAbsoluteImageUrl(image) {\n  if (!image) return '';\n  if (image.startsWith('/uploads/')) {\n    var _process$env$REACT_AP;\n    return `${((_process$env$REACT_AP = process.env.REACT_APP_API_URL) === null || _process$env$REACT_AP === void 0 ? void 0 : _process$env$REACT_AP.replace('/api', '')) || 'http://localhost:5000'}${image}`;\n  }\n  return image;\n}\nfunction createHotspotSprite(hotspot, onClick) {\n  // Crear un canvas para el ícono visual\n  const size = 64;\n  const canvas = document.createElement('canvas');\n  canvas.width = size;\n  canvas.height = size;\n  const ctx = canvas.getContext('2d');\n  // Círculo azul claro\n  ctx.beginPath();\n  ctx.arc(size / 2, size / 2, size / 2 - 4, 0, 2 * Math.PI);\n  ctx.fillStyle = '#38bdf8';\n  ctx.shadowColor = '#0ea5e9';\n  ctx.shadowBlur = 8;\n  ctx.fill();\n  ctx.lineWidth = 4;\n  ctx.strokeStyle = '#fff';\n  ctx.stroke();\n  // Icono de flecha si es access\n  if (hotspot.type === 'access') {\n    ctx.beginPath();\n    ctx.moveTo(size / 2, size / 2 - 12);\n    ctx.lineTo(size / 2 + 10, size / 2 + 8);\n    ctx.lineTo(size / 2 - 10, size / 2 + 8);\n    ctx.closePath();\n    ctx.fillStyle = '#fff';\n    ctx.fill();\n  }\n  const texture = new THREE.CanvasTexture(canvas);\n  const material = new THREE.SpriteMaterial({\n    map: texture,\n    depthTest: false\n  });\n  const sprite = new THREE.Sprite(material);\n  sprite.scale.set(20, 20, 1); // tamaño visual\n  sprite.userData.hotspot = hotspot;\n  if (onClick) sprite.userData.onClick = onClick;\n  return sprite;\n}\nfunction isMobileDevice() {\n  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);\n}\nfunction TourEditor({\n  tourId\n}) {\n  _s();\n  const containerRef = useRef();\n  const [tour, setTour] = useState(null);\n  const [currentSceneIndex, setCurrentSceneIndex] = useState(0);\n  const [selectedHotspot, setSelectedHotspot] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [panelOpen, setPanelOpen] = useState(true);\n  const [pendingHotspot, setPendingHotspot] = useState(null);\n  const [placementMode, setPlacementMode] = useState(false);\n  const [newHotspotPosition, setNewHotspotPosition] = useState(null);\n  const [showHotspotModal, setShowHotspotModal] = useState(false);\n  const navigate = useNavigate();\n  const [fade, setFade] = useState(false);\n  const [pendingSceneIndex, setPendingSceneIndex] = useState(null);\n  // Estado para transición cruzada\n  const [transitioning, setTransitioning] = useState(false);\n  const [transitionProgress, setTransitionProgress] = useState(0);\n  const [prevTexture, setPrevTexture] = useState(null);\n\n  // Referencias de Three.js\n  const sceneRef = useRef();\n  const cameraRef = useRef();\n  const rendererRef = useRef();\n  const controlsRef = useRef();\n  // Referencia a los sprites de hotspots\n  const hotspotSpritesRef = useRef([]);\n  // 1. Al guardar un nuevo hotspot, solo guarda el objeto de datos\n  const accessSpheresRef = useRef([]);\n\n  // Cargar tour desde la API\n  useEffect(() => {\n    const fetchTour = async () => {\n      try {\n        const response = await api.getTour(tourId);\n        setTour(response.data);\n        setLoading(false);\n      } catch (err) {\n        setError('Error al cargar el tour');\n        setLoading(false);\n        console.error(err);\n      }\n    };\n    fetchTour();\n  }, [tourId]);\n\n  // Inicializar Three.js\n  useEffect(() => {\n    if (!tour || loading) return;\n\n    // Limpiar canvas anterior si existe\n    if (rendererRef.current && rendererRef.current.domElement && containerRef.current) {\n      if (containerRef.current.contains(rendererRef.current.domElement)) {\n        containerRef.current.removeChild(rendererRef.current.domElement);\n      }\n      rendererRef.current.dispose();\n    }\n\n    // Eliminar cualquier canvas sobrante (por si acaso)\n    if (containerRef.current) {\n      while (containerRef.current.firstChild) {\n        containerRef.current.removeChild(containerRef.current.firstChild);\n      }\n    }\n\n    // Usar el tamaño del contenedor para el renderer\n    const width = containerRef.current.clientWidth || window.innerWidth;\n    const height = containerRef.current.clientHeight || window.innerHeight;\n    const scene = new THREE.Scene();\n    const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);\n    camera.position.set(0, 0, 0.1);\n    const renderer = new THREE.WebGLRenderer({\n      antialias: true\n    });\n    renderer.setSize(width, height);\n    renderer.setClearColor(0x22232a, 1); // Fondo oscuro, pero no negro puro\n    containerRef.current.appendChild(renderer.domElement);\n    const controls = new OrbitControls(camera, renderer.domElement);\n    controls.enableDamping = true;\n    controls.dampingFactor = 0.05;\n    controls.rotateSpeed = -0.5; // INVERTIR dirección de rotación\n    // Soporte de zoom con scroll del mouse\n    controls.enableZoom = true;\n    controls.minDistance = 0.05;\n    controls.maxDistance = 2.5;\n    // Limitar fov para evitar zoom extremo\n    renderer.domElement.addEventListener('wheel', e => {\n      e.preventDefault();\n      camera.fov = Math.max(30, Math.min(100, camera.fov + (e.deltaY > 0 ? 2 : -2)));\n      camera.updateProjectionMatrix();\n    }, {\n      passive: false\n    });\n    sceneRef.current = scene;\n    cameraRef.current = camera;\n    rendererRef.current = renderer;\n    controlsRef.current = controls;\n    let animationId;\n    const animate = () => {\n      animationId = requestAnimationFrame(animate);\n      // Animación de expansión/contracción para esferas access\n      if (accessSpheresRef.current && accessSpheresRef.current.length > 0) {\n        const t = Date.now() * 0.003;\n        accessSpheresRef.current.forEach(sphere => {\n          const scale = 1.1 + 0.15 * Math.sin(t + sphere.position.x);\n          sphere.scale.set(scale, scale, scale);\n        });\n      }\n      controls.update();\n      renderer.render(scene, camera);\n    };\n    animate();\n\n    // Responsivo al tamaño del contenedor\n    const handleResize = () => {\n      if (!containerRef.current) return;\n      const w = containerRef.current.clientWidth || window.innerWidth;\n      const h = containerRef.current.clientHeight || window.innerHeight;\n      camera.aspect = w / h;\n      camera.updateProjectionMatrix();\n      renderer.setSize(w, h);\n    };\n    window.addEventListener('resize', handleResize);\n\n    // Limpieza\n    return () => {\n      window.removeEventListener('resize', handleResize);\n      if (animationId) cancelAnimationFrame(animationId);\n      if (rendererRef.current && rendererRef.current.domElement && containerRef.current && containerRef.current.contains(rendererRef.current.domElement)) {\n        rendererRef.current.dispose();\n        containerRef.current.removeChild(rendererRef.current.domElement);\n      }\n    };\n  }, [tour, loading]);\n\n  // Cargar la escena current\n  useEffect(() => {\n    if (!tour || !sceneRef.current || !tour.scenes || !Array.isArray(tour.scenes) || tour.scenes.length === 0 || currentSceneIndex === -1 || !tour.scenes[currentSceneIndex]) return;\n    const scene = sceneRef.current;\n    const currentScene = tour.scenes[currentSceneIndex];\n\n    // Limpiar escena anterior\n    while (scene.children.length > 0) {\n      scene.remove(scene.children[0]);\n    }\n    accessSpheresRef.current = [];\n\n    // Crear esfera para la imagen 360 con mayor calidad visual\n    const geometry = new THREE.SphereGeometry(500, 128, 96); // Más segmentos para suavidad\n    geometry.scale(-1, 1, 1);\n    const textureLoader = new THREE.TextureLoader();\n    let imageUrl = getAbsoluteImageUrl(currentScene.image);\n    textureLoader.load(imageUrl, texture => {\n      texture.minFilter = THREE.LinearFilter;\n      texture.magFilter = THREE.LinearFilter;\n      // Usar LinearSRGBColorSpace si está disponible, si no, omitir\n      if (texture.colorSpace !== undefined && THREE.LinearSRGBColorSpace) {\n        texture.colorSpace = THREE.LinearSRGBColorSpace;\n      }\n      // Anisotropía para mayor nitidez\n      if (rendererRef.current && rendererRef.current.capabilities.getMaxAnisotropy) {\n        texture.anisotropy = Math.min(16, rendererRef.current.capabilities.getMaxAnisotropy());\n      }\n      const material = new THREE.MeshBasicMaterial({\n        map: texture,\n        side: THREE.DoubleSide\n      });\n      const sphere = new THREE.Mesh(geometry, material);\n      scene.add(sphere);\n\n      // --- Renderizar Hotspots ---\n      hotspotSpritesRef.current = [];\n      if (Array.isArray(currentScene.hotspots)) {\n        currentScene.hotspots.forEach(hotspot => {\n          // Convertir pitch/yaw a coordenadas cartesianas\n          const radius = 500;\n          const phi = THREE.MathUtils.degToRad(90 - hotspot.pitch);\n          const theta = THREE.MathUtils.degToRad(hotspot.yaw);\n          const x = radius * Math.sin(phi) * Math.sin(theta);\n          const y = radius * Math.cos(phi);\n          const z = radius * Math.sin(phi) * Math.cos(theta);\n          let obj3d;\n          if (hotspot.type === 'access') {\n            // Esfera 3D para access\n            const geometry = new THREE.SphereGeometry(12, 32, 32);\n            const material = new THREE.MeshStandardMaterial({\n              color: 0x38bdf8,\n              emissive: 0x0ea5e9,\n              metalness: 0.3,\n              roughness: 0.5\n            });\n            obj3d = new THREE.Mesh(geometry, material);\n            obj3d.userData.hotspot = hotspot;\n            obj3d.userData.isAccessHotspot = true;\n            accessSpheresRef.current.push(obj3d);\n          } else {\n            // Sprite para otros tipos\n            const size = 64;\n            const canvas = document.createElement('canvas');\n            canvas.width = size;\n            canvas.height = size;\n            const ctx = canvas.getContext('2d');\n            ctx.beginPath();\n            ctx.arc(size / 2, size / 2, size / 2 - 4, 0, 2 * Math.PI);\n            ctx.fillStyle = '#38bdf8';\n            ctx.shadowColor = '#0ea5e9';\n            ctx.shadowBlur = 8;\n            ctx.fill();\n            ctx.lineWidth = 4;\n            ctx.strokeStyle = '#fff';\n            ctx.stroke();\n            const texture = new THREE.CanvasTexture(canvas);\n            const material = new THREE.SpriteMaterial({\n              map: texture,\n              depthTest: false\n            });\n            obj3d = new THREE.Sprite(material);\n            obj3d.scale.set(20, 20, 1);\n            obj3d.userData.hotspot = hotspot;\n          }\n          obj3d.position.set(x, y, z);\n          scene.add(obj3d);\n          hotspotSpritesRef.current.push(obj3d);\n        });\n      }\n    }, undefined, err => {\n      console.error('Error al cargar la textura:', err, imageUrl);\n      const material = new THREE.MeshBasicMaterial({\n        color: 0x444444,\n        side: THREE.DoubleSide\n      });\n      const sphere = new THREE.Mesh(geometry, material);\n      scene.add(sphere);\n    });\n  }, [tour, currentSceneIndex]);\n\n  // --- Detección de clics en hotspots ---\n  useEffect(() => {\n    if (!rendererRef.current || !cameraRef.current || !sceneRef.current) return;\n    const dom = rendererRef.current.domElement;\n    let lastClickTime = 0;\n    // 1. Comparación de IDs como string en la navegación de hotspots\n    const doubleClickNavigateToAccessHotspot = hotspot => {\n      if (hotspot && hotspot.type === 'access' && hotspot.targetSceneId) {\n        const idx = tour.scenes.findIndex(s => String(s._id) === String(hotspot.targetSceneId));\n        if (idx !== -1) {\n          startTransition(idx);\n        }\n      }\n    };\n    function onPointerDown(event) {\n      // Solo click izquierdo\n      if (event.button !== 0) return;\n      const rect = dom.getBoundingClientRect();\n      const mouse = new THREE.Vector2((event.clientX - rect.left) / rect.width * 2 - 1, -((event.clientY - rect.top) / rect.height) * 2 + 1);\n      const raycaster = new THREE.Raycaster();\n      raycaster.setFromCamera(mouse, cameraRef.current);\n      const intersects = raycaster.intersectObjects(hotspotSpritesRef.current || [], true);\n      if (intersects.length > 0) {\n        const obj = intersects[0].object;\n        const now = Date.now();\n        if (obj.userData.isAccessHotspot) {\n          if (now - lastClickTime < 400) {\n            // doble click\n            doubleClickNavigateToAccessHotspot(obj.userData.hotspot);\n          }\n          lastClickTime = now;\n        } else if (obj.userData.hotspot) {\n          setSelectedHotspot(obj.userData.hotspot);\n        }\n      }\n    }\n    dom.addEventListener('pointerdown', onPointerDown);\n    return () => {\n      dom.removeEventListener('pointerdown', onPointerDown);\n    };\n  }, [tour, currentSceneIndex]);\n\n  // Animación de transición\n  function startTransition(targetIdx) {\n    if (fade) return; // Evitar doble trigger\n    setFade(true);\n    setPendingSceneIndex(targetIdx);\n    // Animar FOV (zoom in)\n    const camera = cameraRef.current;\n    if (!camera) return;\n    let startFov = camera.fov;\n    let endFov = 35;\n    let duration = 350;\n    let start = null;\n    function animateZoomIn(ts) {\n      if (!start) start = ts;\n      let progress = Math.min((ts - start) / duration, 1);\n      camera.fov = startFov + (endFov - startFov) * progress;\n      camera.updateProjectionMatrix();\n      if (progress < 1) {\n        requestAnimationFrame(animateZoomIn);\n      } else {\n        // Esperar un poco y luego cambiar escena\n        setTimeout(() => {\n          setCurrentSceneIndex(targetIdx);\n        }, 200);\n      }\n    }\n    requestAnimationFrame(animateZoomIn);\n  }\n\n  // Animar transición cruzada\n  useEffect(() => {\n    if (!transitioning) return;\n    let frame;\n    function animate() {\n      setTransitionProgress(prev => {\n        const next = Math.min(prev + 0.04, 1);\n        if (next < 1) {\n          frame = requestAnimationFrame(animate);\n        } else {\n          setTransitioning(false);\n          setPrevTexture(null);\n          setCurrentSceneIndex(pendingSceneIndex);\n        }\n        return next;\n      });\n    }\n    animate();\n    return () => cancelAnimationFrame(frame);\n  }, [transitioning]);\n\n  // Modificar render de la escena para usar el shader durante la transición\n  useEffect(() => {\n    if (!sceneRef.current || !rendererRef.current || !cameraRef.current) return;\n    if (!transitioning || !prevTexture) return;\n    // Crear geometría y materiales\n    const geometry = new THREE.SphereGeometry(500, 128, 96);\n    geometry.scale(-1, 1, 1);\n    const currentScene = tour.scenes[pendingSceneIndex];\n    const loader = new THREE.TextureLoader();\n    loader.load(getAbsoluteImageUrl(currentScene.image), nextTexture => {\n      // Material de transición\n      const material = RadialFadeMaterial(prevTexture, nextTexture, transitionProgress);\n      const sphere = new THREE.Mesh(geometry, material);\n      sceneRef.current.add(sphere);\n      // Render loop\n      function renderTransition() {\n        material.uniforms.uProgress.value = transitionProgress;\n        rendererRef.current.render(sceneRef.current, cameraRef.current);\n        if (transitioning) requestAnimationFrame(renderTransition);else sceneRef.current.remove(sphere);\n      }\n      renderTransition();\n    });\n  }, [transitioning, transitionProgress]);\n\n  // Cuando cambia la escena, hacer fade out y zoom out\n  useEffect(() => {\n    if (pendingSceneIndex === null) return;\n    // Animar FOV (zoom out) y quitar fade\n    const camera = cameraRef.current;\n    if (!camera) return;\n    let startFov = camera.fov;\n    let endFov = 75;\n    let duration = 400;\n    let start = null;\n    function animateZoomOut(ts) {\n      if (!start) start = ts;\n      let progress = Math.min((ts - start) / duration, 1);\n      camera.fov = startFov + (endFov - startFov) * progress;\n      camera.updateProjectionMatrix();\n      if (progress < 1) {\n        requestAnimationFrame(animateZoomOut);\n      } else {\n        setFade(false);\n        setPendingSceneIndex(null);\n      }\n    }\n    setTimeout(() => {\n      requestAnimationFrame(animateZoomOut);\n    }, 250);\n  }, [currentSceneIndex]);\n\n  // Manejar subida de imágenes\n  const handleImageUpload = async e => {\n    let files = [];\n    if (e.target && e.target.files && e.target.files.length > 0) {\n      files = Array.from(e.target.files);\n    } else if (e instanceof File) {\n      files = [e];\n    } else if (Array.isArray(e)) {\n      files = e;\n    }\n    if (!files.length) return;\n    for (const file of files) {\n      try {\n        var _uploadRes$data;\n        let uploadRes = await api.uploadImage(file);\n        let imageUrl = ((_uploadRes$data = uploadRes.data) === null || _uploadRes$data === void 0 ? void 0 : _uploadRes$data.imageUrl) || uploadRes.imageUrl;\n        if (!imageUrl) {\n          throw new Error('No se recibió la URL de la imagen');\n        }\n        const newScene = {\n          name: `Escena ${tour.scenes.length + 1}`,\n          image: imageUrl,\n          hotspots: []\n        };\n        const updatedTour = {\n          ...tour,\n          scenes: [...tour.scenes, newScene]\n        };\n        const savedTour = await api.updateTour(tourId, updatedTour);\n        setTour(savedTour.data ? savedTour.data : savedTour);\n        setCurrentSceneIndex(updatedTour.scenes.length - 1);\n      } catch (err) {\n        console.error('Error subiendo imagen:', err);\n        alert(`Error al subir imagen: ${err.error || err.message || 'Intente nuevamente'}`);\n      }\n    }\n  };\n\n  // Manejar subida de imágenes (DragDrop)\n  const handleDragDropImage = async files => {\n    if (Array.isArray(files)) {\n      for (const file of files) {\n        await handleImageUpload(file);\n      }\n    } else {\n      await handleImageUpload(files);\n    }\n  };\n\n  // Guardar hotspot\n  const handleSaveHotspot = async hotspotData => {\n    try {\n      const updatedScenes = [...tour.scenes];\n      const currentScene = updatedScenes[currentSceneIndex];\n      if (hotspotData._id) {\n        const index = currentScene.hotspots.findIndex(h => h._id === hotspotData._id);\n        if (index !== -1) {\n          currentScene.hotspots[index] = hotspotData;\n        }\n      } else {\n        currentScene.hotspots.push({\n          ...hotspotData,\n          _id: Date.now().toString()\n        });\n      }\n      const updatedTour = {\n        ...tour,\n        scenes: updatedScenes\n      };\n      setTour(updatedTour);\n      await api.updateTour(tourId, updatedTour);\n      // Recarga el tour desde la API para asegurar sincronización\n      const response = await api.getTour(tourId);\n      setTour(response.data ? response.data : response);\n      setSelectedHotspot(null);\n      setPlacementMode(false);\n    } catch (err) {\n      console.error('Error guardando hotspot:', err);\n      alert(`Error al guardar: ${err.error || 'Intente nuevamente'}`);\n    }\n  };\n\n  // Efecto unificado para manejar el modo de colocación de hotspots\n  useEffect(() => {\n    if (!rendererRef.current || !sceneRef.current || !cameraRef.current) return;\n    const dom = rendererRef.current.domElement;\n    if (placementMode) {\n      dom.style.cursor = 'crosshair';\n\n      // Agregar un overlay visual para indicar el modo de colocación\n      const overlay = document.createElement('div');\n      overlay.style.cssText = `\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(56, 189, 248, 0.1);\n        pointer-events: none;\n        z-index: 5;\n        border: 2px dashed #38bdf8;\n        border-radius: 8px;\n        margin: 10px;\n      `;\n      overlay.id = 'placement-overlay';\n      dom.parentElement.appendChild(overlay);\n\n      // Manejar click en la esfera para añadir hotspot\n      const handlePointerDown = event => {\n        // Solo permitir click izquierdo\n        if (event.button !== 0) return;\n\n        // Evitar que el panel de control capture el click\n        if (event.target !== rendererRef.current.domElement) return;\n\n        // Obtener posición del click relativo al canvas\n        const rect = rendererRef.current.domElement.getBoundingClientRect();\n        const x = (event.clientX - rect.left) / rect.width * 2 - 1;\n        const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n\n        // Vector 3D en la dirección de la cámara\n        const vector = new THREE.Vector3(x, y, 0.5).unproject(cameraRef.current);\n\n        // Convertir a coordenadas esféricas (pitch/yaw)\n        const camPos = cameraRef.current.position;\n        const dir = vector.sub(camPos).normalize();\n        const phi = Math.acos(dir.y); // [0, PI]\n        const theta = Math.atan2(dir.x, dir.z); // [-PI, PI]\n\n        // Convertir a grados\n        const pitch = 90 - phi * 180 / Math.PI;\n        const yaw = theta * 180 / Math.PI;\n        setPendingHotspot({\n          pitch: Number(pitch.toFixed(2)),\n          yaw: Number(yaw.toFixed(2))\n        });\n        setPlacementMode(false);\n      };\n      dom.addEventListener('pointerdown', handlePointerDown);\n      return () => {\n        dom.style.cursor = '';\n        dom.removeEventListener('pointerdown', handlePointerDown);\n        const overlay = document.getElementById('placement-overlay');\n        if (overlay) {\n          overlay.remove();\n        }\n      };\n    } else {\n      dom.style.cursor = '';\n      const overlay = document.getElementById('placement-overlay');\n      if (overlay) {\n        overlay.remove();\n      }\n    }\n  }, [placementMode, rendererRef, sceneRef, cameraRef]);\n\n  // Nuevo: Guardar hotspot con pitch/yaw del click\n  const handleSaveHotspotWithCoords = hotspotData => {\n    var _pendingHotspot$pitch, _pendingHotspot$yaw;\n    handleSaveHotspot({\n      ...hotspotData,\n      pitch: (_pendingHotspot$pitch = pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.pitch) !== null && _pendingHotspot$pitch !== void 0 ? _pendingHotspot$pitch : hotspotData.pitch,\n      yaw: (_pendingHotspot$yaw = pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.yaw) !== null && _pendingHotspot$yaw !== void 0 ? _pendingHotspot$yaw : hotspotData.yaw\n    });\n    setPendingHotspot(null);\n  };\n\n  // Nuevo: Manejar click en la escena para colocar hotspot\n  const handleSceneClick = event => {\n    if (!placementMode) return;\n    // Obtener coordenadas del ratón normalizadas\n    const mouse = new THREE.Vector2();\n    const rect = containerRef.current.getBoundingClientRect();\n    mouse.x = (event.clientX - rect.left) / rect.width * 2 - 1;\n    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\n    const raycaster = new THREE.Raycaster();\n    raycaster.setFromCamera(mouse, cameraRef.current);\n\n    // Intersectar con la esfera (único mesh en la escena)\n    const intersects = raycaster.intersectObjects(sceneRef.current.children);\n    if (intersects.length > 0) {\n      const point = intersects[0].point;\n      const radius = 500;\n      const phi = Math.acos(point.y / radius);\n      const theta = Math.atan2(point.x, point.z); // x primero, z segundo\n      const pitch = 90 - THREE.MathUtils.radToDeg(phi);\n      const yaw = THREE.MathUtils.radToDeg(theta);\n      setNewHotspotPosition({\n        pitch,\n        yaw\n      });\n      setShowHotspotModal(true);\n      setPlacementMode(false);\n    }\n  };\n\n  // Guardar el nuevo hotspot usando el endpoint REST\n  const saveNewHotspot = async hotspotData => {\n    try {\n      if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) return;\n      const sceneId = tour.scenes[currentSceneIndex]._id;\n      const response = await api.addHotspot(tour._id, sceneId, hotspotData);\n      // Solo guardar el objeto de datos, no la respuesta completa\n      const newHotspot = response.data ? response.data : response;\n      const updatedTour = {\n        ...tour\n      };\n      updatedTour.scenes = [...updatedTour.scenes];\n      const scene = updatedTour.scenes[currentSceneIndex];\n      scene.hotspots = [...scene.hotspots, newHotspot];\n      setTour(updatedTour);\n      setShowHotspotModal(false);\n      setNewHotspotPosition(null);\n      // Recarga el tour desde la API para asegurar sincronización\n      const refreshed = await api.getTour(tourId);\n      setTour(refreshed.data ? refreshed.data : refreshed);\n    } catch (error) {\n      alert('Error al guardar el hotspot');\n      setShowHotspotModal(false);\n      setNewHotspotPosition(null);\n    }\n  };\n\n  // Reemplaza la función handleDeleteScene global para aceptar el índice de la escena a eliminar\n  useEffect(() => {\n    window.handleDeleteScene = async deleteIdx => {\n      if (!tour || !tour.scenes || tour.scenes.length <= 1) return;\n      const updatedScenes = tour.scenes.filter((_, idx) => idx !== deleteIdx);\n      let newIndex = currentSceneIndex;\n      if (deleteIdx === currentSceneIndex) {\n        newIndex = deleteIdx === 0 ? 0 : deleteIdx - 1;\n      } else if (deleteIdx < currentSceneIndex) {\n        newIndex = currentSceneIndex - 1;\n      }\n      const updatedTour = {\n        ...tour,\n        scenes: updatedScenes\n      };\n      setTour(updatedTour);\n      setCurrentSceneIndex(newIndex);\n      await api.updateTour(tour._id, updatedTour);\n    };\n    return () => {\n      window.handleDeleteScene = undefined;\n    };\n  }, [tour, currentSceneIndex]);\n\n  // 1. Función para eliminar hotspot de la escena actual\n  const handleDeleteHotspot = async hotspotIdx => {\n    if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) return;\n    const updatedScenes = [...tour.scenes];\n    const scene = {\n      ...updatedScenes[currentSceneIndex]\n    };\n    scene.hotspots = scene.hotspots.filter((_, idx) => idx !== hotspotIdx);\n    updatedScenes[currentSceneIndex] = scene;\n    const updatedTour = {\n      ...tour,\n      scenes: updatedScenes\n    };\n    setTour(updatedTour);\n    await api.updateTour(tour._id, updatedTour);\n  };\n\n  // --- GIROSCOPIO: Lógica de activación y manejo estilo YouTube 360 ---\n  useEffect(() => {\n    if (!isMobileDevice() || !cameraRef.current || !controlsRef.current) return;\n\n    // Habilitar/deshabilitar OrbitControls según el estado del giroscopio\n    controlsRef.current.enabled = true;\n    let lastAlpha = 0,\n      lastBeta = 0,\n      lastGamma = 0;\n    let smoothAlpha = 0,\n      smoothBeta = 0,\n      smoothGamma = 0;\n    const smoothFactor = 0.15;\n    function getScreenOrientation() {\n      if (window.screen.orientation && window.screen.orientation.angle !== undefined) {\n        return window.screen.orientation.angle;\n      }\n      return window.orientation || 0;\n    }\n    function handleOrientation(event) {\n      let alpha = event.alpha || 0;\n      let beta = event.beta || 0;\n      let gamma = event.gamma || 0;\n\n      // INVERTIR alpha para invertir la rotación horizontal\n      alpha = -alpha;\n      smoothAlpha = smoothAlpha * (1 - smoothFactor) + alpha * smoothFactor;\n      smoothBeta = smoothBeta * (1 - smoothFactor) + beta * smoothFactor;\n      smoothGamma = smoothGamma * (1 - smoothFactor) + gamma * smoothFactor;\n      const _alpha = THREE.MathUtils.degToRad(smoothAlpha);\n      const _beta = THREE.MathUtils.degToRad(smoothBeta);\n      const _gamma = THREE.MathUtils.degToRad(smoothGamma);\n      const orient = getScreenOrientation();\n      const orientRad = THREE.MathUtils.degToRad(orient);\n      const zee = new THREE.Vector3(0, 0, 1);\n      const euler = new THREE.Euler();\n      const q0 = new THREE.Quaternion();\n      const q1 = new THREE.Quaternion(-Math.sqrt(0.5), 0, 0, Math.sqrt(0.5));\n      euler.set(_beta, _alpha, -_gamma, 'YXZ');\n      let quaternion = new THREE.Quaternion().setFromEuler(euler);\n      quaternion.multiply(q1);\n      quaternion.multiply(q0.setFromAxisAngle(zee, -orientRad));\n      cameraRef.current.quaternion.copy(quaternion);\n    }\n    window.addEventListener('deviceorientation', handleOrientation, true);\n    const handleScreenOrientation = () => {\n      smoothAlpha = lastAlpha;\n      smoothBeta = lastBeta;\n      smoothGamma = lastGamma;\n    };\n    window.addEventListener('orientationchange', handleScreenOrientation);\n    return () => {\n      window.removeEventListener('deviceorientation', handleOrientation, true);\n      window.removeEventListener('orientationchange', handleScreenOrientation);\n      // Rehabilitar OrbitControls al salir del modo giroscopio\n      if (controlsRef.current) controlsRef.current.enabled = true;\n    };\n  }, []);\n  if (loading) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"loading\",\n      children: \"Cargando tour...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 781,\n      columnNumber: 12\n    }, this);\n  }\n  if (error) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"error\",\n      children: error\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 785,\n      columnNumber: 12\n    }, this);\n  }\n\n  // Si no hay escenas, muestra mensaje amigable y área de drag & drop\n  if (!tour.scenes || tour.scenes.length === 0) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"tour-editor\",\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        ref: containerRef,\n        className: \"three-container\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 792,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(ControlPanel, {\n        open: panelOpen,\n        setOpen: setPanelOpen,\n        tour: tour,\n        handleDragDropImage: handleDragDropImage,\n        handleImageUpload: handleImageUpload,\n        scenes: [],\n        placementMode: placementMode,\n        setPlacementMode: setPlacementMode,\n        onReturn: () => navigate('/hub'),\n        handleDeleteHotspot: handleDeleteHotspot\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 793,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 791,\n      columnNumber: 7\n    }, this);\n  }\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"tour-editor\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      ref: containerRef,\n      className: \"three-container\",\n      onClick: handleSceneClick\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 811,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `fade-overlay${fade ? ' visible' : ''}`\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 816,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(ControlPanel, {\n      open: panelOpen,\n      setOpen: setPanelOpen,\n      tour: tour,\n      handleDragDropImage: handleDragDropImage,\n      handleImageUpload: handleImageUpload,\n      scenes: tour.scenes,\n      currentSceneIndex: currentSceneIndex,\n      setCurrentSceneIndex: setCurrentSceneIndex,\n      placementMode: placementMode,\n      setPlacementMode: setPlacementMode,\n      onReturn: () => navigate('/hub'),\n      handleDeleteHotspot: handleDeleteHotspot\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 817,\n      columnNumber: 7\n    }, this), (selectedHotspot || pendingHotspot) && /*#__PURE__*/_jsxDEV(HotspotEditor, {\n      hotspot: selectedHotspot || {\n        pitch: pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.pitch,\n        yaw: pendingHotspot === null || pendingHotspot === void 0 ? void 0 : pendingHotspot.yaw\n      },\n      scenes: tour.scenes,\n      onSave: pendingHotspot ? handleSaveHotspotWithCoords : handleSaveHotspot,\n      onCancel: () => {\n        setSelectedHotspot(null);\n        setPlacementMode(false);\n        setPendingHotspot(null);\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 832,\n      columnNumber: 9\n    }, this), showHotspotModal && newHotspotPosition && /*#__PURE__*/_jsxDEV(HotspotCreationModal, {\n      position: newHotspotPosition,\n      tour: tour,\n      currentSceneIndex: currentSceneIndex,\n      onSave: saveNewHotspot,\n      onCancel: () => {\n        setShowHotspotModal(false);\n        setNewHotspotPosition(null);\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 844,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 810,\n    columnNumber: 5\n  }, this);\n}\n\n// Panel lateral plegable\n_s(TourEditor, \"37eEkfqGlPJj+dcU8tXUZuLCxlw=\", false, function () {\n  return [useNavigate];\n});\n_c = TourEditor;\nfunction ControlPanel({\n  open,\n  setOpen,\n  tour,\n  handleDragDropImage,\n  handleImageUpload,\n  scenes,\n  currentSceneIndex,\n  setCurrentSceneIndex,\n  placementMode,\n  setPlacementMode,\n  onReturn,\n  handleDeleteHotspot\n}) {\n  var _scenes$currentSceneI, _scenes$currentSceneI2, _scenes$currentSceneI3, _scenes$currentSceneI4;\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(\"aside\", {\n      className: `editor-panel${open ? ' open' : ''}`,\n      children: [/*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"panel-header\",\n        children: [/*#__PURE__*/_jsxDEV(\"span\", {\n          className: \"panel-title\",\n          children: \"Tour Virtual 360\\xB0\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 878,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"panel-toggle\",\n          onClick: () => setOpen(!open),\n          children: open ? /*#__PURE__*/_jsxDEV(_Fragment, {\n            children: \"\\u276E\"\n          }, void 0, false) : /*#__PURE__*/_jsxDEV(_Fragment, {\n            children: \"\\u276F\"\n          }, void 0, false)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 879,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 877,\n        columnNumber: 9\n      }, this), open && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"panel-content\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          className: \"btn-return-hub\",\n          onClick: onReturn,\n          style: {\n            background: '#23272f',\n            color: '#38bdf8',\n            border: 'none',\n            borderRadius: 8,\n            padding: '10px 0',\n            fontSize: '1rem',\n            fontWeight: 500,\n            marginBottom: 18,\n            cursor: 'pointer',\n            width: '100%',\n            transition: 'background 0.2s, color 0.2s'\n          },\n          children: \"\\u2190 Volver al Hub\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 885,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(ApiKeyManager, {\n          tourId: tour._id,\n          initialApiKey: tour.apiKey\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 904,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section\",\n          children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n            children: \"Im\\xE1genes 360\\xB0\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 906,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(DragDrop, {\n            onFileUpload: handleDragDropImage\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 907,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"panel-dragdrop-hint\",\n            children: \"o haz clic para seleccionar\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 908,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"input\", {\n            type: \"file\",\n            id: \"image-upload\",\n            accept: \"image/*\",\n            onChange: handleImageUpload,\n            style: {\n              display: 'none'\n            }\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 909,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 905,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section\",\n          children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n            children: [\"Im\\xE1genes Cargadas (\", scenes.length, \")\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 918,\n            columnNumber: 15\n          }, this), scenes.length === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"panel-empty\",\n            children: \"No hay im\\xE1genes cargadas\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 920,\n            columnNumber: 17\n          }, this) : /*#__PURE__*/_jsxDEV(\"ul\", {\n            className: \"panel-image-list\",\n            children: scenes.map((scene, idx) => /*#__PURE__*/_jsxDEV(\"li\", {\n              className: `panel-image-item${currentSceneIndex === idx ? ' active' : ''}`,\n              style: {\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'space-between'\n              },\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  display: 'flex',\n                  alignItems: 'center',\n                  flex: 1,\n                  cursor: 'pointer'\n                },\n                onClick: () => setCurrentSceneIndex && setCurrentSceneIndex(idx),\n                children: [/*#__PURE__*/_jsxDEV(\"img\", {\n                  src: scene.image ? getAbsoluteImageUrl(scene.image) : '',\n                  alt: scene.name\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 930,\n                  columnNumber: 25\n                }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                  children: scene.name\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 931,\n                  columnNumber: 25\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 929,\n                columnNumber: 23\n              }, this), scenes.length > 1 && /*#__PURE__*/_jsxDEV(\"button\", {\n                className: \"btn-delete-scene\",\n                style: {\n                  background: 'transparent',\n                  color: '#ef4444',\n                  border: 'none',\n                  marginLeft: 8,\n                  fontSize: 20,\n                  cursor: 'pointer'\n                },\n                title: \"Eliminar escena\",\n                onClick: e => {\n                  e.stopPropagation();\n                  if (window.confirm('¿Seguro que deseas eliminar esta escena?')) {\n                    if (typeof window.handleDeleteScene === 'function') window.handleDeleteScene(idx);\n                  }\n                },\n                children: \"\\uD83D\\uDDD1\\uFE0F\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 934,\n                columnNumber: 25\n              }, this)]\n            }, scene._id || idx, true, {\n              fileName: _jsxFileName,\n              lineNumber: 924,\n              columnNumber: 21\n            }, this))\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 922,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 917,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section\",\n          children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n            children: [\"Hotspots de la Escena (\", ((_scenes$currentSceneI = scenes[currentSceneIndex]) === null || _scenes$currentSceneI === void 0 ? void 0 : (_scenes$currentSceneI2 = _scenes$currentSceneI.hotspots) === null || _scenes$currentSceneI2 === void 0 ? void 0 : _scenes$currentSceneI2.length) || 0, \")\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 954,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"hotspot-controls\",\n            style: {\n              marginBottom: 15\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"button\", {\n              className: \"btn-add-hotspot\",\n              onClick: () => setPlacementMode(true),\n              title: \"Haz clic para activar el modo de colocaci\\xF3n de hotspots. Luego haz clic en la imagen 360\\xB0 donde quieras colocar el hotspot.\",\n              style: {\n                background: '#38bdf8',\n                color: '#fff',\n                border: 'none',\n                borderRadius: 8,\n                padding: '10px 16px',\n                fontSize: '14px',\n                fontWeight: 500,\n                cursor: 'pointer',\n                width: '100%',\n                transition: 'background 0.2s',\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'center',\n                gap: 8,\n                position: 'relative'\n              },\n              onMouseEnter: e => e.target.style.background = '#0ea5e9',\n              onMouseLeave: e => e.target.style.background = '#38bdf8',\n              children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                style: {\n                  fontSize: '16px'\n                },\n                children: \"\\uD83D\\uDCCD\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 980,\n                columnNumber: 19\n              }, this), \"Agregar Hotspot\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 956,\n              columnNumber: 17\n            }, this), placementMode && /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"placement-mode-indicator\",\n              children: [/*#__PURE__*/_jsxDEV(\"div\", {\n                style: {\n                  display: 'flex',\n                  justifyContent: 'space-between',\n                  alignItems: 'center',\n                  marginBottom: 8\n                },\n                children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                  children: \"Modo de colocaci\\xF3n activado\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 986,\n                  columnNumber: 23\n                }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n                  onClick: () => setPlacementMode(false),\n                  style: {\n                    background: 'transparent',\n                    border: '1px solid #ef4444',\n                    color: '#ef4444',\n                    borderRadius: 4,\n                    padding: '4px 8px',\n                    fontSize: '11px',\n                    cursor: 'pointer',\n                    transition: 'all 0.2s'\n                  },\n                  onMouseEnter: e => {\n                    e.target.style.background = '#ef4444';\n                    e.target.style.color = '#fff';\n                  },\n                  onMouseLeave: e => {\n                    e.target.style.background = 'transparent';\n                    e.target.style.color = '#ef4444';\n                  },\n                  children: \"Cancelar\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 987,\n                  columnNumber: 23\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 985,\n                columnNumber: 21\n              }, this), \"Haz clic en la imagen 360\\xB0 para colocar el hotspot\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 984,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 955,\n            columnNumber: 15\n          }, this), ((_scenes$currentSceneI3 = scenes[currentSceneIndex]) === null || _scenes$currentSceneI3 === void 0 ? void 0 : (_scenes$currentSceneI4 = _scenes$currentSceneI3.hotspots) === null || _scenes$currentSceneI4 === void 0 ? void 0 : _scenes$currentSceneI4.length) === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n            style: {\n              background: '#1e293b',\n              border: '1px dashed #334155',\n              borderRadius: 6,\n              padding: '20px',\n              textAlign: 'center',\n              color: '#64748b',\n              fontSize: '14px'\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                fontSize: '24px',\n                marginBottom: '8px'\n              },\n              children: \"\\uD83D\\uDCCD\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1025,\n              columnNumber: 19\n            }, this), \"No hay hotspots en esta escena\", /*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                fontSize: '12px',\n                marginTop: '4px'\n              },\n              children: \"Haz clic en \\\"Agregar Hotspot\\\" para comenzar\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1027,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1016,\n            columnNumber: 17\n          }, this) : /*#__PURE__*/_jsxDEV(_Fragment, {\n            children: [/*#__PURE__*/_jsxDEV(\"div\", {\n              style: {\n                background: '#1e293b',\n                border: '1px solid #334155',\n                borderRadius: 6,\n                padding: '8px 12px',\n                marginBottom: '12px',\n                fontSize: '12px',\n                color: '#94a3b8'\n              },\n              children: (() => {\n                const hotspots = scenes[currentSceneIndex].hotspots;\n                const types = {\n                  access: hotspots.filter(h => h.type === 'access').length,\n                  commerce: hotspots.filter(h => h.type === 'commerce').length,\n                  location: hotspots.filter(h => h.type === 'location').length\n                };\n                return /*#__PURE__*/_jsxDEV(\"div\", {\n                  style: {\n                    display: 'flex',\n                    justifyContent: 'space-between'\n                  },\n                  children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [\"\\uD83D\\uDCCD Acceso: \", types.access]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1052,\n                    columnNumber: 27\n                  }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [\"\\uD83C\\uDFEA Comercio: \", types.commerce]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1053,\n                    columnNumber: 27\n                  }, this), /*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [\"\\uD83D\\uDCCD Locaci\\xF3n: \", types.location]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1054,\n                    columnNumber: 27\n                  }, this)]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1051,\n                  columnNumber: 25\n                }, this);\n              })()\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1034,\n              columnNumber: 19\n            }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n              className: \"panel-hotspot-list\",\n              children: scenes[currentSceneIndex].hotspots.map((hotspot, idx) => {\n                let accessInfo = null;\n                if (hotspot.type === 'access' && hotspot.targetSceneId) {\n                  const target = scenes.find(s => String(s._id) === String(hotspot.targetSceneId));\n                  accessInfo = target ? `→ ${target.name}` : '→ [Escena no encontrada]';\n                }\n                return /*#__PURE__*/_jsxDEV(\"li\", {\n                  style: {\n                    display: 'flex',\n                    alignItems: 'center',\n                    justifyContent: 'space-between',\n                    gap: 8\n                  },\n                  children: [/*#__PURE__*/_jsxDEV(\"span\", {\n                    children: [hotspot.type === 'access' ? 'Punto de Acceso' : hotspot.title || 'Hotspot', accessInfo && /*#__PURE__*/_jsxDEV(\"span\", {\n                      style: {\n                        color: '#38bdf8',\n                        marginLeft: 8,\n                        fontSize: 13\n                      },\n                      children: accessInfo\n                    }, void 0, false, {\n                      fileName: _jsxFileName,\n                      lineNumber: 1070,\n                      columnNumber: 44\n                    }, this)]\n                  }, void 0, true, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1068,\n                    columnNumber: 27\n                  }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n                    style: {\n                      background: 'transparent',\n                      color: '#ef4444',\n                      border: 'none',\n                      fontSize: 18,\n                      cursor: 'pointer'\n                    },\n                    title: \"Eliminar hotspot\",\n                    onClick: () => {\n                      if (window.confirm('¿Eliminar este hotspot?')) handleDeleteHotspot(idx);\n                    },\n                    children: \"\\uD83D\\uDDD1\\uFE0F\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 1072,\n                    columnNumber: 27\n                  }, this)]\n                }, hotspot._id || idx, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 1067,\n                  columnNumber: 25\n                }, this);\n              })\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1059,\n              columnNumber: 19\n            }, this)]\n          }, void 0, true)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 953,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"panel-section panel-hint\",\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            children: /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Tipos de Hotspots:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1081,\n              columnNumber: 18\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 1081,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n            style: {\n              margin: '8px 0',\n              paddingLeft: '20px',\n              fontSize: '13px'\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"li\", {\n              children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                children: \"\\uD83D\\uDCCD Acceso:\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1083,\n                columnNumber: 21\n              }, this), \" Navega a otra escena del tour\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1083,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n              children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                children: \"\\uD83C\\uDFEA Comercio:\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1084,\n                columnNumber: 21\n              }, this), \" Muestra informaci\\xF3n de un negocio\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1084,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"li\", {\n              children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n                children: \"\\uD83D\\uDCCD Locaci\\xF3n:\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 1085,\n                columnNumber: 21\n              }, this), \" Muestra informaci\\xF3n de un lugar\"]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 1085,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1082,\n            columnNumber: 15\n          }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n            style: {\n              marginTop: '12px',\n              fontSize: '13px'\n            },\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Controles:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1088,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1088,\n              columnNumber: 44\n            }, this), \"\\u2022 Haz doble clic en hotspots de acceso para navegar\", /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 1089,\n              columnNumber: 68\n            }, this), \"\\u2022 Haz clic en hotspots para ver/editar informaci\\xF3n\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 1087,\n            columnNumber: 15\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 1080,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 884,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 876,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      className: `editor-backdrop${open ? ' open' : ''}`,\n      onClick: () => setOpen(false)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 1096,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true);\n}\n_c2 = ControlPanel;\nexport default TourEditor;\nvar _c, _c2;\n$RefreshReg$(_c, \"TourEditor\");\n$RefreshReg$(_c2, \"ControlPanel\");","map":{"version":3,"names":["React","useRef","useEffect","useState","THREE","OrbitControls","HotspotEditor","api","DragDrop","useNavigate","ApiKeyManager","HotspotCreationModal","RadialFadeMaterial","jsxDEV","_jsxDEV","Fragment","_Fragment","getAbsoluteImageUrl","image","startsWith","_process$env$REACT_AP","process","env","REACT_APP_API_URL","replace","createHotspotSprite","hotspot","onClick","size","canvas","document","createElement","width","height","ctx","getContext","beginPath","arc","Math","PI","fillStyle","shadowColor","shadowBlur","fill","lineWidth","strokeStyle","stroke","type","moveTo","lineTo","closePath","texture","CanvasTexture","material","SpriteMaterial","map","depthTest","sprite","Sprite","scale","set","userData","isMobileDevice","test","navigator","userAgent","TourEditor","tourId","_s","containerRef","tour","setTour","currentSceneIndex","setCurrentSceneIndex","selectedHotspot","setSelectedHotspot","loading","setLoading","error","setError","panelOpen","setPanelOpen","pendingHotspot","setPendingHotspot","placementMode","setPlacementMode","newHotspotPosition","setNewHotspotPosition","showHotspotModal","setShowHotspotModal","navigate","fade","setFade","pendingSceneIndex","setPendingSceneIndex","transitioning","setTransitioning","transitionProgress","setTransitionProgress","prevTexture","setPrevTexture","sceneRef","cameraRef","rendererRef","controlsRef","hotspotSpritesRef","accessSpheresRef","fetchTour","response","getTour","data","err","console","current","domElement","contains","removeChild","dispose","firstChild","clientWidth","window","innerWidth","clientHeight","innerHeight","scene","Scene","camera","PerspectiveCamera","position","renderer","WebGLRenderer","antialias","setSize","setClearColor","appendChild","controls","enableDamping","dampingFactor","rotateSpeed","enableZoom","minDistance","maxDistance","addEventListener","e","preventDefault","fov","max","min","deltaY","updateProjectionMatrix","passive","animationId","animate","requestAnimationFrame","length","t","Date","now","forEach","sphere","sin","x","update","render","handleResize","w","h","aspect","removeEventListener","cancelAnimationFrame","scenes","Array","isArray","currentScene","children","remove","geometry","SphereGeometry","textureLoader","TextureLoader","imageUrl","load","minFilter","LinearFilter","magFilter","colorSpace","undefined","LinearSRGBColorSpace","capabilities","getMaxAnisotropy","anisotropy","MeshBasicMaterial","side","DoubleSide","Mesh","add","hotspots","radius","phi","MathUtils","degToRad","pitch","theta","yaw","y","cos","z","obj3d","MeshStandardMaterial","color","emissive","metalness","roughness","isAccessHotspot","push","dom","lastClickTime","doubleClickNavigateToAccessHotspot","targetSceneId","idx","findIndex","s","String","_id","startTransition","onPointerDown","event","button","rect","getBoundingClientRect","mouse","Vector2","clientX","left","clientY","top","raycaster","Raycaster","setFromCamera","intersects","intersectObjects","obj","object","targetIdx","startFov","endFov","duration","start","animateZoomIn","ts","progress","setTimeout","frame","prev","next","loader","nextTexture","renderTransition","uniforms","uProgress","value","animateZoomOut","handleImageUpload","files","target","from","File","file","_uploadRes$data","uploadRes","uploadImage","Error","newScene","name","updatedTour","savedTour","updateTour","alert","message","handleDragDropImage","handleSaveHotspot","hotspotData","updatedScenes","index","toString","style","cursor","overlay","cssText","id","parentElement","handlePointerDown","vector","Vector3","unproject","camPos","dir","sub","normalize","acos","atan2","Number","toFixed","getElementById","handleSaveHotspotWithCoords","_pendingHotspot$pitch","_pendingHotspot$yaw","handleSceneClick","point","radToDeg","saveNewHotspot","sceneId","addHotspot","newHotspot","refreshed","handleDeleteScene","deleteIdx","filter","_","newIndex","handleDeleteHotspot","hotspotIdx","enabled","lastAlpha","lastBeta","lastGamma","smoothAlpha","smoothBeta","smoothGamma","smoothFactor","getScreenOrientation","screen","orientation","angle","handleOrientation","alpha","beta","gamma","_alpha","_beta","_gamma","orient","orientRad","zee","euler","Euler","q0","Quaternion","q1","sqrt","quaternion","setFromEuler","multiply","setFromAxisAngle","copy","handleScreenOrientation","className","fileName","_jsxFileName","lineNumber","columnNumber","ref","ControlPanel","open","setOpen","onReturn","onSave","onCancel","_c","_scenes$currentSceneI","_scenes$currentSceneI2","_scenes$currentSceneI3","_scenes$currentSceneI4","background","border","borderRadius","padding","fontSize","fontWeight","marginBottom","transition","initialApiKey","apiKey","onFileUpload","accept","onChange","display","alignItems","justifyContent","flex","src","alt","marginLeft","title","stopPropagation","confirm","gap","onMouseEnter","onMouseLeave","textAlign","marginTop","types","access","commerce","location","accessInfo","find","margin","paddingLeft","_c2","$RefreshReg$"],"sources":["D:/respaldo jose/PROJECTS_V0/hub360/frontend/src/components/Editor/TourEditor.js"],"sourcesContent":["import React, { useRef, useEffect, useState } from 'react';\r\nimport * as THREE from 'three';\r\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';\r\nimport HotspotEditor from './HotspotEditor';\r\nimport api from '../../services/api';\r\nimport DragDrop from './DragDrop';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport './TourEditor.css';\r\nimport ApiKeyManager from './ApiKeyManager';\r\nimport HotspotCreationModal from './HotspotCreationModal';\r\nimport RadialFadeMaterial from '../shaders/RadialFadeMaterial';\r\n\r\n// Utilidad para obtener la URL absoluta de la imagen\r\nfunction getAbsoluteImageUrl(image) {\r\n  if (!image) return '';\r\n  if (image.startsWith('/uploads/')) {\r\n    return `${process.env.REACT_APP_API_URL?.replace('/api', '') || 'http://localhost:5000'}${image}`;\r\n  }\r\n  return image;\r\n}\r\n\r\nfunction createHotspotSprite(hotspot, onClick) {\r\n  // Crear un canvas para el ícono visual\r\n  const size = 64;\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = size;\r\n  canvas.height = size;\r\n  const ctx = canvas.getContext('2d');\r\n  // Círculo azul claro\r\n  ctx.beginPath();\r\n  ctx.arc(size/2, size/2, size/2-4, 0, 2*Math.PI);\r\n  ctx.fillStyle = '#38bdf8';\r\n  ctx.shadowColor = '#0ea5e9';\r\n  ctx.shadowBlur = 8;\r\n  ctx.fill();\r\n  ctx.lineWidth = 4;\r\n  ctx.strokeStyle = '#fff';\r\n  ctx.stroke();\r\n  // Icono de flecha si es access\r\n  if (hotspot.type === 'access') {\r\n    ctx.beginPath();\r\n    ctx.moveTo(size/2, size/2-12);\r\n    ctx.lineTo(size/2+10, size/2+8);\r\n    ctx.lineTo(size/2-10, size/2+8);\r\n    ctx.closePath();\r\n    ctx.fillStyle = '#fff';\r\n    ctx.fill();\r\n  }\r\n  const texture = new THREE.CanvasTexture(canvas);\r\n  const material = new THREE.SpriteMaterial({ map: texture, depthTest: false });\r\n  const sprite = new THREE.Sprite(material);\r\n  sprite.scale.set(20, 20, 1); // tamaño visual\r\n  sprite.userData.hotspot = hotspot;\r\n  if (onClick) sprite.userData.onClick = onClick;\r\n  return sprite;\r\n}\r\n\r\nfunction isMobileDevice() {\r\n  return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);\r\n}\r\n\r\nfunction TourEditor({ tourId }) {\r\n  const containerRef = useRef();\r\n  const [tour, setTour] = useState(null);\r\n  const [currentSceneIndex, setCurrentSceneIndex] = useState(0);\r\n  const [selectedHotspot, setSelectedHotspot] = useState(null);\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  const [panelOpen, setPanelOpen] = useState(true);\r\n  const [pendingHotspot, setPendingHotspot] = useState(null);\r\n  const [placementMode, setPlacementMode] = useState(false);\r\n  const [newHotspotPosition, setNewHotspotPosition] = useState(null);\r\n  const [showHotspotModal, setShowHotspotModal] = useState(false);\r\n  const navigate = useNavigate();\r\n  const [fade, setFade] = useState(false);\r\n  const [pendingSceneIndex, setPendingSceneIndex] = useState(null);\r\n  // Estado para transición cruzada\r\n  const [transitioning, setTransitioning] = useState(false);\r\n  const [transitionProgress, setTransitionProgress] = useState(0);\r\n  const [prevTexture, setPrevTexture] = useState(null);\r\n\r\n  // Referencias de Three.js\r\n  const sceneRef = useRef();\r\n  const cameraRef = useRef();\r\n  const rendererRef = useRef();\r\n  const controlsRef = useRef();\r\n  // Referencia a los sprites de hotspots\r\n  const hotspotSpritesRef = useRef([]);\r\n  // 1. Al guardar un nuevo hotspot, solo guarda el objeto de datos\r\n  const accessSpheresRef = useRef([]);\r\n\r\n  // Cargar tour desde la API\r\n  useEffect(() => {\r\n    const fetchTour = async () => {\r\n      try {\r\n        const response = await api.getTour(tourId);\r\n        setTour(response.data);\r\n        setLoading(false);\r\n      } catch (err) {\r\n        setError('Error al cargar el tour');\r\n        setLoading(false);\r\n        console.error(err);\r\n      }\r\n    };\r\n    fetchTour();\r\n  }, [tourId]);\r\n\r\n  // Inicializar Three.js\r\n  useEffect(() => {\r\n    if (!tour || loading) return;\r\n\r\n    // Limpiar canvas anterior si existe\r\n    if (rendererRef.current && rendererRef.current.domElement && containerRef.current) {\r\n      if (containerRef.current.contains(rendererRef.current.domElement)) {\r\n        containerRef.current.removeChild(rendererRef.current.domElement);\r\n      }\r\n      rendererRef.current.dispose();\r\n    }\r\n\r\n    // Eliminar cualquier canvas sobrante (por si acaso)\r\n    if (containerRef.current) {\r\n      while (containerRef.current.firstChild) {\r\n        containerRef.current.removeChild(containerRef.current.firstChild);\r\n      }\r\n    }\r\n\r\n    // Usar el tamaño del contenedor para el renderer\r\n    const width = containerRef.current.clientWidth || window.innerWidth;\r\n    const height = containerRef.current.clientHeight || window.innerHeight;\r\n\r\n    const scene = new THREE.Scene();\r\n    const camera = new THREE.PerspectiveCamera(\r\n      75,\r\n      width / height,\r\n      0.1,\r\n      1000\r\n    );\r\n    camera.position.set(0, 0, 0.1);\r\n\r\n    const renderer = new THREE.WebGLRenderer({ antialias: true });\r\n    renderer.setSize(width, height);\r\n    renderer.setClearColor(0x22232a, 1); // Fondo oscuro, pero no negro puro\r\n    containerRef.current.appendChild(renderer.domElement);\r\n\r\n    const controls = new OrbitControls(camera, renderer.domElement);\r\n    controls.enableDamping = true;\r\n    controls.dampingFactor = 0.05;\r\n    controls.rotateSpeed = -0.5; // INVERTIR dirección de rotación\r\n    // Soporte de zoom con scroll del mouse\r\n    controls.enableZoom = true;\r\n    controls.minDistance = 0.05;\r\n    controls.maxDistance = 2.5;\r\n    // Limitar fov para evitar zoom extremo\r\n    renderer.domElement.addEventListener('wheel', (e) => {\r\n      e.preventDefault();\r\n      camera.fov = Math.max(30, Math.min(100, camera.fov + (e.deltaY > 0 ? 2 : -2)));\r\n      camera.updateProjectionMatrix();\r\n    }, { passive: false });\r\n\r\n    sceneRef.current = scene;\r\n    cameraRef.current = camera;\r\n    rendererRef.current = renderer;\r\n    controlsRef.current = controls;\r\n\r\n    let animationId;\r\n    const animate = () => {\r\n      animationId = requestAnimationFrame(animate);\r\n      // Animación de expansión/contracción para esferas access\r\n      if (accessSpheresRef.current && accessSpheresRef.current.length > 0) {\r\n        const t = Date.now() * 0.003;\r\n        accessSpheresRef.current.forEach(sphere => {\r\n          const scale = 1.1 + 0.15 * Math.sin(t + sphere.position.x);\r\n          sphere.scale.set(scale, scale, scale);\r\n        });\r\n      }\r\n      controls.update();\r\n      renderer.render(scene, camera);\r\n    };\r\n    animate();\r\n\r\n    // Responsivo al tamaño del contenedor\r\n    const handleResize = () => {\r\n      if (!containerRef.current) return;\r\n      const w = containerRef.current.clientWidth || window.innerWidth;\r\n      const h = containerRef.current.clientHeight || window.innerHeight;\r\n      camera.aspect = w / h;\r\n      camera.updateProjectionMatrix();\r\n      renderer.setSize(w, h);\r\n    };\r\n    window.addEventListener('resize', handleResize);\r\n\r\n    // Limpieza\r\n    return () => {\r\n      window.removeEventListener('resize', handleResize);\r\n      if (animationId) cancelAnimationFrame(animationId);\r\n      if (\r\n        rendererRef.current &&\r\n        rendererRef.current.domElement &&\r\n        containerRef.current &&\r\n        containerRef.current.contains(rendererRef.current.domElement)\r\n      ) {\r\n        rendererRef.current.dispose();\r\n        containerRef.current.removeChild(rendererRef.current.domElement);\r\n      }\r\n    };\r\n  }, [tour, loading]);\r\n\r\n  // Cargar la escena current\r\n  useEffect(() => {\r\n    if (\r\n      !tour ||\r\n      !sceneRef.current ||\r\n      !tour.scenes ||\r\n      !Array.isArray(tour.scenes) ||\r\n      tour.scenes.length === 0 ||\r\n      currentSceneIndex === -1 ||\r\n      !tour.scenes[currentSceneIndex]\r\n    ) return;\r\n\r\n    const scene = sceneRef.current;\r\n    const currentScene = tour.scenes[currentSceneIndex];\r\n\r\n    // Limpiar escena anterior\r\n    while (scene.children.length > 0) {\r\n      scene.remove(scene.children[0]);\r\n    }\r\n    accessSpheresRef.current = [];\r\n\r\n    // Crear esfera para la imagen 360 con mayor calidad visual\r\n    const geometry = new THREE.SphereGeometry(500, 128, 96); // Más segmentos para suavidad\r\n    geometry.scale(-1, 1, 1);\r\n\r\n    const textureLoader = new THREE.TextureLoader();\r\n    let imageUrl = getAbsoluteImageUrl(currentScene.image);\r\n\r\n    textureLoader.load(\r\n      imageUrl,\r\n      texture => {\r\n        texture.minFilter = THREE.LinearFilter;\r\n        texture.magFilter = THREE.LinearFilter;\r\n        // Usar LinearSRGBColorSpace si está disponible, si no, omitir\r\n        if (texture.colorSpace !== undefined && THREE.LinearSRGBColorSpace) {\r\n          texture.colorSpace = THREE.LinearSRGBColorSpace;\r\n        }\r\n        // Anisotropía para mayor nitidez\r\n        if (rendererRef.current && rendererRef.current.capabilities.getMaxAnisotropy) {\r\n          texture.anisotropy = Math.min(16, rendererRef.current.capabilities.getMaxAnisotropy());\r\n        }\r\n        const material = new THREE.MeshBasicMaterial({\r\n          map: texture,\r\n          side: THREE.DoubleSide\r\n        });\r\n        const sphere = new THREE.Mesh(geometry, material);\r\n        scene.add(sphere);\r\n\r\n        // --- Renderizar Hotspots ---\r\n        hotspotSpritesRef.current = [];\r\n        if (Array.isArray(currentScene.hotspots)) {\r\n          currentScene.hotspots.forEach(hotspot => {\r\n            // Convertir pitch/yaw a coordenadas cartesianas\r\n            const radius = 500;\r\n            const phi = THREE.MathUtils.degToRad(90 - hotspot.pitch);\r\n            const theta = THREE.MathUtils.degToRad(hotspot.yaw);\r\n            const x = radius * Math.sin(phi) * Math.sin(theta);\r\n            const y = radius * Math.cos(phi);\r\n            const z = radius * Math.sin(phi) * Math.cos(theta);\r\n            let obj3d;\r\n            if (hotspot.type === 'access') {\r\n              // Esfera 3D para access\r\n              const geometry = new THREE.SphereGeometry(12, 32, 32);\r\n              const material = new THREE.MeshStandardMaterial({ color: 0x38bdf8, emissive: 0x0ea5e9, metalness: 0.3, roughness: 0.5 });\r\n              obj3d = new THREE.Mesh(geometry, material);\r\n              obj3d.userData.hotspot = hotspot;\r\n              obj3d.userData.isAccessHotspot = true;\r\n              accessSpheresRef.current.push(obj3d);\r\n            } else {\r\n              // Sprite para otros tipos\r\n              const size = 64;\r\n              const canvas = document.createElement('canvas');\r\n              canvas.width = size;\r\n              canvas.height = size;\r\n              const ctx = canvas.getContext('2d');\r\n              ctx.beginPath();\r\n              ctx.arc(size/2, size/2, size/2-4, 0, 2*Math.PI);\r\n              ctx.fillStyle = '#38bdf8';\r\n              ctx.shadowColor = '#0ea5e9';\r\n              ctx.shadowBlur = 8;\r\n              ctx.fill();\r\n              ctx.lineWidth = 4;\r\n              ctx.strokeStyle = '#fff';\r\n              ctx.stroke();\r\n              const texture = new THREE.CanvasTexture(canvas);\r\n              const material = new THREE.SpriteMaterial({ map: texture, depthTest: false });\r\n              obj3d = new THREE.Sprite(material);\r\n              obj3d.scale.set(20, 20, 1);\r\n              obj3d.userData.hotspot = hotspot;\r\n            }\r\n            obj3d.position.set(x, y, z);\r\n            scene.add(obj3d);\r\n            hotspotSpritesRef.current.push(obj3d);\r\n          });\r\n        }\r\n      },\r\n      undefined,\r\n      err => {\r\n        console.error('Error al cargar la textura:', err, imageUrl);\r\n        const material = new THREE.MeshBasicMaterial({ color: 0x444444, side: THREE.DoubleSide });\r\n        const sphere = new THREE.Mesh(geometry, material);\r\n        scene.add(sphere);\r\n      }\r\n    );\r\n  }, [tour, currentSceneIndex]);\r\n\r\n  // --- Detección de clics en hotspots ---\r\n  useEffect(() => {\r\n    if (!rendererRef.current || !cameraRef.current || !sceneRef.current) return;\r\n    const dom = rendererRef.current.domElement;\r\n    let lastClickTime = 0;\r\n    // 1. Comparación de IDs como string en la navegación de hotspots\r\n    const doubleClickNavigateToAccessHotspot = (hotspot) => {\r\n      if (hotspot && hotspot.type === 'access' && hotspot.targetSceneId) {\r\n        const idx = tour.scenes.findIndex(s => String(s._id) === String(hotspot.targetSceneId));\r\n        if (idx !== -1) {\r\n          startTransition(idx);\r\n        }\r\n      }\r\n    };\r\n    function onPointerDown(event) {\r\n      // Solo click izquierdo\r\n      if (event.button !== 0) return;\r\n      const rect = dom.getBoundingClientRect();\r\n      const mouse = new THREE.Vector2(\r\n        ((event.clientX - rect.left) / rect.width) * 2 - 1,\r\n        -((event.clientY - rect.top) / rect.height) * 2 + 1\r\n      );\r\n      const raycaster = new THREE.Raycaster();\r\n      raycaster.setFromCamera(mouse, cameraRef.current);\r\n      const intersects = raycaster.intersectObjects(hotspotSpritesRef.current || [], true);\r\n      if (intersects.length > 0) {\r\n        const obj = intersects[0].object;\r\n        const now = Date.now();\r\n        if (obj.userData.isAccessHotspot) {\r\n          if (now - lastClickTime < 400) { // doble click\r\n            doubleClickNavigateToAccessHotspot(obj.userData.hotspot);\r\n          }\r\n          lastClickTime = now;\r\n        } else if (obj.userData.hotspot) {\r\n          setSelectedHotspot(obj.userData.hotspot);\r\n        }\r\n      }\r\n    }\r\n    dom.addEventListener('pointerdown', onPointerDown);\r\n    return () => {\r\n      dom.removeEventListener('pointerdown', onPointerDown);\r\n    };\r\n  }, [tour, currentSceneIndex]);\r\n\r\n  // Animación de transición\r\n  function startTransition(targetIdx) {\r\n    if (fade) return; // Evitar doble trigger\r\n    setFade(true);\r\n    setPendingSceneIndex(targetIdx);\r\n    // Animar FOV (zoom in)\r\n    const camera = cameraRef.current;\r\n    if (!camera) return;\r\n    let startFov = camera.fov;\r\n    let endFov = 35;\r\n    let duration = 350;\r\n    let start = null;\r\n    function animateZoomIn(ts) {\r\n      if (!start) start = ts;\r\n      let progress = Math.min((ts - start) / duration, 1);\r\n      camera.fov = startFov + (endFov - startFov) * progress;\r\n      camera.updateProjectionMatrix();\r\n      if (progress < 1) {\r\n        requestAnimationFrame(animateZoomIn);\r\n      } else {\r\n        // Esperar un poco y luego cambiar escena\r\n        setTimeout(() => {\r\n          setCurrentSceneIndex(targetIdx);\r\n        }, 200);\r\n      }\r\n    }\r\n    requestAnimationFrame(animateZoomIn);\r\n  }\r\n\r\n  // Animar transición cruzada\r\n  useEffect(() => {\r\n    if (!transitioning) return;\r\n    let frame;\r\n    function animate() {\r\n      setTransitionProgress(prev => {\r\n        const next = Math.min(prev + 0.04, 1);\r\n        if (next < 1) {\r\n          frame = requestAnimationFrame(animate);\r\n        } else {\r\n          setTransitioning(false);\r\n          setPrevTexture(null);\r\n          setCurrentSceneIndex(pendingSceneIndex);\r\n        }\r\n        return next;\r\n      });\r\n    }\r\n    animate();\r\n    return () => cancelAnimationFrame(frame);\r\n  }, [transitioning]);\r\n\r\n  // Modificar render de la escena para usar el shader durante la transición\r\n  useEffect(() => {\r\n    if (!sceneRef.current || !rendererRef.current || !cameraRef.current) return;\r\n    if (!transitioning || !prevTexture) return;\r\n    // Crear geometría y materiales\r\n    const geometry = new THREE.SphereGeometry(500, 128, 96);\r\n    geometry.scale(-1, 1, 1);\r\n    const currentScene = tour.scenes[pendingSceneIndex];\r\n    const loader = new THREE.TextureLoader();\r\n    loader.load(getAbsoluteImageUrl(currentScene.image), nextTexture => {\r\n      // Material de transición\r\n      const material = RadialFadeMaterial(prevTexture, nextTexture, transitionProgress);\r\n      const sphere = new THREE.Mesh(geometry, material);\r\n      sceneRef.current.add(sphere);\r\n      // Render loop\r\n      function renderTransition() {\r\n        material.uniforms.uProgress.value = transitionProgress;\r\n        rendererRef.current.render(sceneRef.current, cameraRef.current);\r\n        if (transitioning) requestAnimationFrame(renderTransition);\r\n        else sceneRef.current.remove(sphere);\r\n      }\r\n      renderTransition();\r\n    });\r\n  }, [transitioning, transitionProgress]);\r\n\r\n  // Cuando cambia la escena, hacer fade out y zoom out\r\n  useEffect(() => {\r\n    if (pendingSceneIndex === null) return;\r\n    // Animar FOV (zoom out) y quitar fade\r\n    const camera = cameraRef.current;\r\n    if (!camera) return;\r\n    let startFov = camera.fov;\r\n    let endFov = 75;\r\n    let duration = 400;\r\n    let start = null;\r\n    function animateZoomOut(ts) {\r\n      if (!start) start = ts;\r\n      let progress = Math.min((ts - start) / duration, 1);\r\n      camera.fov = startFov + (endFov - startFov) * progress;\r\n      camera.updateProjectionMatrix();\r\n      if (progress < 1) {\r\n        requestAnimationFrame(animateZoomOut);\r\n      } else {\r\n        setFade(false);\r\n        setPendingSceneIndex(null);\r\n      }\r\n    }\r\n    setTimeout(() => {\r\n      requestAnimationFrame(animateZoomOut);\r\n    }, 250);\r\n  }, [currentSceneIndex]);\r\n\r\n  // Manejar subida de imágenes\r\n  const handleImageUpload = async (e) => {\r\n    let files = [];\r\n    if (e.target && e.target.files && e.target.files.length > 0) {\r\n      files = Array.from(e.target.files);\r\n    } else if (e instanceof File) {\r\n      files = [e];\r\n    } else if (Array.isArray(e)) {\r\n      files = e;\r\n    }\r\n    if (!files.length) return;\r\n    for (const file of files) {\r\n      try {\r\n        let uploadRes = await api.uploadImage(file);\r\n        let imageUrl = uploadRes.data?.imageUrl || uploadRes.imageUrl;\r\n        if (!imageUrl) {\r\n          throw new Error('No se recibió la URL de la imagen');\r\n        }\r\n        const newScene = {\r\n          name: `Escena ${tour.scenes.length + 1}`,\r\n          image: imageUrl,\r\n          hotspots: []\r\n        };\r\n        const updatedTour = {\r\n          ...tour,\r\n          scenes: [...tour.scenes, newScene]\r\n        };\r\n        const savedTour = await api.updateTour(tourId, updatedTour);\r\n        setTour(savedTour.data ? savedTour.data : savedTour);\r\n        setCurrentSceneIndex(updatedTour.scenes.length - 1);\r\n      } catch (err) {\r\n        console.error('Error subiendo imagen:', err);\r\n        alert(`Error al subir imagen: ${err.error || err.message || 'Intente nuevamente'}`);\r\n      }\r\n    }\r\n  };\r\n\r\n  // Manejar subida de imágenes (DragDrop)\r\n  const handleDragDropImage = async (files) => {\r\n    if (Array.isArray(files)) {\r\n      for (const file of files) {\r\n        await handleImageUpload(file);\r\n      }\r\n    } else {\r\n      await handleImageUpload(files);\r\n    }\r\n  };\r\n\r\n  // Guardar hotspot\r\n  const handleSaveHotspot = async (hotspotData) => {\r\n    try {\r\n      const updatedScenes = [...tour.scenes];\r\n      const currentScene = updatedScenes[currentSceneIndex];\r\n\r\n      if (hotspotData._id) {\r\n        const index = currentScene.hotspots.findIndex(h => h._id === hotspotData._id);\r\n        if (index !== -1) {\r\n          currentScene.hotspots[index] = hotspotData;\r\n        }\r\n      } else {\r\n        currentScene.hotspots.push({\r\n          ...hotspotData,\r\n          _id: Date.now().toString()\r\n        });\r\n      }\r\n\r\n      const updatedTour = { ...tour, scenes: updatedScenes };\r\n      setTour(updatedTour);\r\n      await api.updateTour(tourId, updatedTour);\r\n      // Recarga el tour desde la API para asegurar sincronización\r\n      const response = await api.getTour(tourId);\r\n      setTour(response.data ? response.data : response);\r\n      setSelectedHotspot(null);\r\n      setPlacementMode(false);\r\n    } catch (err) {\r\n      console.error('Error guardando hotspot:', err);\r\n      alert(`Error al guardar: ${err.error || 'Intente nuevamente'}`);\r\n    }\r\n  };\r\n\r\n  // Efecto unificado para manejar el modo de colocación de hotspots\r\n  useEffect(() => {\r\n    if (!rendererRef.current || !sceneRef.current || !cameraRef.current) return;\r\n    \r\n    const dom = rendererRef.current.domElement;\r\n    \r\n    if (placementMode) {\r\n      dom.style.cursor = 'crosshair';\r\n      \r\n      // Agregar un overlay visual para indicar el modo de colocación\r\n      const overlay = document.createElement('div');\r\n      overlay.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 0;\r\n        right: 0;\r\n        bottom: 0;\r\n        background: rgba(56, 189, 248, 0.1);\r\n        pointer-events: none;\r\n        z-index: 5;\r\n        border: 2px dashed #38bdf8;\r\n        border-radius: 8px;\r\n        margin: 10px;\r\n      `;\r\n      overlay.id = 'placement-overlay';\r\n      dom.parentElement.appendChild(overlay);\r\n\r\n      // Manejar click en la esfera para añadir hotspot\r\n      const handlePointerDown = (event) => {\r\n        // Solo permitir click izquierdo\r\n        if (event.button !== 0) return;\r\n\r\n        // Evitar que el panel de control capture el click\r\n        if (event.target !== rendererRef.current.domElement) return;\r\n\r\n        // Obtener posición del click relativo al canvas\r\n        const rect = rendererRef.current.domElement.getBoundingClientRect();\r\n        const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;\r\n        const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\r\n\r\n        // Vector 3D en la dirección de la cámara\r\n        const vector = new THREE.Vector3(x, y, 0.5).unproject(cameraRef.current);\r\n\r\n        // Convertir a coordenadas esféricas (pitch/yaw)\r\n        const camPos = cameraRef.current.position;\r\n        const dir = vector.sub(camPos).normalize();\r\n        const phi = Math.acos(dir.y); // [0, PI]\r\n        const theta = Math.atan2(dir.x, dir.z); // [-PI, PI]\r\n\r\n        // Convertir a grados\r\n        const pitch = 90 - (phi * 180 / Math.PI);\r\n        const yaw = theta * 180 / Math.PI;\r\n\r\n        setPendingHotspot({\r\n          pitch: Number(pitch.toFixed(2)),\r\n          yaw: Number(yaw.toFixed(2))\r\n        });\r\n        setPlacementMode(false);\r\n      };\r\n\r\n      dom.addEventListener('pointerdown', handlePointerDown);\r\n\r\n      return () => {\r\n        dom.style.cursor = '';\r\n        dom.removeEventListener('pointerdown', handlePointerDown);\r\n        const overlay = document.getElementById('placement-overlay');\r\n        if (overlay) {\r\n          overlay.remove();\r\n        }\r\n      };\r\n    } else {\r\n      dom.style.cursor = '';\r\n      const overlay = document.getElementById('placement-overlay');\r\n      if (overlay) {\r\n        overlay.remove();\r\n      }\r\n    }\r\n  }, [placementMode, rendererRef, sceneRef, cameraRef]);\r\n\r\n  // Nuevo: Guardar hotspot con pitch/yaw del click\r\n  const handleSaveHotspotWithCoords = (hotspotData) => {\r\n    handleSaveHotspot({\r\n      ...hotspotData,\r\n      pitch: pendingHotspot?.pitch ?? hotspotData.pitch,\r\n      yaw: pendingHotspot?.yaw ?? hotspotData.yaw\r\n    });\r\n    setPendingHotspot(null);\r\n  };\r\n\r\n  // Nuevo: Manejar click en la escena para colocar hotspot\r\n  const handleSceneClick = (event) => {\r\n    if (!placementMode) return;\r\n    // Obtener coordenadas del ratón normalizadas\r\n    const mouse = new THREE.Vector2();\r\n    const rect = containerRef.current.getBoundingClientRect();\r\n    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;\r\n    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;\r\n\r\n    const raycaster = new THREE.Raycaster();\r\n    raycaster.setFromCamera(mouse, cameraRef.current);\r\n\r\n    // Intersectar con la esfera (único mesh en la escena)\r\n    const intersects = raycaster.intersectObjects(sceneRef.current.children);\r\n    if (intersects.length > 0) {\r\n      const point = intersects[0].point;\r\n      const radius = 500;\r\n      const phi = Math.acos(point.y / radius);\r\n      const theta = Math.atan2(point.x, point.z); // x primero, z segundo\r\n      const pitch = 90 - THREE.MathUtils.radToDeg(phi);\r\n      const yaw = THREE.MathUtils.radToDeg(theta);\r\n      setNewHotspotPosition({ pitch, yaw });\r\n      setShowHotspotModal(true);\r\n      setPlacementMode(false);\r\n    }\r\n  };\r\n\r\n  // Guardar el nuevo hotspot usando el endpoint REST\r\n  const saveNewHotspot = async (hotspotData) => {\r\n    try {\r\n      if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) return;\r\n      const sceneId = tour.scenes[currentSceneIndex]._id;\r\n      const response = await api.addHotspot(tour._id, sceneId, hotspotData);\r\n      // Solo guardar el objeto de datos, no la respuesta completa\r\n      const newHotspot = response.data ? response.data : response;\r\n      const updatedTour = { ...tour };\r\n      updatedTour.scenes = [...updatedTour.scenes];\r\n      const scene = updatedTour.scenes[currentSceneIndex];\r\n      scene.hotspots = [...scene.hotspots, newHotspot];\r\n      setTour(updatedTour);\r\n      setShowHotspotModal(false);\r\n      setNewHotspotPosition(null);\r\n      // Recarga el tour desde la API para asegurar sincronización\r\n      const refreshed = await api.getTour(tourId);\r\n      setTour(refreshed.data ? refreshed.data : refreshed);\r\n    } catch (error) {\r\n      alert('Error al guardar el hotspot');\r\n      setShowHotspotModal(false);\r\n      setNewHotspotPosition(null);\r\n    }\r\n  };\r\n\r\n  // Reemplaza la función handleDeleteScene global para aceptar el índice de la escena a eliminar\r\n  useEffect(() => {\r\n    window.handleDeleteScene = async (deleteIdx) => {\r\n      if (!tour || !tour.scenes || tour.scenes.length <= 1) return;\r\n      const updatedScenes = tour.scenes.filter((_, idx) => idx !== deleteIdx);\r\n      let newIndex = currentSceneIndex;\r\n      if (deleteIdx === currentSceneIndex) {\r\n        newIndex = deleteIdx === 0 ? 0 : deleteIdx - 1;\r\n      } else if (deleteIdx < currentSceneIndex) {\r\n        newIndex = currentSceneIndex - 1;\r\n      }\r\n      const updatedTour = { ...tour, scenes: updatedScenes };\r\n      setTour(updatedTour);\r\n      setCurrentSceneIndex(newIndex);\r\n      await api.updateTour(tour._id, updatedTour);\r\n    };\r\n    return () => { window.handleDeleteScene = undefined; };\r\n  }, [tour, currentSceneIndex]);\r\n\r\n  // 1. Función para eliminar hotspot de la escena actual\r\n  const handleDeleteHotspot = async (hotspotIdx) => {\r\n    if (!tour || !tour.scenes || !tour.scenes[currentSceneIndex]) return;\r\n    const updatedScenes = [...tour.scenes];\r\n    const scene = { ...updatedScenes[currentSceneIndex] };\r\n    scene.hotspots = scene.hotspots.filter((_, idx) => idx !== hotspotIdx);\r\n    updatedScenes[currentSceneIndex] = scene;\r\n    const updatedTour = { ...tour, scenes: updatedScenes };\r\n    setTour(updatedTour);\r\n    await api.updateTour(tour._id, updatedTour);\r\n  };\r\n\r\n  // --- GIROSCOPIO: Lógica de activación y manejo estilo YouTube 360 ---\r\n  useEffect(() => {\r\n    if (!isMobileDevice() || !cameraRef.current || !controlsRef.current) return;\r\n\r\n    // Habilitar/deshabilitar OrbitControls según el estado del giroscopio\r\n    controlsRef.current.enabled = true;\r\n\r\n    let lastAlpha = 0, lastBeta = 0, lastGamma = 0;\r\n    let smoothAlpha = 0, smoothBeta = 0, smoothGamma = 0;\r\n    const smoothFactor = 0.15;\r\n\r\n    function getScreenOrientation() {\r\n      if (window.screen.orientation && window.screen.orientation.angle !== undefined) {\r\n        return window.screen.orientation.angle;\r\n      }\r\n      return window.orientation || 0;\r\n    }\r\n\r\n    function handleOrientation(event) {\r\n      let alpha = event.alpha || 0;\r\n      let beta = event.beta || 0;\r\n      let gamma = event.gamma || 0;\r\n\r\n      // INVERTIR alpha para invertir la rotación horizontal\r\n      alpha = -alpha;\r\n\r\n      smoothAlpha = smoothAlpha * (1 - smoothFactor) + alpha * smoothFactor;\r\n      smoothBeta = smoothBeta * (1 - smoothFactor) + beta * smoothFactor;\r\n      smoothGamma = smoothGamma * (1 - smoothFactor) + gamma * smoothFactor;\r\n\r\n      const _alpha = THREE.MathUtils.degToRad(smoothAlpha);\r\n      const _beta = THREE.MathUtils.degToRad(smoothBeta);\r\n      const _gamma = THREE.MathUtils.degToRad(smoothGamma);\r\n\r\n      const orient = getScreenOrientation();\r\n      const orientRad = THREE.MathUtils.degToRad(orient);\r\n\r\n      const zee = new THREE.Vector3(0, 0, 1);\r\n      const euler = new THREE.Euler();\r\n      const q0 = new THREE.Quaternion();\r\n      const q1 = new THREE.Quaternion(-Math.sqrt(0.5), 0, 0, Math.sqrt(0.5));\r\n\r\n      euler.set(_beta, _alpha, -_gamma, 'YXZ');\r\n      let quaternion = new THREE.Quaternion().setFromEuler(euler);\r\n      quaternion.multiply(q1);\r\n      quaternion.multiply(q0.setFromAxisAngle(zee, -orientRad));\r\n\r\n      cameraRef.current.quaternion.copy(quaternion);\r\n    }\r\n\r\n    window.addEventListener('deviceorientation', handleOrientation, true);\r\n\r\n    const handleScreenOrientation = () => {\r\n      smoothAlpha = lastAlpha;\r\n      smoothBeta = lastBeta;\r\n      smoothGamma = lastGamma;\r\n    };\r\n    window.addEventListener('orientationchange', handleScreenOrientation);\r\n\r\n    return () => {\r\n      window.removeEventListener('deviceorientation', handleOrientation, true);\r\n      window.removeEventListener('orientationchange', handleScreenOrientation);\r\n      // Rehabilitar OrbitControls al salir del modo giroscopio\r\n      if (controlsRef.current) controlsRef.current.enabled = true;\r\n    };\r\n  }, []);\r\n\r\n  if (loading) {\r\n    return <div className=\"loading\">Cargando tour...</div>;\r\n  }\r\n\r\n  if (error) {\r\n    return <div className=\"error\">{error}</div>;\r\n  }\r\n\r\n  // Si no hay escenas, muestra mensaje amigable y área de drag & drop\r\n  if (!tour.scenes || tour.scenes.length === 0) {\r\n    return (\r\n      <div className=\"tour-editor\">\r\n        <div ref={containerRef} className=\"three-container\" />\r\n        <ControlPanel\r\n          open={panelOpen}\r\n          setOpen={setPanelOpen}\r\n          tour={tour}\r\n          handleDragDropImage={handleDragDropImage}\r\n          handleImageUpload={handleImageUpload}\r\n          scenes={[]}\r\n          placementMode={placementMode}\r\n          setPlacementMode={setPlacementMode}\r\n          onReturn={() => navigate('/hub')}\r\n          handleDeleteHotspot={handleDeleteHotspot}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"tour-editor\">\r\n      <div\r\n        ref={containerRef}\r\n        className=\"three-container\"\r\n        onClick={handleSceneClick}\r\n      />\r\n      <div className={`fade-overlay${fade ? ' visible' : ''}`}></div>\r\n      <ControlPanel\r\n        open={panelOpen}\r\n        setOpen={setPanelOpen}\r\n        tour={tour}\r\n        handleDragDropImage={handleDragDropImage}\r\n        handleImageUpload={handleImageUpload}\r\n        scenes={tour.scenes}\r\n        currentSceneIndex={currentSceneIndex}\r\n        setCurrentSceneIndex={setCurrentSceneIndex}\r\n        placementMode={placementMode}\r\n        setPlacementMode={setPlacementMode}\r\n        onReturn={() => navigate('/hub')}\r\n        handleDeleteHotspot={handleDeleteHotspot}\r\n      />\r\n      {(selectedHotspot || pendingHotspot) && (\r\n        <HotspotEditor\r\n          hotspot={selectedHotspot || { pitch: pendingHotspot?.pitch, yaw: pendingHotspot?.yaw }}\r\n          scenes={tour.scenes}\r\n          onSave={pendingHotspot ? handleSaveHotspotWithCoords : handleSaveHotspot}\r\n          onCancel={() => {\r\n            setSelectedHotspot(null);\r\n            setPlacementMode(false);\r\n            setPendingHotspot(null);\r\n          }}\r\n        />\r\n      )}\r\n      {showHotspotModal && newHotspotPosition && (\r\n        <HotspotCreationModal\r\n          position={newHotspotPosition}\r\n          tour={tour}\r\n          currentSceneIndex={currentSceneIndex}\r\n          onSave={saveNewHotspot}\r\n          onCancel={() => {\r\n            setShowHotspotModal(false);\r\n            setNewHotspotPosition(null);\r\n          }}\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// Panel lateral plegable\r\nfunction ControlPanel({\r\n  open,\r\n  setOpen,\r\n  tour,\r\n  handleDragDropImage,\r\n  handleImageUpload,\r\n  scenes,\r\n  currentSceneIndex,\r\n  setCurrentSceneIndex,\r\n  placementMode,\r\n  setPlacementMode,\r\n  onReturn,\r\n  handleDeleteHotspot\r\n}) {\r\n  return (\r\n    <>\r\n      <aside className={`editor-panel${open ? ' open' : ''}`}>\r\n        <div className=\"panel-header\">\r\n          <span className=\"panel-title\">Tour Virtual 360°</span>\r\n          <button className=\"panel-toggle\" onClick={() => setOpen(!open)}>\r\n            {open ? <>&#10094;</> : <>&#10095;</>}\r\n          </button>\r\n        </div>\r\n        {open && (\r\n          <div className=\"panel-content\">\r\n            <button\r\n              className=\"btn-return-hub\"\r\n              onClick={onReturn}\r\n              style={{\r\n                background: '#23272f',\r\n                color: '#38bdf8',\r\n                border: 'none',\r\n                borderRadius: 8,\r\n                padding: '10px 0',\r\n                fontSize: '1rem',\r\n                fontWeight: 500,\r\n                marginBottom: 18,\r\n                cursor: 'pointer',\r\n                width: '100%',\r\n                transition: 'background 0.2s, color 0.2s'\r\n              }}\r\n            >\r\n              ← Volver al Hub\r\n            </button>\r\n            <ApiKeyManager tourId={tour._id} initialApiKey={tour.apiKey} />\r\n            <div className=\"panel-section\">\r\n              <h3>Imágenes 360°</h3>\r\n              <DragDrop onFileUpload={handleDragDropImage} />\r\n              <div className=\"panel-dragdrop-hint\">o haz clic para seleccionar</div>\r\n              <input\r\n                type=\"file\"\r\n                id=\"image-upload\"\r\n                accept=\"image/*\"\r\n                onChange={handleImageUpload}\r\n                style={{ display: 'none' }}\r\n              />\r\n            </div>\r\n            <div className=\"panel-section\">\r\n              <h3>Imágenes Cargadas ({scenes.length})</h3>\r\n              {scenes.length === 0 ? (\r\n                <div className=\"panel-empty\">No hay imágenes cargadas</div>\r\n              ) : (\r\n                <ul className=\"panel-image-list\">\r\n                  {scenes.map((scene, idx) => (\r\n                    <li\r\n                      key={scene._id || idx}\r\n                      className={`panel-image-item${currentSceneIndex === idx ? ' active' : ''}`}\r\n                      style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}\r\n                    >\r\n                      <div style={{ display: 'flex', alignItems: 'center', flex: 1, cursor: 'pointer' }} onClick={() => setCurrentSceneIndex && setCurrentSceneIndex(idx)}>\r\n                        <img src={scene.image ? getAbsoluteImageUrl(scene.image) : ''} alt={scene.name} />\r\n                        <span>{scene.name}</span>\r\n                      </div>\r\n                      {scenes.length > 1 && (\r\n                        <button\r\n                          className=\"btn-delete-scene\"\r\n                          style={{ background: 'transparent', color: '#ef4444', border: 'none', marginLeft: 8, fontSize: 20, cursor: 'pointer' }}\r\n                          title=\"Eliminar escena\"\r\n                          onClick={e => {\r\n                            e.stopPropagation();\r\n                            if (window.confirm('¿Seguro que deseas eliminar esta escena?')) {\r\n                              if (typeof window.handleDeleteScene === 'function') window.handleDeleteScene(idx);\r\n                            }\r\n                          }}\r\n                        >\r\n                          🗑️\r\n                        </button>\r\n                      )}\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              )}\r\n            </div>\r\n            <div className=\"panel-section\">\r\n              <h3>Hotspots de la Escena ({scenes[currentSceneIndex]?.hotspots?.length || 0})</h3>\r\n              <div className=\"hotspot-controls\" style={{marginBottom: 15}}>\r\n                <button\r\n                  className=\"btn-add-hotspot\"\r\n                  onClick={() => setPlacementMode(true)}\r\n                  title=\"Haz clic para activar el modo de colocación de hotspots. Luego haz clic en la imagen 360° donde quieras colocar el hotspot.\"\r\n                  style={{\r\n                    background: '#38bdf8',\r\n                    color: '#fff',\r\n                    border: 'none',\r\n                    borderRadius: 8,\r\n                    padding: '10px 16px',\r\n                    fontSize: '14px',\r\n                    fontWeight: 500,\r\n                    cursor: 'pointer',\r\n                    width: '100%',\r\n                    transition: 'background 0.2s',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center',\r\n                    gap: 8,\r\n                    position: 'relative'\r\n                  }}\r\n                  onMouseEnter={(e) => e.target.style.background = '#0ea5e9'}\r\n                  onMouseLeave={(e) => e.target.style.background = '#38bdf8'}\r\n                >\r\n                  <span style={{fontSize: '16px'}}>📍</span>\r\n                  Agregar Hotspot\r\n                </button>\r\n                {placementMode && (\r\n                  <div className=\"placement-mode-indicator\">\r\n                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8}}>\r\n                      <strong>Modo de colocación activado</strong>\r\n                      <button\r\n                        onClick={() => setPlacementMode(false)}\r\n                        style={{\r\n                          background: 'transparent',\r\n                          border: '1px solid #ef4444',\r\n                          color: '#ef4444',\r\n                          borderRadius: 4,\r\n                          padding: '4px 8px',\r\n                          fontSize: '11px',\r\n                          cursor: 'pointer',\r\n                          transition: 'all 0.2s'\r\n                        }}\r\n                        onMouseEnter={(e) => {\r\n                          e.target.style.background = '#ef4444';\r\n                          e.target.style.color = '#fff';\r\n                        }}\r\n                        onMouseLeave={(e) => {\r\n                          e.target.style.background = 'transparent';\r\n                          e.target.style.color = '#ef4444';\r\n                        }}\r\n                      >\r\n                        Cancelar\r\n                      </button>\r\n                    </div>\r\n                    Haz clic en la imagen 360° para colocar el hotspot\r\n                  </div>\r\n                )}\r\n              </div>\r\n              {scenes[currentSceneIndex]?.hotspots?.length === 0 ? (\r\n                <div style={{\r\n                  background: '#1e293b',\r\n                  border: '1px dashed #334155',\r\n                  borderRadius: 6,\r\n                  padding: '20px',\r\n                  textAlign: 'center',\r\n                  color: '#64748b',\r\n                  fontSize: '14px'\r\n                }}>\r\n                  <div style={{fontSize: '24px', marginBottom: '8px'}}>📍</div>\r\n                  No hay hotspots en esta escena\r\n                  <div style={{fontSize: '12px', marginTop: '4px'}}>\r\n                    Haz clic en \"Agregar Hotspot\" para comenzar\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <>\r\n                  {/* Resumen de tipos de hotspots */}\r\n                  <div style={{\r\n                    background: '#1e293b',\r\n                    border: '1px solid #334155',\r\n                    borderRadius: 6,\r\n                    padding: '8px 12px',\r\n                    marginBottom: '12px',\r\n                    fontSize: '12px',\r\n                    color: '#94a3b8'\r\n                  }}>\r\n                    {(() => {\r\n                      const hotspots = scenes[currentSceneIndex].hotspots;\r\n                      const types = {\r\n                        access: hotspots.filter(h => h.type === 'access').length,\r\n                        commerce: hotspots.filter(h => h.type === 'commerce').length,\r\n                        location: hotspots.filter(h => h.type === 'location').length\r\n                      };\r\n                      return (\r\n                        <div style={{display: 'flex', justifyContent: 'space-between'}}>\r\n                          <span>📍 Acceso: {types.access}</span>\r\n                          <span>🏪 Comercio: {types.commerce}</span>\r\n                          <span>📍 Locación: {types.location}</span>\r\n                        </div>\r\n                      );\r\n                    })()}\r\n                  </div>\r\n                  <ul className=\"panel-hotspot-list\">\r\n                    {scenes[currentSceneIndex].hotspots.map((hotspot, idx) => {\r\n                      let accessInfo = null;\r\n                      if (hotspot.type === 'access' && hotspot.targetSceneId) {\r\n                        const target = scenes.find(s => String(s._id) === String(hotspot.targetSceneId));\r\n                        accessInfo = target ? `→ ${target.name}` : '→ [Escena no encontrada]';\r\n                      }\r\n                      return (\r\n                        <li key={hotspot._id || idx} style={{display:'flex',alignItems:'center',justifyContent:'space-between',gap:8}}>\r\n                          <span>\r\n                            {hotspot.type === 'access' ? 'Punto de Acceso' : (hotspot.title || 'Hotspot')}\r\n                            {accessInfo && <span style={{color:'#38bdf8',marginLeft:8,fontSize:13}}>{accessInfo}</span>}\r\n                          </span>\r\n                          <button style={{background:'transparent',color:'#ef4444',border:'none',fontSize:18,cursor:'pointer'}} title=\"Eliminar hotspot\" onClick={()=>{if(window.confirm('¿Eliminar este hotspot?'))handleDeleteHotspot(idx)}}>🗑️</button>\r\n                        </li>\r\n                      );\r\n                    })}\r\n                  </ul>\r\n                </>\r\n              )}\r\n            </div>\r\n            <div className=\"panel-section panel-hint\">\r\n              <p><strong>Tipos de Hotspots:</strong></p>\r\n              <ul style={{margin: '8px 0', paddingLeft: '20px', fontSize: '13px'}}>\r\n                <li><strong>📍 Acceso:</strong> Navega a otra escena del tour</li>\r\n                <li><strong>🏪 Comercio:</strong> Muestra información de un negocio</li>\r\n                <li><strong>📍 Locación:</strong> Muestra información de un lugar</li>\r\n              </ul>\r\n              <p style={{marginTop: '12px', fontSize: '13px'}}>\r\n                <strong>Controles:</strong><br/>\r\n                • Haz doble clic en hotspots de acceso para navegar<br/>\r\n                • Haz clic en hotspots para ver/editar información\r\n              </p>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </aside>\r\n      <div className={`editor-backdrop${open ? ' open' : ''}`} onClick={() => setOpen(false)} />\r\n    </>\r\n  );\r\n}\r\n\r\nexport default TourEditor;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}